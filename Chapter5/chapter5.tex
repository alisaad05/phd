\chapter{Macrosegregation with shrinking metal volume}
%\chaptermark{Nonlinear Temperature Solver}
\begin{nolinkcolors}
\minitoc
\end{nolinkcolors}
\newpage

% ======================
\section{Solidification shrinkage}
% ======================

Solidification shrinkage is, by definition, the effect of relative density change between the liquid and solid phases.
In general, it results in a progressive volume change during solidification, until the phase change has finished. 
The four stages in \cref{fig:real_ingot_stage_a,fig:real_ingot_stage_c,fig:real_ingot_stage_b,fig:real_ingot_stage_d} depict the volume change with 
respect to solidification time.
First, at the level of the first solid crust, near the local solidus temperature, the solid forms with a density greater than 
the liquid. The subsequent volume decrease forces the fluid to be sucked in the direction of the volume change 
(cf. \cref{fig:real_ingot_stage_b}). 
When this sucking becomes impossible due to a low permeability of the mush, voids may appear.
As a direct result of the inward feeding flow, the ingot free surface with the air
tends to gradually deform to follow the feeding direction, forming the so-called \emph{shrinkage pipe}, shown in \cref{fig:shrinkage_exp}. 
Since the mass of the alloy and its chemical species is conserved, 
a density difference between the phases ($\rhol < \rhos \implies \frac{\rhol}{\rhos}<1$) eventually leads 
to a different overall volume ($V^s<V^l$) once solidification is complete, as confirm the following mass conservation equations, 
from initial (LHS term) to final (RHS term) state:
%------------
\begin{subequations}
\begin{align}
& \rhol V^l = \rhos V^s  \\ 
& V^s = \frac{\rhol}{\rhos} V^l
\end{align}
\end{subequations}
%------------
Solidification shrinkage is not the only factor responsible for volume decrease. 
Shrinkage due to temperature and composition variations in both solid and liquid phases, are also common causes in a casting process. 
Thermal shrinkage is very important to apprehend in steel casting, as the temperature decrease usually exceeds a \SI{1000}{\udegC} between the solidus and ambient temperature.
This causes substantial density variations. 
%Henceforth, we will focus on shrinkage due to phase change.
%
%Talk and explain models in the literature that predict shrinkage (without or with macrosegregation): Beckermann, Wu ? \\
%Show and comment the experiments that have been done: Hebditch and Hunt, Smacs Hachani  ...
%
%\comment{ \textbf{Sutaria2012} talk about feeding paths, but more importantly they computed thermal shrinkage WITHOUT solving
%NavierStokes equations. To predict the interface shape, they solve a LS transport with an imposed velocity given by Gada et Sharma 2009}
%
%
%----------------
%
\begin{figure}[htbp]
\centering
%\begin{minipage}{.5\textwidth}
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \def\svgwidth{80pt}
	\import{Chapter5/Graphics/new/}{ingot_air_liq.pdf_tex}
	\caption{Initial state}
    \label{fig:real_ingot_stage_a}
  \end{subfigure}
  %\hfill
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \def\svgwidth{80pt}
	\import{Chapter5/Graphics/new/}{ingot_air_liq_mush_sol.pdf_tex} 
	\caption{Early intermediate state}
    \label{fig:real_ingot_stage_b}
  \end{subfigure}
%
\vskip\baselineskip
%======
%
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \def\svgwidth{80pt}
	\import{Chapter5/Graphics/new/}{ingot_air_mush_sol.pdf_tex}
	\caption{Late intermediate state}
    \label{fig:real_ingot_stage_c}
  \end{subfigure}
  %\hfill
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \def\svgwidth{80pt}
	\import{Chapter5/Graphics/new/}{ingot_air_sol.pdf_tex}
	\caption{Final state}
    \label{fig:real_ingot_stage_d}
  \end{subfigure}
  %
\caption{Schematic of the main cooling stages of an ingot against side and bottom mould walls (not shown)}
\label{fig:real_ingot_stages}
\end{figure}
%
%---------------------
%
%----------------------
\begin{figureth}
% textwidth 
{0.45}
%path 
{Chapter5/Graphics/shrink_exp/shrinkage_exp.png}
% caption
{Sulphur prints of three low-carbon steel ingots showing pipe formation at the top as a result 
of solidification shrinkage, marked with dark areas corresponding to higher sulphur content, while varying ingot inclination during casting.
Ingot orientation changes from (a) vertical position to (b) \SI{25}{\degree}-inclination after 34 minutes of vertical (dashed line) casting and finally (c) \SI{25}{\degree}-inclination after 3 hours of vertical casting. The white arrow indicates the inclination onset \citep{onodera_effect_1959}. The black arrow indicates the gravity direction.}
% Positive macrosegregation is clearly seen in this area, while A-shape and V-shape positive mesosegregates are detected
% at the ingot's tips and centre respectively.
% label
\label{fig:shrinkage_exp}
\end{figureth}
%-----------------------------------
%
%
%============================================
\section{Choice of boundary tracking}
%============================================
In chapter 2, several methods of boundary tracking/capturing methods were presented 
along with their similarities and differences. In the case of solidification shrinkage,
the metal-air boundary can be tracked with any method from the previously mentioned.
However, several reasons motivate us to settle on the level set method. 
First, the easiest solution is testing a method which already exists in the \cimlib library.
The level set method was implemented as a framework for monolithic resolution. Since this work,
the method has been extensively used and improved in several projects mainly for multiphase flows, which is the 
main competence of the Computing and FLuids group at CEMEF. Another motivation is the compatibility
between \cimlib and \thercast, where the latter is the final destination of the code developed during this Ph.D. thesis.
In its recent versions, \thercast handles laminar and turbulent ingot filling where the level set method is used 
to capture the free surface of the molten metal. Aside from the practical motivations, some technical aspects of the level
set method make it very attractive to address macroscopic surface tracking 
(in contrast to microscopic interface tracking, for instance the solid-liquid interface), 
such as topological properties that are readily available (e.g. curvature)
and accurate position compared to volume-based methods like VOF \citep{sethian_level_1999}.
%
%============================================
\section{Multidomain formalism}
%============================================
In the previous chapters, we considered in our simulations the metallic alloy as a 
saturated mixture of solid and liquid during solidification.
It means that no gas phase was supposed to appear during the process.
Additionally, we ignored shrinkage and expansion effects. These considerations
resulted in a fixed interface between the free surface of the liquid metal and the surrounding air.
As a consequence, air was not considered in the model.
The reason is that we chose to describe our model in Eulerian description, 
for which we have considered a fixed grid to discretise the averaged conservation 
equations governing the phase change between the liquid and solid phases.
With the introduction of shrinkage, an increase in global density of the metallic alloy means 
that a gas phase should enter the domain to replace the shrunk volume.

At this point, several interfaces may be distinguished: liquid-solid ($l$-$s$), liquid-air ($l$-$a$) and solid-air ($s$-$a$), where 
we defined 2 phases ($l$ and $s$) belonging to the "Metal" domain denoted $M$, while the "Air" domain, denoted $A$, 
is made up of a unique gas phase, ($a$), with the same name. As a standard for this formalism, we consider that upper case letters
are used for domains, while lower case letters are used for phases.

The main idea behind the multidomain formalism is to go from the classic 
conservations equations introduced by volume averaging in chapter 2
in the context of a solidifying two-phase system to generalise it by taking
into account a third gas phase, such as:
%-------------
\begin{align}
\label{eq:}
V^l + V^s + V^a = \rev \\
\gl + \gs + \ga = 1
\end{align} 
%-------------
where $\gphi$ is the volume fraction of each phase $\phi=[l,s,a]$.
Then, one is free to choose a suitable numerical method to define and track the 
physical interfaces between the several phases. In our macroscale applications, we are particularly 
interested in keeping an indirect representation of the $l$-$s$ interface (dotted line in \cref{fig:rev_triphase})
using the volume averaging theory, while employing a different
method to track the metal-air ($M$-$A$) boundary ($l$-$a$ and $s$-$a$ interfaces, represented by dashed lines in \cref{fig:rev_triphase}) with the level set method. 
This allows switching to the latter method in a physically representative manner.

In this context, each domain can be seen as a material having a physical
interface with the other domains. As a consequence of our interpretation, 
the gas phase should not exist in the metal, which may naturally
occur if the thermodynamic conditions are in favour of nucleating and growing 
a new phase, or in the case of a gas that was trapped inside mould grooves.
%----------------------
\begin{figureth}
% textwidth 
{0.45}
%path 
{Chapter5/Graphics/REV_triphase.pdf}
% caption
{Schematic of a representative volume element containing 3 phases with distinct velocities, separated by 3 interfaces.
The dotted line is the indirectly tracked solid-liquid interface while the other dashed lines, air-liquid and air-solid
interfaces, are directly tracked.}
% label
\label{fig:rev_triphase}
\end{figureth}
%-----------------------------------

\subsection{Assumptions}
%------------
Each phase in the system has its own velocity, $\vl$, $\vs$ and $\va$, while the respective
interfaces $\liqsol$, $\liqair$ and $\solair$ have different and independent velocities, 
represented by $\vliqsol$, $\vliqair$ and $\vsolair$. Note that the solid-liquid interface
velocity was denoted $\vstar$ in the previous chapters as no more than two phases were considered.

The first major assumption is that the solid phase, once formed from the liquid, is fixed and rigid, hence $\vs=\vec{0}$.
It means that no subsequent deformation or contraction/expansion of the solid phase ($\rhos=\text{constant}$) may occur and therefore $\vsolair$ reduces to vector zero.
Moreover, we use the already introduced volume averaging principles to write locally for any quantity $\psi$:
%------------
\begin{subequations}
\begin{align}
\label{eq:}
\avg{\psi} &= \avg{\psi^l} +  \avg{\psi^s} + \avg{\psi^a} \\
			&= \gl \psi^l + \gs \psi^s  + \ga \psi^a
\end{align}
\end{subequations}
%------------
where volume fractions, $\gphi$, for each phase $\phi$ were used. \citet{rappaz_numerical_2003} define
the volume fraction by writing a general expression inside the representative volume $\rev$:
%------------
%\begin{subequations}
\begin{align}
\label{eq:}
\gphi = \frac{1}{\rev} \integral{\rev}{\chi^\phi(x,t)}{\Ohm} = \avg{\chi^\phi}
\end{align}
%\end{subequations}
%------------
where the integrated quantity is an indicator (or presence) function relative to phase $\phi$, defined
in chapter 2 by \cref{eq:phase_indicator}.

Any phenomenon that may displace an interface, whether by phase change or a phase motion, is 
mathematically translated by variations of the presence function, such that its total derivative for each phase
satisfies the following:
%
%------------
\begin{align}
\label{eq:transport_presence}
& \frac{d \chi^\phi}{dt} = \tempup{\chi^\phi} + \vstar \cdot \nabvec \chi^\phi = 0
\end{align}
%------------
%
If we consider the liquid phase for instance, the variations of any quantity $\psi$ are given by:
%------------
\begin{align}
\label{eq:variations1}
& \avg{{\tempup{\psi^l}}} = \tempup{\avg{\psi^l}}
							- \frac{1}{\rev} \integral{\Gamma_{l-a}}{\psi^l \vliqair \cdot \nliqair}{A}
							- \frac{1}{\rev} \integral{\Gamma_{l-s}}{\psi^l \vliqsol \cdot \nliqsol}{A} \\
\label{eq:variations2}
& \avg{\nabvec \psi^l} =  \nabvec{\avg{\psi^l}} 
							+ \frac{1}{\rev} \integral{\Gamma_{l-a}}{\psi^l \nliqair}{A} 
							+\frac{1}{\rev} \integral{\Gamma_{l-s}}{\psi^l \nliqsol }{A} \\
\label{eq:variations3}
& \avg{\nabvec \cdot \vec{\psi}^l} =  \nabvec \cdot {\avg{\vec{\psi}^l}} 
							+ \frac{1}{\rev} \integral{\Gamma_{l-a}}{\vec{\psi^l} \cdot \nliqair }{A} 
							+\frac{1}{\rev} \integral{\Gamma_{l-s}}{\vec{\psi^l} \cdot  \nliqsol }{A}							
\end{align}
%------------

So far, we know that \cref{eq:transport_presence} allows transporting an interface between 2 phases, 
or a more generally a boundary between multiphase domains.
We also know that \cref{eq:variations1,eq:variations2,eq:variations3} allow computing temporal and spatial
variations of any physical quantity related to a phase or more generally a multiphase domain.
To avoid ambiguity, we still have to establish a definition for the boundary between the metal and the air, i.e. which 
interfaces should be accounted for when considering the transport of the metal-air boundary.



\subsection{Metal-Air boundary definition} \label{sec:M_A_definition}
%---------------------------------------------

% ---------------BEGINNING OF INSERTED TEXT ----------------------------------
In reality, between the metal and the air, two boundaries exist, as explained by \citet{niane_etude_2004}. 
% the liquid-air ($\liqair$) and solid-air ($\solair$) interfaces, 
% and these interfaces move at different velocities as solidification proceeds.
The liquid-air interface exists at early stages of solidification where only the free surface of the liquid is in contact with the air, as shows stage 1 in  \cref{fig:1dalsi7_interface_stages}.
% In this case, the metal-air boundary is defined by the $\liqair$ interface, where the latter is driven by solidification shrinkage, 
% and therefore by 

% In later stages (transition from stage 2 to stage 3 in \cref{fig:1dalsi7_interface_stages}), the mushy zone delimited by dendrite tips, 
Stage 2 in \cref{fig:1dalsi7_interface_stages} shows that the mushy zone boundary delimited by dendrite tips reaches
reaches the free liquid surface. Upon subsequent solidification, two distinct boundaries are created: 
a first boundary separating interdendritic liquid from the air, and a second boundary that separates the dendrite tips from the air,
as illustrated in stage 3 of \cref{fig:1dalsi7_interface_stages}.
In other words, a porous medium made up of solid+air settles between the mushy zone (solid+liquid) and the air domain. 
The lower part of the this porous medium is defined by the $\liqair$ interface and is driven by solidification shrinkage,
as it was already the case during stages 1 and 2.
Therefore, its real microscopic velocity is equal to the interdendritic liquid velocity, $\vl$. 
According to \citet{dantzig_solidification_2009},
this velocity is constant when the solidification shrinkage and the isotherms velocity $\vec{v}_T$ are constant, as states the equation:
%----------------
\begin{align}
\label{eq:real_velocity}
& \vl = -\beta_{SS} \vec{v}_T
\end{align}
%---------------
As for the upper part of porous medium, delimited by the $\solair$ boundary, its motion could be induced by a 
mechanical deformation of the solid phase either due to thermal shrinkage/expansion or external mechanical stresses.
The first factor is ubiquitous in any solidification process, while the second factor is process-dependent. 

In the present work, we remind that the solid phase is assumed fixed and rigid, therefore we consider dendrites to be undeformable during their growth. 
Unfortunately, this assumption is contradictory with our current situation where the metal keeps shrinking, 
until an overlap of the transition zone (intersection of both domains, identified by $\heaviside^{tr}$) and the mushy zone takes place, 
as shown in \cref{fig:1dalsi7_interface_stages} (second row, stage 3).
At this point, both interfaces define the \emph{M-A} boundary. Although it is necessary to track the $\solair$ boundary also, the present work limited to considering the $\liqair$ interface as fully defining the metal-air boundary. 
Tracking the $\solair$ interface adds complexity as an additional tracking method has to be used like a new level set with distinct numerical properties. 
This assumption will have some influence regarding the overall simulation performance, as some errors are induced, as the porous medium is not properly accounted for.
Further discussions about the outcomes of our definition of the metal-air boundary are given in the 1D application section.
% ---------------END OF INSERTED TEXT ----------------------------------
With the previous definitions, \cref{eq:transport_presence} can be recast with the level set 
method by using the smoothed Heaviside function in the metal:
% For the metal, this function is equal to one and decreases to zero in the air in a smooth way across both interfaces, solid-air and liquid-air.
% Since the solid phase is assumed fixed without possible deformation, and knowing that air is assumed incompressible, 
% the solid-air interface does not move, leading to the following equation: 
%------------
\begin{subequations}
\begin{align}
\label{eq:transport_heaviside}
& \frac{d \heavisideM}{dt} = \tempup{\heavisideM} + \vec{v^{M-A}} \cdot \nabvec \heavisideM = 0 \\
& \frac{d \heavisideM}{dt} = \tempup{\heavisideM} + \vliqair \cdot \nabvec \heavisideM = 0
\end{align}
\end{subequations}
%------------

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/1d/interface_stages.pdf}
% caption
{Schematic describing (first row) the physical solidification process and (second row) its numerical treatment of moving the boundary between air and metal domains, at three intermediate stages of solidification. 
$\heavisideM$, $\heavisideA$ and $\heaviside^{tr}$ are respectively the Heaviside functions for the metal, the air and the transition zone between both domains.}
% label
\label{fig:1dalsi7_interface_stages}
\end{figureth}
%--------------

%======================

\section{FE partitioned model}
%--------------------------------------------------
 
In this section, we start from the monodomain finite element model 
presented in \cref{sec:monodomain} that was relevant to the metal only, 
referred to by the superscript $M$, then present the essential assumptions and formulations 
that allow predicting solidification shrinkage in a Eulerian context that introduces
another domain, the air, referred to by the superscript $A$.

\subsection{In the metal}
% ------------------------------------------------

\subsubsection{Mass and momentum conservation}
% ------------------------------------------------

By assuming a fixed solid phase ($\vs=\vec{0}$), i.e. a constant density 
for the solid phase without any transport of this phase, 
the average velocity in the metal reduces only to liquid's average velocity. 

Therefore, we can write:
%------------
\begin{align}
\label{eq:vitmetal}
& \vM = \vit + \vits = \gl \vl + \cancel{\gs \vs}
\end{align}
%------------

With \cref{eq:vitmetal}, the mass balance in the metal writes:
%------------
\begin{subequations}
\begin{align}
& \tempup{\avg{\rho}^M} + \nabvec \cdot \avg{\rho \vec{v}}^M  = 0 \\ 
& \tempup{\avg{\rho}^M} + \nabvec \cdot \brac{ \gl \rhol \vl} = 0 \\ 
& \tempup{\avg{\rho}^M} + \rhol \nabvec \cdot \brac{ \gl \vl} 
	+ \gl \vl \cdot  \nabvec \rhol = 0 \\	
\label{eq:mass_balance_metal}
& \nabvec \cdot \vit 
= -\frac{1}{\rhol} \brac{\tempup{\avg{\rho}^M }+ \vit \cdot  \nabvec \rhol}
\end{align}
\end{subequations}
%------------

\Cref{eq:mass_balance_metal} explains the flow due to shrinkage. 
A negative divergence term means that a liquid feeding 
is necessary to compensate for a density increase upon solidification, where $\rhos > \rhol$ in the transient term, 
hence acting as a flow driving force in the melt.
The second RHS term accounts for the volume change 
due to heat and species variations in the liquid.

When the metal's density was considered constant during solidification, 
the assumption of an incompressible system made it possible to
use the Boussinesq approximation. However, in the case of solidification shrinkage, 
the average density ${\avg{\rho}}^M$ varies, as it depends on the solidification 
path as well as on $\rhos$ and $\rhol$ which are not equal nor constant.

Therefore, the incompressibility condition is no more applicable. In such case, 
the earlier given system \cref{eq:conservation_momentum} is reformulated without 
any reference value for density and assuming a fixed solid phase:
%------
\begin{equation}
\label{eq:momentum_balance_metal}
   \left\{
   \begin{aligned}
      & \rhol_0 \brac{\tempup{ \vit } + \frac{1}{\gl} \nabvec \cdot \brac{\vit \times \vit}} = \\
	  &- \gl\nabvec \pl + \nabvec \cdot \brac{\mul \brac{\nabmat \vit + \nabmattransp \vit}}
	  - \gl \mul \K^{-1} \vit + \gl \rhol \gravity\\ \\
      & \nabvec \cdot \vit = -\frac{1}{\rhol} \brac{\tempup{\avg{\rho}^M} + \vit \cdot  \nabvec \rhol}
    \end{aligned}
    \right.
\end{equation}
%------------
% ======================
\subsubsection{Energy conservation}
% ======================
In the energy equation, a volumetric source term accounts for the heat dissipation 
caused by the shrinking metal volume. Before writing the new equation, we make the following assumptions:

% ======================
%Assumptions
% ======================
\begin{itemize}
\itemsep0em
\item consequence of the static solid phase: $\avg{\rho h \vec{v}}^M = \gl \rhol \hl \vl +  \cancel{\gs \rhos \hs \vs}$,
\item the heat generated by mechanical deformation, $\mathbb{S}:\dot{\varepsilon}$, is neglected.
\end{itemize}
% ======================
%Formulation
% ======================
The unknowns in the energy conservation are the average volumetric enthalpy $\avg{\rho h}^M$ and temperature $T$.
The energy conservation equation writes:
%--------------
\begin{subequations}
\begin{align}
	& \tempup{\avg{\rho h}^M} + \nabvec \cdot \avg{\rho h \vec{v}}^M 
	= \nabvec  \cdot \brac{\avg{\kappa}^M \nabvec T } \\
	& \tempup{\avg{\rho h}^M} + \nabvec \cdot \brac{ \gl \rhol \hl \vl} 
	= \nabvec  \cdot \brac{\avg{\kappa}^M \nabvec T } \\
	& \tempup{\avg{\rho h}^M}
		+ \vit \cdot \nabvec \brac{\rhol \hl}
		= \nabvec  \cdot \brac{\avg{\kappa}^M \nabvec T }
		  - \rhol \hl  \nabvec \cdot \vit \\   
	\label{eq:energy_balance_metal}
	& \tempup{\avg{\rho h}^M}
		+ \vit \cdot \nabvec \brac{\rhol \hl}
		= \nabvec  \cdot \brac{\avg{\kappa}^M \nabvec T }
		+ \hl \brac{\tempup{\avg{\rho}^M} + \vit \cdot  \nabvec \rhol} 
\end{align}
\end{subequations} 

The second term in the RHS of \cref{eq:energy_balance_metal} is a heat power (of unit $Wm^{-3}$) 
that adds to the system in the liquid phase (if $\rhol$ is not constant) as well as in the mushy zone (if $\rhol$ and $\rhos$ are not equal). 
This term is proportional to the solidification rate and expresses 
the heat generated in regions where the average density is changing and/or a gradient of liquid density is being advected.

% ======================
\subsubsection{Species conservation}
% ======================
The last conservation principle is applied to the chemical species or solutes. This principle allows predicting
macrosegregation when applied to a solidification system, along with the mass, momentum and energy balances.
However, the conservation equation should be reformulated in the case of a melt flow driven by shrinkage.
% ======================
% Assumptions
% ======================
Considered assumptions are: 
\begin{itemize}
\itemsep0em
%\item the alloy is binary, i.e. it is composed from one solute, and hence the notation of the average composition
%		without a solute index: $\wavg$ for the mass composition and $\avg{\rho w}$ for the volume composition
\item %the solid fraction is determined assuming complete mixing in both phases, hence the lever rule is applied. 
	  the solidification path is tabulated using thermodynamic data at equilibrium,
\item the macroscopic solute diffusion coefficient $D^s$ in the solid phase is neglected in the mass diffusive flux term,
\item consequence of the static solid phase: $\avg{\rho w \vec{v}}^M = \gl \rhol \wl \vl +  \cancel{\gs \rhos \ws \vs}$.
\end{itemize}

% ======================
%Formulation
% ======================
The species conservation presents similarities with the energy conservation formulated in the previous section. 
The main difference is the breakup of the volumetric variable $\avg{\rho w}^M$ into a product of 
density  $\avg{\rho}^M$ and the mass composition $\avg{w}^M$ in the transient term.

For a binary alloy, we write:
%--------------------------
\begin{subequations}
\begin{align}
 & \tempup{\avg{\rho w}^M} + \nabvec \cdot \avg{\rho w \vec{v}}^M - \nabvec  \cdot \brac{\avg{\Dl} \nabvec \brac{\rhol \wl} } = 0 \\
 %
 & \avg{\rho}^M \tempup{\avg{w}^M} + \avg{w}^M \tempup{\avg{\rho}^M} 
	+ \nabvec \cdot \brac{\gl \rhol \wl \vl} 
	- \nabvec \cdot \brac{\gl \Dl \nabvec \brac{\rhol \wl} } = 0 \\
 %
 \label{eq:species_1}
  \begin{split}
	& \avg{\rho}^M \tempup{\avg{w}^M} + \avg{w}^M \tempup{\avg{\rho}^M} 
	+ \brac{\rhol \wl} \nabvec \cdot \vit + \vit \cdot \nabvec \brac{\rhol \wl} \\
	& - \nabvec \cdot \brac{\gl \Dl \nabvec \brac{\rhol \wl} } = 0 
  \end{split}
%
\end{align}
\end{subequations}
%--------------------------

The mass balance, \cref{eq:mass_balance_metal}, gives the following relation when the liquid density is constant:
%--------------------------
\begin{align}
\label{eq:species_divV}
\nabvec \cdot \vit = -\frac{1}{\rhol} \brac{\tempup{\avg{\rho}}^M}
\end{align}
%----------------
If we use the result of \cref{eq:species_divV} in \cref{eq:species_1}, then we get the following equation:
\begin{align}
\avg{\rho}^M \tempup{\avg{w}^M}  + \avg{w}^M \tempup{\avg{\rho}^M} =
\wl \tempup{\avg{\rho}^M}  - \vit \cdot \nabvec \brac{\rhol \wl} + \nabvec \cdot \brac{\gl \Dl \nabvec \brac{\rhol \wl} }
\end{align}
%
Applying Voller-Prakash \citep{voller_modelling_1989} variable splitting, the system ends up with only one variable, $\avg{w}^M$. 
The splitting is done as follows:
\begin{align}
\label{eq:voller_prakash}
\wl = \brac{\wl}^t + \avg{w}^M - \brac{\avg{w}^M}^t
\end{align}
%
where the superscript $t$ refers to the previous time step, and the absence 
of this superscript corresponds to the unknown variable at the next time step.
The chemical species conservation writes, still assuming a constant liquid density:
%
% \begin{subequations}
\begin{align}
  \begin{split}
	& \avg{\rho}^M \tempup{\avg{w}^M}  + \cancel{\avg{w}^M \tempup{\avg{\rho}^M}} = \\
	& \cancel{\avg{w}^M \tempup{\avg{\rho}^M}}  
	  - \rhol \vit \cdot \nabvec \avg{w}^M 
	  + \nabvec \cdot \brac{\gl \rhol \Dl \nabvec \avg{w}^M } \\
	& + \tempup{\avg{\rho}^M} \crochet{\brac{\wl}^t 
	  -  \brac{\avg{w}^M}^t} 
	  - \rhol \vit \cdot \nabvec \brac{\brac{\wl}^t -\brac{\avg{w}^M}^t} \\
	& - \nabvec \cdot \crochet{\gl \rhol \Dl  \nabvec \brac{\brac{\avg{w}^M}^t -\brac{\wl}^t} }
  \end{split}
\end{align}

%------------------------------
\begin{align}
\label{eq:solute_balance_metal}
\begin{split}
 & \avg{\rho}^M \tempup{\avg{w}^M}  + \rhol  \vit \cdot \nabvec \avg{w}^M - \nabvec \cdot \brac{\gl \rhol \Dl \nabvec \avg{w}^M}=\\
 &	 - \tempup{\avg{\rho}^M} \crochet{\brac{\avg{w}^M}^t - \brac{\wl}^t} \\ 
 &	 + \rhol \vit \cdot \nabvec \brac{\brac{\avg{w}^M}^t -\brac{\wl}^t}
 	 - \nabvec \cdot \crochet{\gl \rhol \Dl  \nabvec \brac{\brac{\avg{w}^M}^t -\brac{\wl}^t} }
  \end{split}
  \end{align}
%--------------
It is noted that \cref{eq:solute_balance_metal} is valid only if both densities $\rhol$ and $\rhos$
are constant but have different values. Since density changes are incorporated in this equation, 
inverse segregation following solidification shrinkage could be predicted.
For the case where macrosegregation is solely due to fluid flow generated by natural or forced convection, 
i.e. no shrinkage occurs whether due to thermal-solutal contraction or phase change, 
the overall volume remains constant, hence density will be constant.
% -----------------------------------------------------------
\subsection{In the air}
% -----------------------------------------------------------
The presence of an air domain in our approach is important to follow the free surface of the solidifying metal.
For this particular reason, some assumptions are introduced and explained in this section in order to limit unnecessary treatment within
the air, since it does not undergo phase change. It should be reminded that we consider air as a single-phase system, hence superscripts $A$ and $a$
are interchangeably used. 
% -------------------
\subsubsection{Mass and momentum conservation}
%-----------------
To simplify fluid flow resolution in the air, we consider it as incompressible.
Therefore, the free metal surface is not 
disturbed by air flow in its vicinity, but only by shrinkage flow in the liquid metal. With the incompressibility of air, we are saying that any deformation of the free surface 
is solely due to an air mass increase, coming from the system boundaries. The mass balance hence writes:
%------------
\begin{align}
\label{eq:mass_balance_air}
& \nabvec \cdot \vA = \nabvec \cdot \va = 0
\end{align}
%------------

The air flow is governed by time-dependent incompressible Navier-Stokes equations, as previously done for the metal:
%------
\begin{equation}
\label{eq:momentum_balance_air}
   \left\{
   \begin{aligned}
      & \rhoa_0 \brac{\tempup{ \va } + \nabvec \cdot \brac{\va \times \va}} = \\
	  &- \nabvec \pa + \nabvec \cdot \brac{ \mua  \brac{\nabmat \va + \nabmattransp \va}}
	   + \rhoa \gravity\\ \\
      & \nabvec \cdot \va = 0
    \end{aligned}
    \right.
\end{equation}
%------------

The air density $\rhoa$ is considered constant along the casting process, 
therefore thermal gradients in the air that arise due to the low
thermal conductivity, do not generate any flow, i.e. no Boussinesq approximation 
is made on the term $\rhoa \gravity$ in \cref{eq:momentum_balance_air}.

%-----------

\subsubsection{Energy conservation}

It was mentioned in the introduction of the current section that air is a single-phase system
that cannot undergo any phase change. Therefore, heat transfer in this domain simplifies to thermal convection
and thermal conduction with a low thermal conductivity coefficient, $\ka$, for a single gas phase.
The energy balance governs the air enthalpy $\avg{\rho h}^A$ (which is equal to $\rhoa \ha$ 
in the current context) as follows:
%-----------------
\begin{subequations}
\begin{align}
	& \tempup{\avg{\rho h}^A} + \nabvec \cdot \avg{\rho h \vec{v}}^A 
	= \nabvec  \cdot \brac{\avg{\kappa}^A \nabvec T } \\
	& \tempup{\avg{\rho h}^A} + \nabvec \cdot \brac{ \rhoa \ha \va} 
	= \nabvec  \cdot \brac{\ka\nabvec T } \\
	\label{eq:energy_balance_air}
	& \tempup{\avg{\rho h}^A}
		+ \va \cdot \nabvec \brac{\rhoa \ha}
		= \nabvec  \cdot \brac{\ka\nabvec T }
\end{align}
\end{subequations}
%------------

\subsubsection{Species conservation} \label{sec:solute_air}
%-----------------
The composition of alloying elements is a crucial quantity to predict in this work. 
Nevertheless, such prediction is only relevant with metallic species, even if the air 
is also made up of other chemical species (e.g. nitrogen, oxygen ...). 
While the other conservation equations (energy, mass and momentum) are important to be solved in the air, 
the species conservation equation brings no added value to the model when solved in this domain. 
It may even cause the composition values (i.e. the equation solution) to be unstable near the \emph{M-A} boundary, where mixed properties
may lead to unwanted solute transport in both directions across the boundary, hence causing cumulative errors.
Therefore, we leave the species resolution in the air to be included in the final monolithic model.

% ==========================================
\section{FE monolithic model} 
% ==========================================
The monolithic model combines all conservation equations derived for metal and air in a unique set of equations, to be solved on a Eulerian mesh.
This is done by multiplying each conservation equation relative to a domain, obtained in the previous section, by the corresponding Heaviside
function then summing all terms, finally using the mixed properties to simplify notations.
For each conservation equation, these mixed properties will be properly defined before writing the final monolithic equation.

% ==========================================
\subsection{Mass and momentum conservation}
% ==========================================
We define the metal+air average system velocity, $\vitf$, as an arithmetic mixing between each domain's relative average fluid velocity,
i.e. the domain's own relative fluid phase velocity with respect to solid phases. In parallel, we also define $\vec{\avg{v}^F}$ as the system's 
fluid intrinsic velocity, obtained by an arithmetic mixing between intrinsic velocities of domain fluids. 
In the present context, the metal domain consists of a single fluid phase (liquid) and solid phases that form in fixed and rigid structures 
(assuming that solidification results in undeformable columnar structures, without any free-to-move equiaxed structure).
The air domain entirely consists of a fluid phase.
With this notation, we express the monolithic mass balance as:
%---
\begin{align}
\label{eq:monolithic_mass_1}
& \nabvec \cdot \vitf = \nabvec \cdot \brac{\heavisideM \vM + \heavisideA \vA} \\
\label{eq:monolithic_mass_2}
& \nabvec \cdot \vitf = \heavisideM \nabvec \cdot \vM + \heavisideA \cancel{\nabvec \cdot \vA} + \cancel{\nabvec \heavisideM \cdot \brac{\vM - \vA}}\\
\label{eq:monolithic_mass_3}
& \nabvec \cdot \vitf = \heavisideM \nabvec \cdot \vit
\end{align}
%---
where we used the relation \cref{eq:vitmetal} in the case of a fixed rigid solid to obtain \cref{eq:monolithic_mass_3}.
As for the second term in \cref{eq:monolithic_mass_2}, we have made the assumption that air is incompressible, hence $\nabvec \cdot \vA= 0$. 
Therefore any volume variation of the metal domain, will trigger an air inflow or suction effect through the surface boundaries of
the air domain. The third and last term in the same equation 
expresses a velocity jump at the interface. 
In our case, we neglect this contribution by assuming that both velocities tend to be equal
when the interface thickness tends to zero. 

Finally, using the monolithic mass balance \cref{eq:mass_balance_metal}, we get:
%---
\begin{align}
\label{eq:monolithic_mass}
& \nabvec \cdot \vitf = \heavisideM \brac{-\frac{1}{\rhol} \brac{\tempup{\avg{\rho}^M }+ \vit \cdot  \nabvec \rhol}}
\end{align}
%---
In order to derive the monolithic momentum balance, we first define a fluid fraction, $\gf$, as an arithmetic mixing 
between liquid and air fractions across the interface:
% ----------
\begin{align}
\label{eq:fluidfraction}
\gf = \heavisideM \gl + \heavisideA \ga = \heavisideM \gl + \heavisideA
\end{align}
% ----------
This quantity will be essential for the monolithic Darcy term.
We have seen in the previous chapter that adding the Darcy term for the metallic alloy momentum equation modifies the shape of the 
latter, dividing all terms by the liquid fraction, $\gl$. The presence of this dissipation term 
in one domain, obliges us to keep it in both domains but "deactivate" it where it is useless, i.e. in the air.
This is done by computing a fictitious permeability in the air as function of the air fraction using the Carman-Kozeny model,
as used previously for the metal in \cref{eq:permeability}. We may speak of level set mixing for the Darcy term.
It has a double advantage:
\begin{enumerate}
\item the consistency in shape is kept between both domains equations, thus easily deriving the monolithic system;
\item since the monolithic system retains the shape of the monodomain equation, the VMS solver does not require further implementation updates
and subsequent validation.
\end{enumerate}
%
The first point implies that the Darcy term should also be added in the the air's momentum balance, but remains inactive 
by imposing a high permeability in the air, while having realistic values where needed, namely in the metal domain.
The modified permeability, $\Kmodif$, depends on the fluid fraction (\cref{eq:fluidfraction}) as follows:
%--------------------
\begin{align}
\label{eq:darcy_modif}
&\Kmodif = \frac{\sdas^2 \gf^3}{180\brac{1-\gf}^2}	
\end{align}
%---------------

Depending on the values of this quantity, the extent to which the Darcy becomes imposing in Navier-Stokes varies as follows:
\begin{itemize}
\itemsep0em
\item $\Kmodif^{-1} \rightarrow 0$ (completely permeable), then Darcy's term is negligible in Navier-Stokes resolution,
\item $\Kmodif^{-1} > 0$ (slightly permeable), then fluid flow is greatly dissipated due to a decreasing permeability,
\item $\Kmodif^{-1} \rightarrow \infty$ (non permeable), then no fluid flow may exist.
\end{itemize}
These 3 cases are graphically represented in \cref{fig:darcy_modif}, showing the different values along with the transitions 
with respect to phases and domains distribution. 

%---------------
\begin{figure}[htbp]
\centering
%\begin{minipage}{.5\textwidth}
  \begin{subfigure}{1.0\textwidth}
    \centering
    \def\svgwidth{250pt}
	\import{Chapter5/Graphics/}{darcy2.pdf_tex}
	%\caption{Initial state}
    %\label{fig:real_ingot_stage_a}
  \end{subfigure}
  %
\caption{Schematic representation of an ingot undergoing solidification while shrinking. 
The inverse of the modified permeability, $\Kmodif^{-1}$, falls to zero in the air and liquid phases,
indicating that the Darcy term is only activated in the solid and liquid+solid regions.
The arrows indicate three different transitions of the Darcy term between the air and metal domains.}
\label{fig:darcy_modif}
\end{figure}
%---------------

As for the weight force in both domains, it is taken into account via \cref{eq:monolithic_boussinesq}. 
The phase densities may vary as functions of other parameters such
as temperature or phase composition ($\rhol$ depends on both), creating buoyancy forces of convection inside the fluid.

In our approach, since we are only interested in liquid's flow, we keep the air phase density $\rhoa$ constant,
so as to prevent a mixture of forces around the level set, which helps stabilise the fluid flow resolution.
The mechanical properties are mixed as follows:
%------------
\begin{align}
%
% \label{eq:monolithic_density}
% \text{Fluid density}&: \mix{\rho^F} = \heavisideM \rhol + \heavisideA \rhoa \\
							%= \heavisideM \brac{\gl \rhol + \gs \rhos} + \heavisideA \rhoa \\
%
\label{eq:monolithic_density_ref}
\text{Reference fluid density}&: \mix{\rho^F_0} = \heavisideM \rhol_0 + \heavisideA \rhoa_0 \\
							%= \heavisideM \brac{\gl \rhol + \gs \rhos} + \heavisideA \rhoa \\
%
\label{eq:monolithic_viscosity}
\text{Dynamic viscosity}&: \mix{\mu} = \heavisideM \mul + \heavisideA \mua \\
%
\label{eq:monolithic_boussinesq}
\text{Weight force}&: \mix{\rho g} \gravity 	=  \heavisideM \gl \rhol \gravity + \heavisideA \ga \rhoa \gravity
												=  \heavisideM \gl \rhol \gravity + \heavisideA \rhoa \gravity
%
\end{align}
%-----------

The momentum balance can now be obtained from $\heavisideM \times$\cref{eq:momentum_balance_metal} $+\heavisideA \times$\cref{eq:momentum_balance_air}, after adapting \cref{eq:momentum_balance_air} to account for a fictitious Darcy term :

%------
\begin{equation}
\label{eq:monolithic_momentum}
   \left\{
   \begin{aligned}
      & \mix{\rho^F_0} \brac{\tempup{ \vitf } + \frac{1}{\gf} \nabvec \cdot \brac{\vitf \times \vitf}} = \\
	  &- \gf\nabvec p + \nabvec \cdot \brac{\mix{\mu} \brac{\nabmat \vitf+ \nabmattransp \vitf} } 
	  - \gf \mix{\mu} \Kmodif^{-1} \vitf + \mix{\rho g} \gravity\\ \\
      & \nabvec \cdot \vitf = \heavisideM \brac{-\frac{1}{\rhol} \brac{\tempup{\avg{\rho}^M }+ \vit \cdot  \nabvec \rhol}}
    \end{aligned}
    \right.
\end{equation}
%------------

% ==========================================
\subsection{Energy conservation}
% ==========================================
To write the monolithic energy conservation equation, we are interested in \cref{eq:energy_balance_metal,eq:energy_balance_air}.
Mixed quantities from these equations are defined by:
%------------
\begin{align}
%
\label{eq:monolithic_enthalpy}
\text{Total enthalpy}&: \mix{\avg{\rho h}} =  \heavisideM \avg{\rho h}^M + \heavisideA \avg{\rho h}^A  \\
%
\label{eq:monolithic_fluid_enthalpy}
\text{Fluid phases enthalpy}&: \mix{\brac{\rho h}^F} = \heavisideM \rhol \hl + \heavisideA \rhoa \ha \\
%
\label{eq:monolithic_conductivity}
\text{Average thermal conductivity}&: \mix{\avg{\kappa}} = \heavisideM \avg{\kappa}^M + \heavisideA \avg{\kappa}^A \\
%
\label{eq:monolithic_heat_dissipation}
\text{Fluid heat change due to shrinkage}&: \mix{\Phi^F} = \heavisideM \rhol \hl \nabvec \cdot \vit
\end{align}
%-----------
where \cref{eq:monolithic_enthalpy} will be used to predict the transient change in the system's global enthalpy, 
\cref{eq:monolithic_fluid_enthalpy} for the fluid-transported enthalpy in both domains while \cref{eq:monolithic_conductivity}
expresses the global energy conduction in the system. The last equation, \cref{eq:monolithic_heat_dissipation}, is only present in the 
domain whose volume is changing, that is the metal in our case.
Using the mixed thermophysical properties, \cref{eq:energy_balance_metal,eq:energy_balance_air} can now be mixed to obtain:
%-------
\begin{align}
\label{eq:monolithic_energy}
\tempup{\mix{\avg{\rho h}}}
		+ \vitf \cdot \nabvec \mix{\brac{\rho h}^F}
		= \nabvec  \cdot \brac{\mix{\avg{\kappa}} \nabvec T }
		+ \mix{\Phi^F} 
\end{align}
%-------
The solution of \cref{eq:monolithic_energy} is $\mix{\avg{\rho h}}$, 
a mixed field between both domains average volumetric enthalpies. 

Using the current approach for the energy, any motion of the \emph{M-A} boundary is energetically translated
into a phase change between the air phase on one side and the metallic phases on the other side.
\citet{chen_three_2014} tackled this problem by reformulating the energy equation with the smoothed Heaviside functions in order to prevent 
this purely numerical phenomenon. However in the current work, we prefer avoiding this numerical artefact by 
using the same tabulated phase enthalpy properties (or specific heat if the tabulation approach is not used) for
the air and the liquid phase. This assumption made on only for the $\liqair$ is compatible with definition of the mobile \emph{M-A}
boundary made in \cref{sec:M_A_definition}.

%-------------------------------------
\subsection{Species conservation} \label{sec:monolithic_species}
%-------------------------------------
% --------------- BEGIN INSERTED TEXT
% Consequently, 
% %--------------
% \begin{align}
%   \label{eq:solute_balance_air}
% 	& \avg{\rho}^A \tempup{\avg{w}^A}
% 	%+ \va \cdot \nabvec \brac{\rhoa \wa}
% 	- \nabvec \cdot \brac{\Da \nabvec \brac{\rhoa \wa} } = 0
% \end{align}
% %--------------

% In contrast to \cref{eq:solute_balance_metal} for the metal, solute balance in the air, given by \cref{eq:solute_balance_air}, provides
% a linear equation as we consider a special case where the domain is monophase, therefore:  $\avg{w}^A = \avg{w}^a$ at all times.
% --------------- END INSERTED TEXT
Unlike monolithic energy conservation which applies to whole metal+air system, the monolithic species conservation equation is dedicated
to the transport of \emph{metallic} chemical species, meaning that the air does not contain any metallic species to be transported.
This physical specificity leaves us with two main resolution strategies:

\paragraph{Monolithic strategy:}
we combine two species conservation equations into a single monolithic equation. 
We compute the conservation of chemical species in both the metal and the air, considering the latter as
a \emph{fictitious metal}. We apply the same mixing technique used to formulate
\cref{eq:monolithic_energy}, based on the monodomain species conservation equation
used without level set, \cref{eq:conservation_solute_init}. The relevant mixed quantities
are defined as follows:
%------------
\begin{align}
%
\label{eq:monolithic_fluid_composition}
\text{Fluid phases composition}&: \mix{\brac{\rho w}^F} = \heavisideM \rhol \wl + \heavisideA \rhoa \wa \\
%
\label{eq:monolithic_solute_diffusion}
\text{Average solute diffusion}&: \mix{\avg{D}^F} = \heavisideM \gl '\avg{D}^l + \heavisideA \ga \avg{D}^a \\
%
\label{eq:monolithic_solute_dissipation}
\text{Fluid composition change due to shrinkage }&: \mix{\Psi^F} = \heavisideM \rhol \wl \nabvec \cdot \vit
%
\end{align}
%----------- 
The corresponding monolithic equation is given by:
%-------
\begin{align}
\label{eq:monolithic_solute}
\begin{split}
 & \mix{\avg{\rho}} \tempup{\mix{\avg{w}}}  + \vitf \cdot \nabvec \mix{\brac{\rho w}^F}
    = \nabvec  \cdot \brac{\mix{\avg{D}^F} \nabvec \mix{\brac{\rho w}^F} } + \mix{\Psi^F} 
 % &   - \tempup{\avg{\rho}^M} \crochet{\brac{\avg{w}^M}^t - \brac{\wl}^t} \\ 
 % &   + \rhol \vit \cdot \nabvec \brac{\brac{\avg{w}^M}^t -\brac{\wl}^t}
   % - \nabvec \cdot \crochet{\gl \rhol \mix{\avg{D}}  \nabvec \brac{\brac{\mix{\avg{w}}}^t -\brac{\mix{\avg{w}}^F}^t} }
  \end{split}
\end{align}
%-------
where $\mix{\avg{w}}$ is the mixed average composition solution for the whole domain.  
% %-------
% \begin{align}
% \label{eq:monolithic_solute}
% \begin{split}
%  & \avg{\rho}^M \tempup{\mix{\avg{w}}}  + \rhol  \vit \cdot \nabvec \mix{\avg{w}^F} - \nabvec \cdot \brac{\gl \rhol \Dl \nabvec \mix{\avg{w}}}=\\
%  &   - \tempup{\avg{\rho}^M} \crochet{\brac{\avg{w}^M}^t - \brac{\wl}^t} \\ 
%  &   + \rhol \vit \cdot \nabvec \brac{\brac{\avg{w}^M}^t -\brac{\wl}^t}
%    - \nabvec \cdot \crochet{\gl \rhol \mix{\avg{D}}  \nabvec \brac{\brac{\mix{\avg{w}}}^t -\brac{\mix{\avg{w}}^F}^t} }
%   \end{split}
% \end{align}
% %-------

Then, we control solute transport between both domains by proposing two
monolithic resolution techniques, based on the treatment of solute diffusive 
and advective transport in the air domain: 

\begin{enumerate}

	\item \textbf{Monolithic with low solute diffusion (MD)}: 
	a very low macroscopic solute diffusion coefficient is used, 
	at most a thousand times less than its value in the melt, $\Da \lll \Dl$.
	The low solute diffusion in the air may not completely ensure a zero solute flux at 
	the \emph{M-A} boundary, but it helps maintaining a weak diffusive transport,

	\item \textbf{Monolithic with low solute diffusion and low solute advection (MDA)}: 
  the computed fluid velocity, $\vitf$, is post-processed to be zero 
	in the species equation for the air, thus suppressing the advective solute transport term influence
	which can be more important than the diffusive transport.
	
\end{enumerate}

In both cases, the initial air average composition (which is equal to the composition of the air phase in our case) 
should normally be set to zero. However, this initialisation
creates a composition gradient across the \emph{M-A} boundary, creating a driving force for diffusion. 
Another option would be initialising both domains to the same value, $\avg{\Cnominal}^M=\avg{\Cnominal}^A$. 
This has the advantage of keeping solutal gradients to the lowest during the boundary motion 
and delaying as much as possible the occurrence of artificial solute transport, until the $\solair$ 
interface forms gradually.

% we consider one equation for species transport for both air and metal. 
% By adjusting the solutal diffusion coefficient in the air to low values, we
% can limit  The motivation to go for this strategy using very low diffusion coefficient in the air.
% (where \emph{fluid } refers to liquid phase in the metal and the single air phase in the air). 
% In this case, the fictitious air composition, $\avg{w}^A$, 
% is reset to zero after each resolution so as to prevent any enrichment.

\paragraph{Non-monolithic (NM) strategy:}
this strategy aims to avoid the difficulty of dealing with a \emph{fictitious} solute equation for the air.
This is done by considering only the metal's species conservation equation, \cref{eq:solute_balance_metal}.
The solution of the latter is the metal's average composition, $\avg{w}^M$. From this solution, we determine the monolithic
composition value, $\mix{\avg{w}}$, :  
% -----------
\begin{align}
\label{eq:nonmonolithic_solute}
& \mix{\avg{w}} = \heavisideM \avg{w}^M + \heavisideA \avg{w_0}^M     
\end{align}
% -----------
where we directly initialise the composition in the air to the metal's nominal composition.
This strategy has the advantage of being simpler, especially that we do not have to deal with density terms
(which can be seen for example in \cref{eq:solute_balance_metal}) 
as dictates the previous monolithic strategy, knowing that air density remains constant in this work.

In the next section, we present a simple 1D solidification case with solidification shrinkage, in which we test
the segregation results given by each strategy.

%------------------
% \subsection{Interface motion and stability}
%-----------------------------

% In chapter 2, we have presented the transport equation of the distance function using the velocity solution 
% provided by solving momentum conservation equations. In this section, we discuss some important points regarding the stability
% of the interface while being transported. When real values are assigned for the mechanical properties, especially density,
% a ratio of three orders of magnitude exists in the diffuse interface. This high ratio may badly influence the stability
% of the interface, unless we pay attention to the order of the integration method as well as the time step used in Navier-Stokes
% resolution.

% \subsection{Integration order influence}
% %---------------------------------
% \subsection{Time step influence}
% %---------------------------------
% In the first tests, we noticed \\
% TRY TIME STEP 0.01 sec (stable) and 0.02 sec (unstable): is CFL the cause ?
% %---------
% \subsection{Classical coupling}
% %
% A "classical" coupling comes in the sense of "unmodified" coupling. This approach consists of taking the output of the fluid mechanics
% solver, then feed it as raw input to level set transport solver. The physical translation would be that the interface motion is dictated
% by the fluids flow in its vicinity. No treatment whatsoever is done between the two mentioned steps. While conservation principles are best
% satisfied with this approach, the latter yields some drawbacks, preventing its application in a generic way.
% For instance, the free liquid surface is not necessarily horizontal at all times and that can lead to the wrong shrinkage profile
% when solidification is complete.
% \comment{present the example of unstable interface when the ratio between fluids properties became greater than some value+discussion} 
% %----------------------------
% \begin{figure}[htbp]
% \centering
%  \begin{subfigure}[t]{0.4\textwidth}
%     \centering
% 	\includegraphics[width=\textwidth]{Chapter5/Graphics/UnstableInterface1.pdf}
% 	\caption{At a certain time increment (without mesh)}
%     \label{fig:UnstableInterface1}
%   \end{subfigure}
% \qquad
%  \begin{subfigure}[t]{0.4\textwidth}
%     \centering
% 	\includegraphics[width=\textwidth]{Chapter5/Graphics/UnstableInterface2.pdf}
% 	\caption{Another time increment (with mesh)}
%     \label{fig:UnstableInterface2}
%   \end{subfigure}
% \caption{Interface destabilisation under the effect of high properties ratio across the interface.}
% \end{figure}
% %----------------------
% %%---------

% \subsection{Modified coupling}
% In contrast to a classic coupling, here we attempt to modify the velocity field before feeding to the transport solver.
% The main motivation for considering this approach is the lack of stability that we observed whenever the mechanical
% properties of the fluids were different by several orders of magnitude.
% The algorithm should simultaneously fulfil these requirements: 
% \begin{itemize}
% \itemsep0em
% \item support high ratios of fluids density with close viscosities by preserving an non-oscillating interface,
% \item maintain a horizontal level at the free surface of the melt,
% \item follow shrinking metal surface profile in solidfying regions,
% \item satisfy the mass conservation principle, essentially in the metal.
% \end{itemize}
% We want to process the original transport velocity by imposing a uniform motion (speed and direction) 
% at the nodes of the free surface, and at the same time, be able to follow the pipe formation at the 
% surface as a result of solidification shrinkage, as shown in \cref{fig:horizontal_liquid_surface}.

% %----------------------
% \begin{figureth}
% % textwidth 
% {0.8}
% %path 
% {Chapter5/Graphics/FreeSurface.pdf}
% % caption
% {Snapshot of a solidifying ingot by a cooling flux from the side. The profile of the actual surface changes in solid and mushy regions
% to adapt the new density while staying perfectly horizontal in the liquid phase.}
% % label
% \label{fig:horizontal_liquid_surface}
% \end{figureth}
% %-----------------------------------
% %
% \comment{How to transport level set using velocity from momentum conservation DIRECTLY or AVERAGED PER ELEMENTS, 
% show examples of instability/stability when using false/nominal air properties \\ 
% Validation of LS transport: perform test case simulation of buoyancy driven air droplet in water by 2005Nagrath that I also have seen 
% in Shyamprasad's masters report). => I didnt notice: what time step $\delta t$ did they use ? }
% %
% %----------------------
% \begin{figureth}
% % textwidth 
% {0.8}
% %path 
% {Chapter5/Graphics/AvgTransport/BottomSideCooling.pdf}
% % caption
% {Treatment of liquid free surface in a) bottom and b) side heat extraction configurations. The dashed line represents the 
% initial level of the free liquid surface.}
% % label
% \label{fig:bottom_side_cooling}
% \end{figureth}
% %-----------------------------------

% The general idea is read the velocity around the interface up to a certain thickness, which may be the same 
% thickness as the diffuse interface defined in \cref{sec:heaviside}, then compute a volumetric average
% from all the elements in the thickness. This average is then given to the transport solver, which will apply
% the same magnitude and direction to transport the interface. However, as we only need the transport velocity
% to be uniform within the "100\% liquid" elements, it should not be the case for the other elements that belong 
% either to the mushy zone or the solid region, where shrinkage is taking place.
% Therefore, depending on the heat extraction configuration, two scenarios are possible. If heat extraction is far from
% the interface, i.e. there is not direct contact as in \cref{fig:bottom_side_cooling}a, 
% the surface area remains unchanged at any time, hence all the elements
% around the interface are "100\% liquid". This happens when a bottom cooling is applied to the ingot. In contrast, if a side cooling 
% is applied as shown in \cref{fig:bottom_side_cooling}b, the surface area of the interface will be reduced over time
% as a consequence of the solid front progression. In this case, the average transport velocity should be computed only
% from the elements belonging to the free surface. The remaining part of the interface which belongs to partial or full 
% solid regions, is transported with Navier-Stokes output, which should be some orders of magnitude less than the velocity
% imposed at the free surface, as a result of a decreasing permeability.


% \cleardoublepage
\newpage

%----------------------------------------------------------------
\section{1D application: solidification with inverse segregation}
%--------------------------------------------

% -------------------------------------------------
\subsection{Geometry and boundary conditions}
% -------------------------------------------------

A simple but very efficient way of analysing the model is to test it through a 1D flow configuration with energy and species conservation.
For this purpose, we take an aluminium-silicon alloy with the properties shown in \cref{table:data_case_inverseseg}.

%------------------------
\begin{tabulate}
% caption 
{Parameters for the 1D inverse segregation test case with a binary \bin{Al}{7}{Si} alloy \citep{gandin_constrained_2000}.}
% label
{table:data_case_inverseseg}
% line separation (e.g. 1.5mm)
{1.0mm}
% column justification-number (e.g. |c|ll|)
{llll}
% header titles (should use the & sign to switch columns)
%------------------------------------------------------------------------------------------
{\textbf{Parameter} & \textbf{Symbol} & \textbf{Value} & \textbf{Unit}}
% cells content (should use the & and // to switch columns and rows)
%------------------------------------------------------------------------------------------
{Nominal composition 				& $w_0$ 			& \num{7} 		& \si{\ucomposition} \\ 
% Liquidus temperature 				& $T_L$ 			& \num{618} 	& \si{\udegC} \\ 
% Eutectic temperature 				& $T_E$ 			& \num{577}	 	& \si{\udegC} \\  
% Segregation coefficient 			& $k$ 				& \num{0.13} 	& $-$  \\  
% Liquidus slope 					$m_L$ 			& \num{-6.5} 	& \si{\uslope} \\ 
Solid density	 					    & $\rhos$ 			& \num{2800} 	& \si{\udensity} 		\\  
Liquid density (reference)              & $\rhol_0$       & \num{2600}  & \si{\udensity}    \\   
Air density (reference) 						    & $\rhoa_0$ 			& \num{1.3} 	& \si{\udensity} 		\\  
Liquid viscosity			 		  & $\mul$ 			& \num{d-3} 	& \si{\uviscosity} 		\\  
% Solid viscosity	 					& $\mus$ 			& (Darcy) 			& \si{\uviscosity} 	\\  
Air viscosity 						  & $\mua$ 			& \num{d-4} 	& \si{\uviscosity} 		\\  
Liquid heat capacity 		 		& $c_p^l$ 			& \num{1000} 	& \si{\umasscapacity} 	\\  
Solid heat capacity 		 		& $c_p^s$ 			& \num{928.57} 	& \si{\umasscapacity} 	\\  
Air heat capacity 		 			& $c_p^a$ 			& \num{1000} 	& \si{\umasscapacity} 	\\  
Enthalpy of fusion 				 	& $l_f$ 				& \num{365384} 	& \si{\umassenergy} 	\\ 
Thermal conductivity 				& $\kappa$ 			& \num{70} 		& \si{\uconductivity}	\\
% Solute diffusion in the liquid		& $\Dl$ 			& \num{e-9} 	& \si{\udiffusivity} 	\\  
% Solute diffusion in the solid		  & $\Ds$ 			& \num{0} 	& \si{\udiffusivity} 		\\  
% Solute diffusion in the air			  & $\Da$ 			& \num{e-12} 	& \si{\udiffusivity} \\  
\hline  %------------------------------------------------------------------------------------------
Heat transfer coefficient 			 & $\hext$ 			& \num{500} 	& \si{\uhconvec} 	\\ 
External temperature 				     & $\Text$ 			& \num{100} 	& \si{\udegC} 		\\ 
Initial temperature 				     & 			& \num{800} 	& \si{\udegC} 		\\ 
% Ingot length 						         &  				& \num{0.1} 	& \si{\metre} 		\\ 
\hline %------------------------------------------------------------------------------------------
FE mesh size 						&  					& \cref{table:1dalsi7_meshsize} 	& \si{\metre} 		\\ 
Time step 							& $\dt$ 			& \cref{table:1dalsi7_comparative_nomacro} 	& \si{\second} 		\\ 
Convergence criterion (residual) 	& $\varepsilon_R$	& \num{e-5} 	& $-$ 				\\ 
Convergence criterion (temperature) & $\varepsilon_T$ 	& \num{e-2} 	& \si{\udegK}}
%--------------------------------------------------------------------------------------------------
\end{tabulate}
%------------------------

The rectangular 2D mesh having the dimensions \SI{0.14}{\metre}$\times$\SI{0.001}{m}, consists of metal and air.
Initially the air column's height is only \SI{0.04}{\metre} and the remainder of the length is the metal.  
\Cref{fig:1d_alsi7_geobc} shows the geometry and boundary conditions used for the simulations in this section. 
In the same figure, the thermal and mechanical boundary conditions are shown.
In the latter, velocity-slip conditions were imposed on the lateral boundaries while a no-slip was used at the bottom where heat is extracted,
and a free-velocity condition is set at the top of the domain, to ensure a 1D air flow from the top air inlet. 

In this case, imposing slip conditions on lateral sides is two-fold: on one hand, we need to ensure that the fluid flow solution
remains one-dimensional, hence symmetry on the boundaries solves the issue, while on the other hand during solidification, 
the resulting feeding flow should be able to transport the interface intersecting with boundary nodes. If boundary velocities
are zero, then the interface transport will face problems at these boundary nodes. This is indeed an important and relevant point 
in the next 2D test case.

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/1d/geobc.pdf}
% caption
{Computational configuration for the 1D inverse segregation case showing the domain geometry 
with the applied boundary conditions to it as well as the gravity vector.
The symmetry sides represent the following set of boundary conditions: 
adiabatic, zero normal velocity, free tangential velocity and pressure-free.
The boundary pressure of the air domain is imposed to atmospheric pressure.}
% label
\label{fig:1d_alsi7_geobc}
\end{figureth}
%--------------

%
\subsection{Shrinkage without macrosegregation}
%----------------------------------------------------

The first simulation is for solidification without any segregation, hence a unique solidification path is considered at $\Cnominal=$\SI{7}{\ucomposition},
shown in \cref{fig:shrinkage_nomacro_sp}.
This case is interesting as a reference case, where we can study volume shrinkage and level set behaviour in a simple segregation-free configuration.
We first use a homogeneous isotropic mesh of constant size $h=$ \SI{200}{\micro \metre} then the domain is remeshed before any resolution, 
as shown in \cref{fig:1dalsi7_lsmixing}. The remeshing parameters are given in \cref{table:1dalsi7_meshsize}.
The liquid and solid phase densities are assumed constant.
% and respectively equal to \SI{2600}{\udensity} and \SI{2800}{\udensity}. 
% This density difference is equivalent to a ratio of $\beta_{SS}= \brac{\rhos-\rhol}/\rhos=$\SI{7.14}{\percent},
% also termed as \emph{solidification shrinkage} by \citet{flemings_macrosegregation:_1967}. 
% In the current conditions, $\beta_{SS}$ is constant and equal to \SI{7.14}{\percent}.

Before solidification onset, almost no fluid flow occurs in the liquid metal, while air enter and leaves the domain without
changing the level set position. As soon as solidification takes place, the average metal density increases, hence
the metal volume starts decreasing by a downward level set motion. In the metal, a unidirectional flow results from
the suction effect in the mushy zone. 
Results show however that the interface stability is compromised by a chosen time step for a given mesh size, and that the interface dynamics
requires attention even before investigating the feeding flow created by solidification. As a demonstration, \cref{fig:1dalsi7_velocity_dt} shows the effect of different
time steps with the same adaptive meshing parameters. For time steps greater than 0.01 s, Navier-Stokes computations did not converge resulting in a high artificial 
flow quickly destabilising the interface. It should be noted that the frame corresponding to 0.02 s was taken at an earlier time than the two other frames.

%--------------------------------
\begin{table}[H]
\centering
\caption{Summary of the mesh parameters used to generate an adaptive anisotropic mesh, along with the level set mixing thickness, $\varepsilon$. 
Refer to \cref{sec:remesh2_params} for the definition of each mesh parameter.}
\label{table:1dalsi7_meshsize}
{\tabulinesep=1.0mm \begin{tabu}{ll}
\tabucline[1pt]{-}
\textbf{Mesh parameter} & \textbf{Value} \\\tabucline[1pt]{-}
%-----------------------------
$\varepsilon $			&	\SI{2.5e-4}{\metre}	\\
$h_{\vec{n}}$ 			&	\SI{2.5e-5}{\metre}	\\ 
$h_{\vec{\tau}}$ 		&	\SI{2e-4}{\metre}	\\ 
$h_M$  					&	\SI{1.5e-4}{\metre}	\\
$h_A$  					&	\SI{2.5e-4}{\metre} 	\\
Remeshing frequency  	&	0.1 s 		\\
Number of nodes 		&   $\approx$ \num{7e3} \\ 
Number of elements 		&   $\approx$ \num{e4} \\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}
%--------------------------------

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/1d/ls_mixing.pdf}
% caption
{Snapshots of (a,b) the initial adapted mesh around the interface with different mesh sizes in the air and the metal. The adapted region
is stretched beyond the level set mixing thickness to ensure better interpolation around the interface, in case of emergence of diffusion
instabilities. To the right, (c)  the reference fluid density and (d) viscosity are plotted in the transition zone. 
% showing a symmetric mixing for the former
% and a shifted mixing for the latter, as a consequence of the mixing laws.
The thick blue line represents the zero isovalue of the distance function.}
% label
\label{fig:1dalsi7_lsmixing}
\end{figureth}
%--------------

%--------------
\begin{figureth}
% textwidth 
{0.75}
%path 
{Chapter5/Data/1d_alsi7_nominalSP/sp_plot.pdf}
% caption
{Unique solidification path at nominal composition for the shrinkage case without macrosegregation in \bin{Al}{7}{Si},
showing the liquid phase, an aluminium-rich $\alpha$ phase (dendritic structure) and the eutectic structure.}
% label
\label{fig:shrinkage_nomacro_sp}
\end{figureth}
%--------------

%--------------------------------------
% \begin{figure}[htbp]
% \centering
% \begin{tikzpicture}
%  \pgfkeys{%
%     /pgf/number format/set thousands separator = {}}
% \begin{axis}
% [
% 	table/col sep=comma,
% 	smooth, %ybar
% 	%stack plots=y,
% 	%area style,
% 	enlarge x limits=false,
% 	legend pos=north west,
% 	scaled ticks=true,
% 	xlabel=Temperature (\si{\udegC}),
% 	ylabel=Volume fraction (-),
% 	xticklabel style={/pgf/number format/fixed},
% 	xtick={577, 600, 618},
% 	%x tick label style={rotate=45,anchor=east},
% 	width=0.6\textwidth,
% 	mark repeat	= {2},
% 	cycle list name=mycycle, %exotic,
% ]
% \addplot table [x=Temperature, y=LIQ ] {Chapter5/Data/1d_alsi7_nominalSP/sp.csv};% \closedcycle ;
% \addplot table [x=Temperature, y=ALPHA ] {Chapter5/Data/1d_alsi7_nominalSP/sp.csv};%\closedcycle;
% \addplot table [x=Temperature, y=BETA ] {Chapter5/Data/1d_alsi7_nominalSP/sp.csv};%\closedcycle;

% \legend{Liquid, $\alpha$, Eutectic}
% \end{axis}
% \end{tikzpicture}

% \caption{Unique solidification path at nominal composition for the shrinkage case without macrosegregation in \bin{Al}{7}{Si},
% showing the liquid phase, an aluminium-rich $\alpha$ phase (dendritic structure) and the eutectic structure.}
% \label{fig:shrinkage_nomacro_sp}
% \end{figure}
%--------------------------------------


%--------------
\begin{figureth}
% textwidth 
{0.6}
%path 
{Chapter5/Graphics/1d/ls_velocity_dt.pdf}
% caption
{Three average fluid velocity frames at different time steps: 0.005 s, 0.01 s and 0.02 s. The first and second frame are taken after 
50 seconds of cooling while for the last frame, the frame was taken after only 1 second of cooling, thus it is crossed to show non-convergence.
The thick black line represents the zero isovalue of the distance function. Properties are given in \cref{table:1dalsi7_comparative_nomacro,table:data_case_inverseseg}
under case ``R''.}
% label
\label{fig:1dalsi7_velocity_dt}
\end{figureth}
%--------------

Although no solidification has yet started at 100 s, a two-dimensional flow is observed around the interface, and tends to \SI{e-8}{\uvelocity} elsewhere in the ingot.
\Cref{fig:1dalsi7_velocity_dt} confirms that this flow is still predicted at smaller time steps. 
This flow seems like a pure numerical response
to the properties jump across the interface, namely density and dynamic viscosity. It is also noted that the interface position
is not modified by the neighbouring currents, that reach a maximum magnitude of \SI{e-4}{\uvelocity}. 
Therefore, the optimal time step for this simulation is set to 0.01 s, and we refer to it as case R, which stands for "real" air.

The fact that properties transition is crucial in the solution stability, is investigated by 2 reference cases, having equal properties 
(density and dynamic viscosity) but with different time steps, 0.01 (case A1) and 0.1 s (case A2), where "A" stands for artificial.
All simulation cases are grouped in \cref{table:1dalsi7_comparative_nomacro}.

%--------------------------------
\begin{table}[H]
\centering
\caption{Summary of the comparative shrinkage simulations without macrosegregation.}
\label{table:1dalsi7_comparative_nomacro}
{\tabulinesep=1.0mm \begin{tabu}{llll}
\tabucline[1pt]{-}
\textbf{Case} & \textbf{Air viscosity [\si{\uviscosity}]} & \textbf{Air density [\si{\udensity}]} & \textbf{Time step [s]} \\\tabucline[1pt]{-}
%-----------------------------
R			& \num{e-4}	&	\num{1.3}	&	0.01	\\
A1			& \num{e-3}	&	\num{2600}	&	0.01	\\
A2			& \num{e-3}	&	\num{2600}	&	0.1		\\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}
%--------------------------------

When the air domain is given the metal's properties, it becomes denser and more viscous by several orders of magnitude. 
\Cref{fig:1dalsi7_caseA1A2}, in which cases A1 and A2 are compared, shows no noticeable sign of velocity instability near the interface before 200 s.
It can be explained by the fact that the air behaves mechanically like a fluid metal given similar properties, 
therefore no steep transitions are computed at the interface. 
However, it is interesting to compare results of \cref{fig:1dalsi7_equalprops_smallstep1} and \cref{fig:1dalsi7_equalprops} at 600 s.
For case A1, the interface is slightly skewed due to slower flow at the left side of the interface, while for case A2, the flow disturbs
the interface deforming it until the end of solidification, as seen at 1000 s. This shows the importance of the chosen time step
in the Navier-Stokes solver. 

In contrast, \cref{fig:1dalsi7_differentprops} shows more viable results as far as the level set transport is concerned.
From 200 s to 800 s, the local flow instability (discussed earlier in \cref{fig:1dalsi7_velocity_dt}) is sustained, even until after solidification is complete.
However, in regions of 100\% metal and 100\% air the computed velocity is nearly the same order of magnitude as predicted for all three simulations.
Finally, in \cref{fig:1dalsi7_differentprops}, we notice a recirculating air flow in the vicinity of the interface as no metal shrinkage 
may further occur once solidification is complete, thus air flows freely in and out 
of the upper boundary with a very low magnitude ($\approx$ \SI{e-7}{\uvelocity}), while impinging on the metal-air surface.
Regarding the CPU times, cases A1 ran for 14 hours, case A2 took only 2 hours while case R ran for 23.3 hours.

To summarise, we can see conclude from the previous results, the following points:
\begin{enumerate}
	\itemsep0em 
	\item Greater differences in mechanical properties of fluids across the level set impose using smaller time steps,
	\item When real properties are used, smaller time steps are needed to capture the variations across the moving level set, hence inducing longer simulation time,
	\item In a situation where the flow dynamics in the non-metallic (gas) domain is not a primary objective, one can 
		   use artificial properties instead of the real values, hence gaining in computation time at the expense of the flow prediction accuracy.
\end{enumerate}  
%-----------------------------------------
\begin{figure}[htbp]
\centering
%======
  \begin{subfigure}{0.55\textwidth}
  \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/1d/ls_velocity_equalprops_1e-2.pdf}
	\caption{Case A1}
    \label{fig:1dalsi7_equalprops_smallstep1}
  \end{subfigure}  
%======
\vskip\baselineskip
%======
  \begin{subfigure}{0.55\textwidth}
    \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/1d/ls_velocity_equalprops.pdf}
	\caption{Case A2}
    \label{fig:1dalsi7_equalprops}
  \end{subfigure}
%======
\caption{Comparison of two simulations at several stages of solidification ending shortly after 800 s.
The results shows the influence of density and viscosity properties across the level set interface.
The plotted field is the average fluid velocity, on which the corresponding nodal vectors are superimposed, mainly pointing
downwards, i.e. towards the solidification front. The thick black line represents the zero isovalue of the distance function.
Properties are given in \cref{table:data_case_inverseseg,table:1dalsi7_meshsize,table:1dalsi7_comparative_nomacro}.}
\label{fig:1dalsi7_caseA1A2}
\end{figure}
%-----------------------------------------

%-----------------------------------------
\begin{figure}[htbp]
\centering
%======
  \begin{subfigure}{0.55\textwidth}
  \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/1d/ls_velocity_equalprops_1e-2.pdf}
	\caption{Case A1}
    \label{fig:1dalsi7_equalprops_smallstep2}
  \end{subfigure}  
%======
\vskip\baselineskip
%======
  \begin{subfigure}{0.55\textwidth}
    \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/1d/ls_velocity_differentprops.pdf}
	\caption{Case R}
    \label{fig:1dalsi7_differentprops}
  \end{subfigure}
%======
\caption{Comparison of two simulations at several stages of solidification ending shortly after 800 s.
The results shows the influence of density and viscosity properties across the level set interface.
The plotted field is the average fluid velocity, on which the corresponding nodal vectors are superimposed, pointing
towards the solidification front.
Properties are given in \cref{table:data_case_inverseseg,table:1dalsi7_meshsize,table:1dalsi7_comparative_nomacro}.}
\label{fig:1dalsi7_caseA1R}
\end{figure}
%-----------------------------------------


% ******************************************
\subsubsection{Mass conservation study}
% ******************************************

In order to get a better idea about the performance of our model, a mass conservation study is performed hereafter. 
We define the metal's mass as a function of the metal's average density and the Heaviside function relative to the 
metal domain, as follows:
%----------------
\begin{align}
\label{eq:metal_mass}
& m^M = \integral{\Ohm}{H^M \avg{\rho}^M}{\Ohm}	
\end{align}
%---------------
Then, the mass conservation can be monitored by processing \cref{eq:metal_mass} at each time step, and computing
the relative mass change by writing:
%----------------
\begin{align}
\label{eq:metal_mass_variation}
&  m^M_\% = \frac{m^M - m^M_0}{m^M_0} \times 100	
\end{align}
%---------------
The relative mass change gives us information on the level set transport.
As the current case is 1D and phase densities are constant throughout the simulation, mass conservation can be 
checked in a much simpler approach than by checking \cref{eq:metal_mass_variation}. Since we know the initial metal's column
length, $l^M_0$, and the expected solidification shrinkage is \SI{7.14}{\percent}, we should expect a final length of 
$l^M_f= \brac{1-\beta_{SS}} l^M_0 =$\SI{92.86}{\milli\metre}. 
% However, this equation is very useful and applicable in 2D and 3D
% cases of solidification shrinkage.
%--------------------------------------
\begin{figure}[htbp]
\centering
\begin{tikzpicture}
 \pgfkeys{%
    /pgf/number format/set thousands separator = {}}
%================================================
\begin{axis}
[	name=artificial,
	title=(a) Case A1,
	scale only axis,
	table/col sep=tab,
	enlarge x limits=false,
	legend pos=north west,
	scaled ticks=true,
	xlabel=Time (s),
	ylabel=$m^M_\%$ (\%),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,200,400,600,800,1000},
	ytick={-0.1,0,0.1,0.2},
	%x tick label style={rotate=45,anchor=east},
	width=0.4\textwidth,
	%height=5cm,	
	ymin=-0.1, ymax=0.2,
	mark repeat	= {30},
	cycle list name=mycycle, %exotic,
]
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/ArtificialDarcyBlocking0pct_smallstep.txt}; %\closedcycle; 
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/ArtificialDarcyBlocking25pct.txt}\closedcycle;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/ArtificialDarcyBlocking50pct.txt}\closedcycle;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/ArtificialDarcyBlocking99pct.txt}\closedcycle;
%\legend{Blocking at 0\% $\gl$, Blocking at 25\% $\gl$, Blocking at 50\% $\gl$, Blocking at 99\% $\gl$}
\end{axis}
%================================================
%\hfill
%================================================
\begin{axis}
[	name=real,
	title=(b) Case R,
	at=(artificial.right of south east), anchor=left of south west,
	scale only axis,
	%yticklabel pos=left,
	table/col sep=tab,
	enlarge x limits=false,
	legend pos=north west,
	scaled ticks=true,
	xlabel=Time (s),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,200,400,600,800,1000},
	ytick={-0.1,0,0.1,0.2},
	yticklabels={},
	%x tick label style={rotate=45,anchor=east},
	width=0.4\textwidth,
	%height=5cm,	
	ymin=-0.1, ymax=0.2,
	mark repeat	= {30},
	cycle list name=mycycle, %exotic,
]
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking0pct.txt}; %\closedcycle;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking25pct.txt}\closedcycle;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking50pct.txt}\closedcycle;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking99pct.txt}\closedcycle;
%\legend{Blocking at 0\% $\gl$, Blocking at 25\% $\gl$, Blocking at 50\% $\gl$, Blocking at 99\% $\gl$}
\end{axis}
\end{tikzpicture}
%================================================
\caption{Variation of the metal's mass versus solidification time in cases A1 and R.}
\label{fig:shrinkage_nomacro_massconserv}
\end{figure}
%--------------------------------------
In the previous section, we observed \emph{M-A} boundary instability problems taking place around 400 s of cooling, 
where the flow begins slightly losing it one-dimensional
shape. Although it was clearly seen in \cref{fig:1dalsi7_equalprops}, it applies
for both cases, whether air properties are equal to (cases A1 and A2) or different than (case R) the liquid's properties across the interface. 
The mass variation plots in \cref{fig:shrinkage_nomacro_massconserv} confirm these observations, since the metal's mass does not remain 
constant during simulations. Indeed, in both cases A1 and R, the mass variation curves shown in \cref{fig:shrinkage_nomacro_massconserv} reveal
a general behaviour of increase then decrease below zero. The increase corresponds to gain in metal mass.
Such gain is the result of a limited motion of the level set while the metal density is increasing and the latter needs to shrink even more.
The cause leading to the limited motion is not identified, no further testing was made.
On the other hand, the decrease corresponding to a mass loss can be attributed to the
contact between the mushy zone and the level set boundary. 
We showed in the introduction of this chapter that the \emph{M-A} boundary actually consists of several interfaces, 
and when the mushy zone overlaps with the level set mixing zone, we cannot track the boundary between the porous medium 
(described in \cref{fig:1dalsi7_interface_stages}), which induces concept errors.

In the light of these facts, we can try to limit as much as possible the motion of the porous medium boundaries, 
once the mushy zone has reached the level set mixing zone,
and test the influence on mass conservation.
To do so, we firstly advise to keep a very small thickness interface, in order to delay the previously explained overlap. Moreover, we deducing the 
transport velocity, used in the level set transport equation (\cref{eq:transport_weak1}), at each node as follows:
%--------
\begin{align}
\label{eq:}
\vec{v} =
\begin{cases}
  \vit		& \text{ if } g^l > g_{BL}^l \\
  0 		& \text{otherwise}
\end{cases}
\end{align}
%---------------
where $g_{BL}^l$ is the threshold for the liquid fraction, below which we consider that the interface should not be transported.

\Cref{fig:massconserv_blockingpct} shows the mass variation for three blocking fractions: 0, 50, 75 and 99 percent.
The first value corresponds the case where the Navier-Stokes solution is directly passed to the transport solver, 
corresponding to the previously presented result in \cref{fig:shrinkage_nomacro_massconserv}b.
For the last value, we consider that as soon as a portion of the \emph{M-A} boundary becomes
in contact with the low solid fraction part, the liquid in the mushy zone becomes immobile. 
It is clearly seen that the consequence on the mass conservation is not good, as 
the mass increases up to 3\% while the eutectic front is consuming the liquid within the mushy zone, and no further shrinkage is allowed.
We conclude that this strategy adds metal mass in the system, unlike the initial strategy with $g_{BL}^l=0\%$ that
removes mass.

%--------------------------------------
\begin{figure}[htbp]
\centering
\begin{tikzpicture}%[spy using outlines={draw, blue, magnification=2, connect spies}]
 \pgfkeys{%
    /pgf/number format/set thousands separator = {}}
%================================================
\begin{axis}
[	name=mass curves,
	%title= mass conservation,
	scale only axis,
	table/col sep=tab,
	enlarge x limits=false,
	legend pos=north west,
	scaled ticks=true,
	xlabel=Time (s),
	ylabel=$m^M_\%$ (\%),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,200,400,600,800,1000},
	%ytick={-0.1,0,0.1,0.2},
	%x tick label style={rotate=45,anchor=east},
	width=0.6\textwidth,
	%height=5cm,	
	%ymin=-0.1, ymax=0.2,
	mark repeat	= {30},
	cycle list name=mycycle, %exotic,
]
%\coordinate (pt) at (axis cs:500,0);
%\coordinate (posZoom) at (axis cs:100,0.5);
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking0pct.txt};% \closedcycle ;
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking50pct.txt};% \closedcycle ;
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking75pct.txt};% \closedcycle ;
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking99pct.txt};% \closedcycle ;
\legend{$g_{BL}^l=0\%$, $g_{BL}^l=50\%$, $g_{BL}^l=75\%$, $g_{BL}^l=99\%$}
%----
%\begin{scope}
%	\spy on (pt) in node at (posZoom);
%\end{scope}
\end{axis}
\end{tikzpicture}
\caption{Relative mass change versus time for different blocking fractions $g_{BL}^l$ in the transport solver.}
\label{fig:massconserv_blockingpct}
\end{figure}
%--------------------------------------
%================================================

\begin{figure}[htbp]
\centering
\begin{tikzpicture}%[spy using outlines={draw, blue, magnification=2, connect spies}]
 \pgfkeys{%
    /pgf/number format/set thousands separator = {}}
%================================================
\begin{axis}
[	name=mass curves,
	%title= mass conservation,
	scale only axis,
	table/col sep=tab,
	enlarge x limits=false,
	legend pos=north east,
	scaled ticks=true,
	xlabel=Time (s),
	ylabel=$m^M_\%$ (\%),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,200,400,600,800,1000},
	ytick={-0.1,0,0.1,0.2},
	%x tick label style={rotate=45,anchor=east},
	width=0.6\textwidth,
	%height=5cm,	
	%ymin=-0.1, ymax=0.2,
	mark repeat	= {30},
	cycle list name=mycycle, %exotic,
]
%\coordinate (pt) at (axis cs:500,0);
%\coordinate (posZoom) at (axis cs:100,0.5);
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking0pct.txt};% \closedcycle ;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking25pct.txt};% \closedcycle ;
\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking50pct.txt};% \closedcycle ;
%\addplot table [x=Temps, y=mMpct] {Chapter5/Data/1d_alsi7_mass/RealDarcyBlocking99pct.txt};% \closedcycle ;
\legend{$g_{BL}^l=0\%$, $g_{BL}^l=50\%$}
%----
%\begin{scope}
%	\spy on (pt) in node at (posZoom);
%\end{scope}
\end{axis}
\end{tikzpicture}
\caption{Relative mass change versus time only for 0\% and 50\% blocking fractions.}
\label{fig:massconserv_blockingpct2}
\end{figure}
%--------------------------------------
%================================================

In \cref{fig:massconserv_blockingpct2}, we plot again the same curves as in 
\cref{fig:massconserv_blockingpct}, but keeping the values of $g_{BL}^l$=0\% and $g_{BL}^l$=50\%. 
We notice that both values produce the same results until about 300 s. 
Then, when the mushy zone reaches the interface region, differences appear as a consequence
of the reduced transport for the higher blocking fraction. 
However, it should be pointed out that the differences between 300 s and 800 s are not important because 
the permeability predicted by the Carman-Kozeny model, falls to zero quickly for liquid fractions less than about 60\%. 

In the current application, it is not clear whether the idea of the blocking fraction is useful or not, 
since the feeding flow occurs in a single direction and solidification takes place far from the interface. 
Since the results obtained zero blocking fraction were better than with increasing values of $g_{BL}^l$,
further simulations will adopt this strategy.

% -------------------------------------------------
\subsection{Shrinkage with macrosegregation}
% -------------------------------------------------

In this section, we consider species conservation equation, in addition to energy conservation and fluid momentum conservation equations, 
studied in the previous section to predict solidification shrinkage.
The interesting point here is to study the formation of macrosegregation in a one-dimensional configuration and the effect of solidification shrinkage on it.
As shown in chapter 2, our approach to solve the energy equation relies on tabulations of various solidification paths. 
In this case, we will generate a simple tabulation based on a phase diagram
with linear liquidus and solidus lines, whose properties are reminded in \cref{table:1dalsi7_macro_diagram}.

%--------------------------------
\begin{table}[H]
\centering
\caption{Main properties of the linearised phase diagram for Al-Si alloys.}
\label{table:1dalsi7_macro_diagram}
{\tabulinesep=1.0mm \begin{tabu}{llll}
\tabucline[1pt]{-}
\textbf{Parameter} & \textbf{Symbol} & \textbf{Value} & \textbf{Unit} \\\tabucline[1pt]{-}
%-----------------------------
Nominal composition 	& $w_0$ 	& \num{7} 		& \si{\ucomposition} \\ 
Nominal liquidus temperature 	& $T_L$ 		& \num{618} 	& \si{\udegC} \\ 
Eutectic temperature 	& $T_E$ 		& \num{577}	 	& \si{\udegC} \\  
Segregation coefficient & $k$ 			& \num{0.13} 	& $-$  \\  
Liquidus slope 			& $m_L$ 		& \num{-6.5} 	& \si{\uslope}\\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}
%--------------------------------

Using the values from \cref{table:1dalsi7_macro_diagram}, a python program generates a \cimlib-compatible tabulation assuming lever rule as microsegregation law, 
with a \SI{0.1}{\ucomposition} step for average composition within an offset of 20\% around the nominal value, i.e.
29 composition values within the interval [5.6,8.4]\si{\ucomposition}Si.
For temperature, a range between $T_E$=\SI{577}{\udegC} and \SI{630}{\udegC} is considered with a step of \SI{1}{\udegC}, corresponding to 54 values. 
It is noted that for this application, the phase enthalpies are deduced from constant 
specific heat of each phase as well as constant latent heat, given in \cref{table:data_case_inverseseg}.

In order to understand better the effect of shrinkage combined with macrosegregation, we plot in \cref{fig:1dalsi7_macro_shrinkage},
the cooling curves from 4 different simulations: 
\begin{itemize}
\itemsep0em
\item \grey{Grey} curve - case G0: pure diffusion solidification with $\rhol=\rhos$ (no level set) used previously in chapter 2 for validation;
we use it as a reference case,
\item \green{Green} curve - case G: convection-diffusion solidification with $\rhol=\rhos$ (with level set) at a constant average composition
\item \blue{Blue} curve - case B: convection-diffusion solidification with $\rhol \neq \rhos$ (with level set) at a constant average composition; this curve is plotted in 
\cref{fig:shrinkage_effect} and \cref{fig:macro_effect},
\item \red{Red} curve - case R (not to be confused with case R defined in the previous section): 
convection-diffusion solidification with $\rhol \neq \rhos$ (with level set) and macrosegregation.
\end{itemize}

% *************************************************
\subsubsection{Shrinkage effect on temperature}
% *************************************************

If we focus first on \cref{fig:shrinkage_effect}, we first compare solidification cases G and G0, both with equal phase densities, hence no shrinkage.
This first comparison shows that the introduction of the level set method, compared to a monodomain configuration, heats up
the overall sample temperature by about \SI{4}{\udegC} (difference between green and grey curves), causing solidification to finish a few seconds later than predicted in case G0.
This is because we set a very high initial temperature in the air, \SI{800}{\udegC}, to prevent a brutal diffusive flux that may lead to surface solidification
in the metal. As the sample cools down, the air conductivity (\SI{e-2}{\uconductivity}) is not low enough to prevent a small diffusion flux in the metal's direction.
However, since in both cases the cooling trend is predicted, we will keep the same thermal diffusion properties in the air, so as not to use unreal conductivity values,
but we keep in mind that the current approach delays the solidification.

The second comparison is done between cases G and B, both using the level set approach but only case B considers solidification shrinkage.
We notice that blue curve temperature of the sixth 
Eulerian sensor rises steadily from 180 s to 600 s reaching a constant temperature of \SI{800}{\udegC}, the air's temperature. 
This rise confirms the metal has shrunk in length (volume in 3D),
becoming less than 10 cm, hence replaced by air that entered through the open top boundary.
The 6$\text{th}$ sensor (at 100 mm) was initially on the metal-air boundary, then later relocated in the air after shrinkage.
The sensors at 12 cm and 14 cm are not shown in this figure as the simulation done for the pure diffusion without level set, the air domain does not exist.

Another interesting difference resulting from shrinkage is that solidification ends sooner by about 70 s, compared to the pure diffusion case.
As mass is almost perfectly conserved in both cases, cooling flux is the only factor that may accelerate the cooling. The imposed cooling boundary condition
is a Fourier-type with the same heat transfer coefficient $\hext$ in both cases. However, a shrinkage flow transports energy in its direction, i.e. towards the solidification
front, and thus raising slightly the temperature in regions close to the cool wall. Therefore, the Fourier flux proportional to the local temperature
increase and the sample solidifies earlier. 

%\subsubsection{Solidification shrinkage with macrosegregation effect on temperature}
Finally, \cref{fig:macro_effect} compares cases B and R, both with unequal phase densities but also predicting macrosegregation in the latter case. 
Differences are not striking, as temperatures along the metal sample are the same. 
% We spot however a difference at the 10 cm probe, 
% where a slight rise in temperature is observed with respect to the case without macrosegregation.

%-----------------
\begin{figure}[htbp]
\centering
   %------------
  \begin{subfigure}[t]{0.8\textwidth}
    \centering
	\includegraphics[width=\textwidth]{Chapter5/Data/1d_alsi7_cc/shrinkage_effect.pdf}
	\caption{Solidification shrinkage effect: grey curves correspond to a pure diffusion in a metal monodomain case,
			 \green{green} curves consider the latter case but with level set (metal and air domains) while \blue{blue} curves 
			 correspond to a shrinkage-driven flow case. All cases are solved without macrosegregation.}
    \label{fig:shrinkage_effect}
  \end{subfigure}
  %------------------------------
  \vskip\baselineskip
  %------------------------------
  \begin{subfigure}[t]{0.8\textwidth}
    \centering
	\includegraphics[width=\textwidth]{Chapter5/Data/1d_alsi7_cc/macro_effect.pdf}
	\caption{Macrosegregation effect: \blue{blue} curves represent the same simulation corresponding to the shrinkage-driven flow without macrosegregation, while
	the \red{red} curves correspond to a simulation of shrinkage-driven flow with macrosegregation.}
    \label{fig:macro_effect}
  \end{subfigure}
   %------------
\caption{Cooling curves at different fixed positions from 0 to 14 cm. 
where we show (a) the effect of solidification shrinkage on temperature history without any macrosegregation and
show (b) the effect of macrosegregation on temperature in the presence of solidification shrinkage.
Initial \emph{M-A} boundary: 10 cm.} 
\label{fig:1dalsi7_macro_shrinkage}
\end{figure}
%------------------


% ------------------------------------------------------------
\subsubsection{Shrinkage effect on average composition}
% ------------------------------------------------------------

In this section, we shall test the strategies regarding modelling the species conservation in a level set context.
Therefore, we summarise in \cref{table:simulation_strategy} the approaches along with the most important values.

%--------------------------------
\begin{table}[H]
\centering
\caption{Summary of simulation configurations that are performed showing the different modelling strategies to account for metallic species transport
in the air domain: monolithic strategy with low species diffusion in the air (MD), monolithic strategy with low species diffusion and advection in the air (MDA)
and non monolithic strategy with composition reinitialisation in the air (NM).}
\label{table:simulation_strategy}
\resizebox{\columnwidth}{!}{%
{\tabulinesep=1.0mm \begin{tabu}{lccc}
\tabucline[1pt]{-}
\textbf{Configuration} & \textbf{Diffusion in air [\si{\udiffusivity}]} & 
\textbf{Advection in air [\si{\uvelocity}]} & \textbf{Composition reinitialisation} \\\tabucline[1pt]{-}
%-----------------------------
MD	&	\num{1.5e-12} &  $\vitf$  	&  -	\\ 
MDA	&	\num{1.5e-12} &  $\vec{0}$  &  -	\\ 
NM	&	 $\Dl$ 		  &  $\vitf$  &  $\mix{\avg{w}} = \heavisideM \avg{w}^M + \heavisideA \avg{w_0}^M $	 \\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
}
\end{table}
%--------------------------------

\Cref{fig:1dalsi7_gs_w} shows snapshots at different times of the shrinkage flow from a MD simulation, caused by the density difference between liquid and solid phases.
By solid phases, we mean the primary solid phase assumed as a dendritic structure, then the primary and secondary solid phases forming together the eutectic
that we see starting at 150 s in \cref{fig:1dalsi7_gs_w}. 
We can see that almost no solute segregation has yet taken place in the mushy zone at 100 s.
Then at 150 s, the average composition reaches a positive peak of $\avg{w}$=\bin{Al}{7.4}{Si} at the closest nodes to the chill. 
This is triggered by the progression of the eutectic front.
The sudden transformation of the remaining liquid in the mushy zone into eutectic solid, triggers a local velocity increase (real intrinsic velocity).
This is made possible neat the eutectic temperature ($T_E$) where density varies abruptly from $\avg{\rho}^M=g^E \rhol + (1-g^E) \rhos$ to $\rhos$ 
in a single time step, $g^E$ being the volume fraction of eutectic. 

The velocity increase causes species transport in the opposite direction of solidification,
hence solute "freezes" in the eutectic structure leading to positive macrosegregation
in the first solidified nodes. This phenomenon is better known as inverse segregation. 
As the transport continues in the same direction, 
solute is progressively depleted in the remaining liquid, causing negative macrosegregation at nodes located between 2 cm and 7 cm from the chill.

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/1d/macro/gs_w.pdf}
% caption
{Zoom on the lower part, approximately 0.5 cm of the alloy close to the cooling boundary condition. 
The upper row of figures shows the evolution of volume fraction of solid, when eutectic transformation takes place. 
The vectors represent the direction of the average velocity field, with a length proportional
to the magnitude. The lower row of figures shows for the same time increments, the solute redistribution, 
clearly changing behind the eutectic front.}
% label
\label{fig:1dalsi7_gs_w}
\end{figureth}
%--------------

\Cref{fig:1dalsi7_gs_w} shows only the first 1.5 cm of the solidifying sample, 
therefore a complete segregation profile is plotted along the sample length in \cref{fig:1dalsi7_wVSlength}.
Three curves are plotted in the latter figure: the first curve, \cref{fig:1dalsi7_wVSlength}a, uses the monolithic species conservation (\cref{sec:monolithic_species})
with limited diffusion in the air, the second curve \cref{fig:1dalsi7_wVSlength}b employs the same strategy but with both limited diffusion and advection in the air, and
finally \cref{fig:1dalsi7_wVSlength}c is given by the non monolithic strategy for species conservation.
We look first at \cref{fig:1dalsi7_wVSlength}a showing the negative macrosegregation between 2 cm and 7 cm from the chill, as previously explained.
However, from 7 cm to the \emph{M-A} boundary, the average composition rises.
This tendency was also found by \citet{niane_etude_2004}. It corresponds to the liquid freezing due to the eutectic reaction, with no solute feeding in the mushy zone, 
near the end of solidification, i.e. when the mushy zone has reached the \emph{M-A} boundary.
% This looks more like a numerical instability than a physical rise in concentration. \
Also, an unexpected composition profile is seen surrounding this boundary. 
By comparing with \cref{fig:1dalsi7_wVSlength}b, where the input velocity field is set to zero in the air domain before solving the monolithic species conservation equation,
resulting in limited species transport in the air as well as within the \emph{M-A} boundary vicinity. The numerical anomaly seen in the previous composition plot is reduced.
This comparison confirms the fact that macrosegregation is mainly promoted by advective transport rather than diffusion, and therefore controlling the velocity field in the air greatly reduced the sharp
composition decrease in the boundary vicinity.

The last plot, \cref{fig:1dalsi7_wVSlength}c, shows the segregation result obtained by the non monolithic strategy presented previously to solve the species conservation equations
in the air and the metal. Two comments can be made on the latter result: first, the concentration \emph{valley} effect surrounding the \emph{M-A} boundary seen in 
\cref{fig:1dalsi7_wVSlength}b has shrunk even more, and is now restricted to a very small thickness spanning on one or two elements around the boundary.
On the air side, the decreasing composition trend has also disappeared, and is now replaced by a sharp transition, as an effect of the explicit reinitialisation of 
the composition solution. The second comment is about the instability amplitude: it is still better than the first result (\cref{fig:1dalsi7_wVSlength}a) 
but worse than the second result (\cref{fig:1dalsi7_wVSlength}b).

To conclude on the effect of shrinkage on macrosegregation, we may say that the non monolithic gives the best compromise in terms of composition solution
quality. We may also conclude that the mesh should remain fine around the level set boundary, in order to prevent any composition instability from spanning
on larger distances and destabilising the computation.

%--------------------------------------
\shorthandoff{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy
\begin{figure}[htbp]
\centering
%-------
\begin{tikzpicture}%[spy using outlines={rectangle, magnification=3, width=1cm, height=6cm, connect spies}]
%[spy using outlines={circle, magnification=3, connect spies}]
  \begin{axis}
  [	name=one,
	title= (a) Monolithic with low diffusion,
	%at=(one.right of south east), anchor=left of south west,
	scale only axis,
	table/col sep=comma,  % comma % tab
	enlarge x limits=false,
	%legend pos=north east,
	scaled ticks=true,
	%xlabel=Sample length (m),
	ylabel=$\mix{\avg{w}}$ (wt.\% Si),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,0.02,...,0.14},
	xticklabels={},
	ytick={6.5,7,7.5},
	%x tick label style={rotate=45,anchor=east},
	width=0.9\textwidth,
	height=5cm,	
	ymin=6.45, ymax=7.55,
	%xmax=0.0928,
	mark repeat	= {142},
	cycle list name=nodotscycle, %exotic,
]
	\coordinate (spypoint) at (0.002,7.25);
	\coordinate (magnifyglass) at (0.06,7.3);
	\addplot table [x=arc_length, y=Concentration] {Chapter5/Data/1d_alsi7_composition/ModifyDiffSoluteAir.csv}; %\closedcycle ;
	%\addplot[thick, samples=50, smooth,magenta, name path=ls] coordinates {(0.09268,\pgfkeysvalueof{/pgfplots/ymin})(0.09268,\pgfkeysvalueof{/pgfplots/ymax})};
	\draw[thick, magenta,  opacity=0.5] (axis cs:0.0926,\pgfkeysvalueof{/pgfplots/ymin}) -- (axis cs:0.0926,\pgfkeysvalueof{/pgfplots/ymax});
	\draw[thick, dashed, black, opacity=0.5] (axis cs:\pgfkeysvalueof{/pgfplots/xmin},7) -- (axis cs:\pgfkeysvalueof{/pgfplots/xmax},7);
  	\end{axis}
%-------------------
 \begin{axis}
  [	name=two,
	title= (b) Monolithic with low diffusion and advection,
	at=(one.below south west), anchor=above north west,
	scale only axis,
	table/col sep=comma,  % comma % tab
	enlarge x limits=false,
	%legend pos=north east,
	scaled ticks=true,
	%xlabel=Sample length (m),
	ylabel=$\mix{\avg{w}}$ (wt.\% Si),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,0.02,...,0.14},
	xticklabels={},
	ytick={6.5,7,7.5},
	%x tick label style={rotate=45,anchor=east},
	width=0.9\textwidth,
	height=5cm,	
	ymin=6.45, ymax=7.55,
	%xmax=0.0928,
	mark repeat	= {142},
	mark=none,
	cycle list name=nodotscycle, %exotic,
]
	\addplot table [x=arc_length, y=Concentration] {Chapter5/Data/1d_alsi7_composition/ModifyVitLiq.csv}; %\closedcycle ;
	%\addplot[thick, samples=50, smooth,magenta, name path=ls] coordinates {(0.09268,\pgfkeysvalueof{/pgfplots/ymin})(0.09268,\pgfkeysvalueof{/pgfplots/ymax})};
	\draw[thick, magenta,  opacity=0.5] (axis cs:0.0926,\pgfkeysvalueof{/pgfplots/ymin}) -- (axis cs:0.0926,\pgfkeysvalueof{/pgfplots/ymax});
	\draw[thick, dashed, black, opacity=0.5] (axis cs:\pgfkeysvalueof{/pgfplots/xmin},7) -- (axis cs:\pgfkeysvalueof{/pgfplots/xmax},7);
  	\end{axis}
%-------------------
 \begin{axis}
  [	name=three,
	title= (c) Non monolithic,
	at=(two.below south west), anchor=above north west,
	scale only axis,
	table/col sep=comma,  % comma % tab
	enlarge x limits=false,
	%legend pos=north east,
	scaled ticks=true,
	xlabel=Distance from chill (m),
	ylabel=$\mix{\avg{w}}$ (wt.\% Si),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,0.02,0.04,0.06,0.08,0.1,0.12,0.14},
	xticklabels={0,0.02,0.04,0.06,0.08,0.1,0.12,0.14},
	ytick={6.5,7,7.5},
	%x tick label style={rotate=45,anchor=east},
	width=0.9\textwidth,
	height=5cm,	
	ymin=6.45, ymax=7.55,
	%xmax=0.0928,
	mark repeat	= {142},
	cycle list name=nodotscycle, %exotic,
]
	\addplot table [x=arc_length, y=Concentration] {Chapter5/Data/1d_alsi7_composition/NewSolute.csv}; %\closedcycle ;
	%\addplot table [x=arc_length, y=Concentration] {Chapter5/Data/1d_alsi7_composition/ModifyVitLiq_ModifyDiffSoluteAir_NoSolute.csv}; %\closedcycle ;
	%\addplot[thick, samples=50, smooth,magenta, name path=ls] coordinates {(0.09268,\pgfkeysvalueof{/pgfplots/ymin})(0.09268,\pgfkeysvalueof{/pgfplots/ymax})};
	\draw[thick, magenta,  opacity=0.5] (axis cs:0.0926,\pgfkeysvalueof{/pgfplots/ymin}) -- (axis cs:0.0926,\pgfkeysvalueof{/pgfplots/ymax});
	\draw[thick, dashed, black, opacity=0.5] (axis cs:\pgfkeysvalueof{/pgfplots/xmin},7) -- (axis cs:\pgfkeysvalueof{/pgfplots/xmax},7);
  	\end{axis}
%\spy [black] on (spypoint) in node[fill=white] at (magnifyglass);  
\end{tikzpicture}
%-------
\caption{Plot of the average composition as function of length, along a vertical line passing through the centre of the sample at 1000 s, while
			varying the modelling strategy to account for species conservation in the air by considering  
		(a) the MD configuration % (minimum composition reaches \SI{2.2}{\ucomposition} Si but not shown), 
		(b) the MDA configuration 
		(c) the NM configuration.
		These configurations are defined in \cref{table:simulation_strategy}.
		The solid magenta line shows the position of the interface after solidification 
		while the black dashed line shows the nominal average composition of the alloy.}
\label{fig:1dalsi7_wVSlength}
\end{figure}
%--------------------------------------
\shorthandon{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy


% The plots in \cref{fig:1dalsi7_wVSlength} give important information on the segregation shown in  \cref{fig:1dalsi7_gs_w}.
We continue our analysis on the link between macrosegregation and solidification shrinkage by plotting in \cref{fig:MD_subplots} important 
quantities at different times of the simulation corresponding to the MD strategy.

The first column in \cref{fig:MD_subplots} shows the evolution of the average composition in the metal+air system 
(same plot as in \cref{fig:1dalsi7_wVSlength}a), as well as the solid (primary and eutectic) and liquid phase compositions. 
At 200 s, classic segregation takes place governed by the alloy properties defined in \cref{table:1dalsi7_macro_diagram},
where we can see that the eutectic had already reached almost 0.6 cm from the chill (as previously seen in \cref{fig:1dalsi7_gs_w}), 
forcing the liquid composition to drop to zero locally.
Later at 600 s, the mushy zone reaches the \emph{M-A} boundary, causing the instability to begin. This instability is identified by
a decrease in average composition, forming the \emph{valley} effect. Shortly before solidification ends at 800 s, the instability had
already reached its minimum peak, due to neglecting to porous medium boundaries. 

The second column in \cref{fig:MD_subplots} shows mixed average density plots during solidification. From 200 s to 600 s, we can identify
the extent of the mushy zone, as previously discussed for the phase compositions. We assume that the primary and eutectic solids have the same phase density, $\rhos$.
The density graphs show only values in the interval [2550, 2850] \si{\udensity}, and therefore we cannot see that in the air domain, the mixed average density
drops to $\rhoa$. 

Finally, the third column of \cref{fig:MD_subplots} describes the temporal evolution of mixed fluid velocity solutions, namely the average fluid velocity, $\vitf$,
and the intrinsic average fluid velocity, $\vec{\avg{v}^F}$. At 200 s, we see that the suction effect created by the density change in the mushy zone creates a
unidirectional flow of constant velocity, in both the liquid and air, with a magnitude of about \SI{0.9e-5}{\uvelocity}. At the \emph{M-A} boundary, we see a velocity
jump caused by the ratio of metal density to air density. Closer to the chill, we can distinguish average and intrinsic velocity profiles in the mushy zone. The latter decreases
more slowly than the former and showing a slight sharp increase in magnitude (not very visible on the plot) when at the intersection between the mushy zone and the eutectic front.
In previous solidification shrinkage studies carried by \citet{niane_etude_2004}, the author showed a similar effect caused by the instantaneous eutectic solidification of the remaining
liquid. However in our simulations, this effect is less prominent, possibly because of the mesh size 	. 
Later from to 600 s to 800 s, we notice a relatively turbulent flow in the air, compared to its behaviour in the remaining liquid. Another remarkable phenomenon, is the 
increase in velocity magnitude, almost a hundred times after solidification is finished. We may see this as a numerical response to the modelled physics, which vary
before and after solidification.  

At this stage, it is interesting to conduct the same investigation done for \cref{fig:MD_subplots} 
but changing the species resolution strategy to NM, whose results are plotted
in \cref{fig:NM_subplots}. We have already seen the difference in the average composition plot, which is the same in \cref{fig:1dalsi7_wVSlength}c.	However, the liquid composition shows a peak value when meeting the \emph{M-A} boundary at 800 s. 
The mixed density does not show noticeable differences, as the predicted phase fractions are the same, regardless of the species resolution strategy. 
The last column in \cref{fig:NM_subplots} shows a much better flow behaviour compared to the results seen in \cref{fig:MD_subplots}.
The velocity plots show also lower magnitudes than the MD strategy plots, while still predict a more prominent effect of 
local intrinsic velocity increase near the eutectic front at 200 s.

%=====================================BIG LANDSCAPE FIGURE  -- MD PLOTS =====================================
\begin{landscape}
\begin{figureth}
% textwidth 
{1.5}
%path 
{Chapter5/Data/1d_alsi7_arc_compositions/MD_subplots.pdf}
% caption
{Group of plots where each row is a given time increment (t=200 s, t=600 s and t=800 s) of the 1D solidification shrinkage simulation with macrosegregation
applying the \textbf{MD strategy}  (\cref{fig:1dalsi7_wVSlength}a). 
Physical quantities are plotted along a line passing through the centre of the sample and parallel to the gravity vector.}
% label
\label{fig:MD_subplots}
\end{figureth}
\end{landscape}
%=====================================BIG LANDSCAPE FIGURE -- MD PLOTS =====================================

%=====================================BIG LANDSCAPE FIGURE -- MDA PLOTS =====================================
\begin{landscape}
\begin{figureth}
% textwidth 
{1.5}
%path 
{Chapter5/Data/1d_alsi7_arc_compositions/MDA_subplots.pdf}
% caption
{Group of plots where each row is a given time increment (t=200 s, t=600 s and t=800 s) of the 1D solidification shrinkage simulation with macrosegregation
applying the \textbf{MDA strategy} (\cref{fig:1dalsi7_wVSlength}b).
Physical quantities are plotted along a line passing through the centre of the sample and parallel to the gravity vector.}
% label
\label{fig:MDA_subplots}
\end{figureth}
\end{landscape}
%=====================================BIG LANDSCAPE FIGURE  -- MDA PLOTS =====================================

%=====================================BIG LANDSCAPE FIGURE -- NM PLOTS =====================================
\begin{landscape}
\begin{figureth}
% textwidth 
{1.5}
%path 
{Chapter5/Data/1d_alsi7_arc_compositions/NM_subplots.pdf}
% caption
{Group of plots where each row is a given time increment (t=200 s, t=600 s and t=800 s) of the 1D solidification shrinkage simulation with macrosegregation
applying the \textbf{NM strategy} (\cref{fig:1dalsi7_wVSlength}c).
Physical quantities are plotted along a line passing through the centre of the sample and parallel to the gravity vector.}
% label
\label{fig:NM_subplots}
\end{figureth}
\end{landscape}
%=====================================BIG LANDSCAPE FIGURE  -- NM PLOTS =====================================



% **********************************************
\subsubsection{Solute mass conservation}
% **********************************************

The mass conservation for the metal and the metallic species is discussed in this section.
\Cref{fig:mass_species_alsi7} shows the relative mass variation of the metal and the silicon species
for each of the previously defined and used modelling strategies.
The solute mass variation is computed, similarly to the metal (\cref{eq:metal_mass_variation}), as follows:
%----------------
\begin{align}
\label{eq:solute_mass_variation}
&  m^\text{sp}_\% = \frac{m^\text{sp} - m^\text{sp}_0}{m^\text{sp}_0} \times 100	
\end{align}
% ---------------
where $m^\text{sp}_0$ is the initial solute mass (``sp'' stands for species, silicon in this case), knowing that
$m^\text{sp}$ is computed using the average composition as follows:
%----------------
\begin{align}
\label{eq:solute_mass_initial}
&  m^\text{sp} = \integral{\Ohm}{\heavisideM \mix{\avg{w}} \avg{\rho}^M }{\Ohm}
\end{align}
% ---------------

It is important to analyse the metal mass variation together with the species mass variation
because a gain or loss in the metal's mass is directly reflected on the mass of the metallic species.
However, the latter may also be subject to variations depending on the configuration of the simulation:
resolution technique, time step, boundary conditions ...
In our case, we first compared the mass conservation for the metal with all three methods for species conservation:
MD (monolithic with low diffusion), MDA (monolithic with low diffusion and advection) and last NM (non monolithic).
We cannot see a noticeable difference when comparing mass analysis for all three techniques, 
as shown by the dotted lines in \cref{fig:mass_species_alsi7}.
This conclusion goes for both the metal and its species. 
Nevertheless, we see the main behaviour discussed earlier in \cref{fig:shrinkage_nomacro_massconserv} regarding the increase then decrease of the 
metal mass. As for the chemical species, mass loss is due to 2 causes mainly: the species mass is computed from the volume of the metal,
and therefore any changes in the metal volume are directly reflected on metallic species. The other cause is the species resolution
equation which gradually loses mass of species during the simulation, possibly leading to negative composition
in some cases. The solute rise observed in the same figure (\cref{fig:shrinkage_nomacro_massconserv}) for all three strategies
is the result of taking into account some solute in the air which may slightly transported from the air into the metal.
We may think of a competition between the species mass increase due a damped level set motion and a species mass decrease
due to the previously explained reason.
% the MD and MDA plots display some agreement, 
% while the NM curves have the same variations trends but with values shifted down to $\approx$ 0.1\%.
% Concerning the slight difference various species resolution strategies, it should be explained.
% The metal mass variation is a direct consequence of volume variation due to level motion as a response to average density changes.
Changing the species resolution strategy affects only the area surrounding the \emph{M-A} boundary (as earlier seen in 
\cref{fig:1dalsi7_wVSlength}) and thus the predicted average composition varies. The latter variation impacts the phase fractions,
namely the liquid, which is an input of the fluid fraction used to evaluate the transport velocity in Navier-Stokes.
The predicted transport velocities in \cref{fig:MD_subplots,fig:MDA_subplots,fig:NM_subplots} show that the flow reaches high
magnitude during solidification time (from 200 s to 800 s) thus causing the level set to temporarily lose stability before
solidification ends. However, \cref{fig:NM_subplots} shows that the least velocity instability 
is obtained with the NM strategy, while maintaining an acceptable mass conservation for species, as shown in \cref{fig:mass_species_alsi7}.
Therefore, this strategy is applied for the 2D and 3D application cases.

%--------------------------------------
\shorthandoff{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy
\begin{figure}[htbp]
\centering
%-------
\begin{tikzpicture}
%-------------------
 \begin{axis}
  [	name=whatever,
	%title= (c),
	scale only axis,
	table/col sep=tab,  % comma % tab
	enlarge x limits=false,
	%legend pos=north east,
	scaled ticks=true,
	ylabel style={align=center},
	ylabel=  Relative mass change (\%), %Relative mesosegregation,
	xlabel=Time (s),
	%xticklabel style={/pgf/number format/fixed},
	yticklabel style={/pgf/number format/fixed},
	xtick={0,100,...,1000},
	xticklabels={0,100,...,1000},
	ytick={-1,-0.5,...,1},
	yticklabels={-1,-0.5,...,1},
	width=0.75\textwidth,
	% height=8cm,	
	ymin=-1.5, ymax=1.5,
	xmin=0, xmax=1000,
	mark repeat	= {50},
	cycle list name=masscycle,
	% axis y line*=left,
	legend cell align=left,
]
  \addplot table [x=Temps, y=mMpct]   			{Chapter5/Data/1d_species_mass_analysis/species_mass_data_MD.txt};
  \addplot table [x=Temps, y=msoluteM_pct]  	{Chapter5/Data/1d_species_mass_analysis/species_mass_data_MD.txt};
  \addplot table [x=Temps, y=mMpct]   			{Chapter5/Data/1d_species_mass_analysis/species_mass_data_MDA.txt};
  \addplot table [x=Temps, y=msoluteM_pct]  	{Chapter5/Data/1d_species_mass_analysis/species_mass_data_MDA.txt};
  \addplot table [x=Temps, y expr=\thisrow{mMpct}+0.5]   {Chapter5/Data/1d_species_mass_analysis/species_mass_data_NM.txt};
  \addplot table [x=Temps, y expr=\thisrow{msoluteM_pct}+0.5]  	{Chapter5/Data/1d_species_mass_analysis/species_mass_data_NM.txt};
  
  \legend{MD-metal mass,MD-species mass,MDA-metal mass,MDA-species mass,NM-metal mass,NM-species mass}  	
  
  \end{axis}
  	%------------------
\end{tikzpicture}
%-------
\caption{Mass variation plots for the metal and its chemical species, considering three different strategies to account for the species conservation in the air domain.}
\label{fig:mass_species_alsi7}
\end{figure}
%--------------------------------------
\shorthandon{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy

\newpage

% **********************************************************************
\section{2D application: controlled solidification benchmark}
% **********************************************************************
In this application, we aim at predicting macrosegregation produced by liquid convection, in the presence of solidification shrinkage.
The simulation is the same performed in \cref{sec:tsolver_validation} but now the level set approach is added.
The importance of the experiment lies in the 
thermal convection forces arising from temperature gradients, but also solutal buoyancy forces arising from liquid concentration gradients. The final macrosegregation pattern
strongly depends on density variations caused by each chemical species, but also on the experimental conditions like the lateral thermal gradients as well the cooling rate. \Cref{fig:smacs_exp} shows this effect on the final grain structure along with the free surface deformation
at the top as a result of density variations.
\citet{hebditch_observations_1974} suggested one of the first experiments working on Sn-Zn and Sn-Pb alloys. 
More recently, an experimental benchmark was performed by \citet{hachani_experimental_2012} to obtain more accurate 
composition results with various Sn-Pb and Pb-Sn alloys. In the current section, we are interested in the latter experiment with \bin{Sn}{3}{Pb} especially in the prediction
of the metal's shrunk surface together with the final macrosegregation.

%--------------
\begin{figureth}
% textwidth 
{0.6}
%path 
{Chapter5/Graphics/2d/smacs_exp_grains.png}
% caption
{Final ingot shape with grain structure at mid-width obtained experimentally by solidifying a \bin{Sn}{3}{Pb} alloy \citep{carozzani_direct_2013}.}
% label
\label{fig:smacs_exp}
\end{figureth}
%--------------

% ********************************************
\subsection{Computational configuration}
% ********************************************

% -------------------------------------------
\subsubsection{Mesh and adaptive remeshing}
% -------------------------------------------

% The case considers a 2D geometry having equivalent dimensions to the 3D case performed earlier (sample of 10 cm in length and 6 cm in height).
To accommodate the air domain, an extra 2 cm are added to sample's height, which finally reaches 8 cm, thus the interface has an initial elevation of 6 cm. 
The initial mesh consists of three different mesh sizes: isotropic elements in the air and the metal, having respectively a uniform size of 2 mm and 1 mm.
Regarding the interface, an anisotropic mesh adapts to the \emph{M-A} boundary with a mesh size of 0.1 mm in the normal direction to the interface.
The thickness of the anisotropic mesh spans 0.5 mm from each side of the interface, hence ensuring an initial resolution of almost 10 elements in the interfacial transition zone.

To adapt the mesh during convection and subsequent solidification, we use the \emph{Remesh4} adaptive technique to maintain accurate predictions for velocity and interface transport.
After performing some tests, it has been concluded that the remeshing
frequency should vary depending on the convection regime which pilots the flow velocity.
For this simulation, we adopted a frequent adaptation in the high convection regime
then later we reduce the pace by a factor of 5 for low convection. The remeshing frequency values are included in \cref{table:smacs_meshsize}. 
Regarding the transition between high and low convection regimes, we did not conduct detailed analysis using 
known non-dimensional numbers (e.g. Reynolds number), but rather rely on direct inspection of the results while changing the remeshing frequency
to check if they are satisfactory. We chose 2800 s as an optimal transition time between these high and low convection regimes.

However as solidification proceeds, we also need to keep a relatively small mesh size in regions with noticeable composition gradients.
Although possible to achieve with the \emph{Remesh4} technique, it is still difficult to maintain a fine mesh size throughout the metal, especially in areas
where solidification is almost complete and where the velocity field has a low magnitude. These areas are interesting as they represent potential
sites where segregated channels may form. If a low mesh size is not maintained, these channels may numerically disappear. 

To avoid such unwanted effects, we use another uniform
isotropic grid, named \emph{grid B}, having a constant mesh size of 0.3 mm, that is a good compromise between the finer interface elements and the coarser air low-velocity elements
in the original adapted, named \emph{grid A}.
These grids are shown in \cref{fig:smacs_grids}.
The strategy consists of scanning the liquid fraction of each node in \emph{grid A}, if its value is located between 30\% and 70\%, then we consider that 
region of interest, since the flow velocity is still not zero and a relatively fine mesh is locally obtained. 
We consequently transport the average composition field exclusively 
for these nodes from \emph{grid A} to \emph{grid B}, keeping for all other nodes their respective average composition values.
It should be noted that this transport is only one-way, hence no information feedback from \emph{grid B} to \emph{grid A}.
%--------------------------------
\begin{table}[H]
\centering
\caption{Summary of the mesh parameters used to generate an adaptive mesh.
Refer to \cref{sec:remesh4_params} for the definition of each mesh parameter.}
\label{table:smacs_meshsize}
{\tabulinesep=1.0mm \begin{tabu}{ll}
\tabucline[1pt]{-}
\textbf{Mesh parameter} & \textbf{Value} \\\tabucline[1pt]{-}
%-----------------------------
$\varepsilon $      & \SI{5e-4}{\metre} \\
$h_\text{min}$      &    \SI{e-5}{\metre} \\
Remeshing frequency   & 0.2 s (t $\leq$ 3000 s) \\
            & 1 s   (t > 3000 s)  \\
$\varepsilon_\text{er.}$  &  500         \\
Remeshing criteria    &   $\norm{\vitf}$, $\vitf _x$, $\vitf_y$, $\levelset$, $\gf$\\
Number of nodes   (\emph{Grid A})   &   $\approx$ \num{e4} \\ 
Number of elements  (\emph{Grid A})   &   $\approx$ \num{2e4} \\
%-------------------------------------------------------------------
Number of nodes   (\emph{Grid B})   &   $\approx$ \num{e5} \\ 
Number of elements  (\emph{Grid B})   &   $\approx$ \num{2e5} \\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}
%--------------------------------

%-----------------
\begin{figure}[H]
\centering
   %------------
  \begin{subfigure}[t]{0.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/GridAinit.png}
    \caption{\emph{Grid A} (initial)}
    \label{fig:gridAinit}
  \end{subfigure}
  %------------------------------
  \begin{subfigure}[t]{0.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/GridA.png}
    \caption{\emph{Grid A}}
    \label{fig:gridA}
  \end{subfigure}
  %------------------------------
  \begin{subfigure}[t]{0.3\textwidth}
    \centering
    \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/GridB.png}
    \caption{\emph{Grid B}}
    \label{fig:gridB}
  \end{subfigure}
   %------------
\caption{Snapshots of (a) the initial adaptive anisotropic \emph{grid A} then (b) the same grid but at 
a given time increment with (c) the corresponding fixed isotropic \emph{grid B} at the same time increment, 
used to record the average composition for $\gs>0.7$.}
\label{fig:smacs_grids}
\end{figure}
%------------------



% -----------------------------------------------
\subsubsection{Initial and boundary conditions}
% -----------------------------------------------

The air initial temperature is set the same as the initial liquid. This is only a hypothesis to prevent steep temperature gradients at the interface,
which may lead to surface solidification. The initial and boundary thermal conditions used to cool down the metal are defined in chapter 4, given by the experimental
data of \citet{hachani_experimental_2012}. For the mechanical properties, the top wall allows free inflow/outflow of the air in all directions 
at an imposed atmospheric pressure. This allows the air to follow any volume changes in the metal upon solidifying and shrinking. 
The geometry and boundary conditions are given in \cref{fig:smacs_geobc}.
Regarding the species conservation in the presence of the level set, the non monolithic strategy proved to be good in limiting the 
composition instability surrounding the \emph{M-A} boundary, and hence it will be used for this 2D simulation.
All simulation related parameters are shown in \cref{table:data_case_smacs}.
% The side walls adjacent to the heat exchangers are given a free tangential slip boundary condition but with a zero normal velocity, which lets the transported 
% level set function move vertically without being attached to the sides. Finally, a no-slip condition applies to the bottom wall. 

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/2d/geobc.pdf}
% caption
{Computational configuration for the 2D inverse segregation case showing the domain geometry 
with the applied boundary conditions to it as well as the gravity vector.
The pressure of top boundary is imposed to atmospheric pressure. The left heat exchanger (LHE)
and right heat exchanger (RHE) temperatures are given in \citep{hachani_experimental_2012}.}
% label
\label{fig:smacs_geobc}
\end{figureth}
%--------------

%------------------------
\begin{tabulate}
% caption 
{Parameters for the 2D simulation of the solidification benchmark \citep{hachani_experimental_2012,carozzani_direct_2013}.}
% label
{table:data_case_smacs}
% line separation (e.g. 1.5mm)
{1.0mm}
% column justification-number (e.g. |c|ll|)
{llll}
% header titles (should use the & sign to switch columns)
%------------------------------------------------------------------------------------------
{\textbf{Parameter} & \textbf{Symbol} & \textbf{Value} & \textbf{Unit}}
% cells content (should use the & and // to switch columns and rows)
%------------------------------------------------------------------------------------------
{Nominal composition 				& $w_0$ 			& \num{3}   & \si{\ucomposition} \\ 
Liquidus temperature 				& $T_L$ 			& tabulations 	& \si{\udegC} \\ 
% Eutectic temperature 			& $T_E$ 			& \num{577}	 	& \si{\udegC} \\  
Segregation coefficient 		& $k$ 				& tabulations	& $-$  \\  
Liquidus slope 						  & $m_L$ 			& tabulations 	& \si{\uslope} \\ 
Solid density	 					    & $\rhos$ 			& \num{7530} 	& \si{\udensity} 		\\  
Liquid density (reference)              & $\rhol_0$       & \num{7130}  & \si{\udensity}    \\   
Air density (reference) 						    & $\rhoa_0$ 			& \num{1.3} 	& \si{\udensity} 		\\  
Liquid viscosity			 		  & $\mul$ 			& \num{d-3} 	& \si{\uviscosity} 		\\  
% Solid viscosity	 					& $\mus$ 			& (Darcy) 			& \si{\uviscosity} 	\\  
Air viscosity 						  & $\mua$ 			& \num{d-4} 	& \si{\uviscosity} 		\\  
% Liquid heat capacity 		 	& $c_p^l$ 			& \num{1000} 	& \si{\umasscapacity} 	\\  
% Solid heat capacity 		 	& $c_p^s$ 			& \num{928.57} 	& \si{\umasscapacity} 	\\  
% Air heat capacity 		 		& $c_p^a$ 			& \num{1000} 	& \si{\umasscapacity} 	\\  
% Enthalpy of fusion 				& $l_f$ 				& \num{365384} 	& \si{\umassenergy} 	\\ 
Air thermal conductivity		& $\kappa^a$ 		& \num{0.01} 		& \si{\uconductivity}	\\
Liquid thermal conductivity 		& $\kappa^l$ 		& \num{33} 		& \si{\uconductivity}	\\
Solid thermal conductivity 			& $\kappa^s$ 		& \num{55} 		& \si{\uconductivity}	\\
Solute diffusion in the liquid	& $\Dl$ 			& \num{3e-9} 	& \si{\udiffusivity} 	\\  
% Solute diffusion in the solid		& $\Ds$ 			& \num{0} 	& \si{\udiffusivity} 		\\  
Solute diffusion in the air			& $\Da$ 			& (NM strategy) 	& \si{\udiffusivity} \\  
Thermal expansion coefficient   & \betaT          & \num{0.095e-3}   & \si{\ubetaT}      \\ 
Solutal expansion coefficient   & $\betawl$         & \num{-5.3e-3}   & \si{\ubetawl}     \\
Dendrite arm spacing        & $\lambda$         & \num{90e-6}     & \si{\metre}       \\ 
% Density                     & $\rholref$        & \num{7130}    & \si{\udensity}      \\ 
Reference composition       &$\wlref$         & \num{3}      & \si{\ucomposition}    \\
Reference temperature       &$\Tref$          & \num{228.1}     & \si{\udegC}       \\
Initial temperature 				&          			& \num{258.6} 	& \si{\udegC} 			\\ 
% \hline  %------------------------------------------------------------------------------------------
% Gravity acceleration 	 			& $\hext$ 			& \num{6e4} 	& \si{\uhconvec} 		\\ 
% Heat transfer coefficient 			& $\hext$ 			& \num{6e4} 	& \si{\uhconvec} 		\\ 
% External temperature 				& $\Text$ 			& \num{25} 	& \si{\udegC} 				\\ 
% Ingot length 						&  					& \num{0.1} 	& \si{\metre} 		\\ 
\hline %------------------------------------------------------------------------------------------
FE mesh size 						&  					& \cref{table:smacs_meshsize} 	& \si{\metre} 		\\ 
Time step 							& $\dt$ 			& \num{0.01} 	& \si{\second} 		\\ 
Convergence on residual 	& $\varepsilon_R$	& \num{e-5} 	& $-$ 				\\ 
Convergence on temperature) & $\varepsilon_T$ 	& \num{e-2} 	& \si{\udegK}}
%--------------------------------------------------------------------------------------------------
\end{tabulate}
%------------------------


% ********************************************
\subsection{Results}
% ********************************************

The results are recorded at two intermediate solidification stages, at 3050 s and 3550 s, knowing that solidification onset is around 1920 s.
First, we look to the results in \cref{fig:W_mask_1200s} at 3050 s. The original average composition field obtained by \emph{grid A}, shown in \cref{fig:1200s_compo},
is almost free of composition gradients except for one segregated channel rising from the bottom by the action of thermal convection.
On the other hand, the average composition transport from the adaptive grid to the fixed one, allows recording macrosegregation onto the latter
at nodes where the volume fraction of solid is greater than 70\%, depicted by the yellow region in \cref{fig:1200s_unmask}. 
This is why we observe in \cref{fig:1200s_compobis} a number of channel segregates
which are richer in Pb species with respect to the surrounding solid.
The solid fraction distribution is shown in \cref{fig:1200s_gs}, along with the flow pattern. Local vortices are observed in the metal, probably due 
to considering only a 2D geometry instead of the complete 3D, and this alters the computation stability by ignoring the boundary layers in the sample 
thickness, obtained otherwise in 3D. Nevertheless, the overall 
flow is driven by a thermosolutal driving force, with a compatible flow in the air side. 
We can observe how the solid fraction is modified in the segregated channel, as a result of macrosegregation.
At this stage of solidification, the interface movement is still difficult to see, but 500 s later it becomes more visible.


We look now at \cref{fig:1700s_gs} at 3550 s, and the decreasing left heat exchanger temperature has just went below the local liquidus, 
triggering solidification from the left side.
The average composition field presents noticeable differences between the adaptive \emph{grid A} and the fixed \emph{grid B}.
The weak macrosegregation observed in \cref{fig:1200s_compo} are now lost in \cref{fig:1700s_compo}, as the mesh got coarser on the metal's solidified right
side. Fortunately, the macrosegregation distribution is stored in the fixed grid (\cref{fig:1700s_compobis}) and shows more details with the advancement of solidification. 
The shrinkage due to phase density difference, is now clearly visible judging from interface shape, which still almost planar above the last liquid pool. 

At the end of solidification, the ingot top surface has shrunk, showing greater boundary displacement in the last liquid region to solidify, as shown
in \cref{fig:smacs_planche}. In this figure, it is interesting to compare the final experimental shape (\cref{fig:smacs_planche}) to the numerical one
(\cref{fig:smacs_planche_c}), while comparing the final obtained segregation maps (\cref{fig:smacs_planche_b}) to the numerical result of \cref{fig:smacs_planche_c}.

%-----------------
\begin{figure}[htbp]
\centering
   %------------
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1200s_compo.png}
  \caption{Lead composition on \emph{Grid A}}
    \label{fig:1200s_compo}
  \end{subfigure}
  %------------------------------
  \begin{subfigure}[t]{0.15\textwidth}
    \centering
  \includegraphics[width=0.3\textwidth]{Chapter5/Graphics/2d/colorbar_w.pdf}
  \end{subfigure}
  %------------------------------ 
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1200s_compobis.png}
  \caption{Lead composition on \emph{Grid B}}
    \label{fig:1200s_compobis}
  \end{subfigure}
   %------------
   \vspace{5mm}
   %------------------------------
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1200s_unmask.png}
  \caption{Transport from \emph{grid A} to \emph{grid B}}
    \label{fig:1200s_unmask}
  \end{subfigure}
   %------------
   %------------
   %------------------------------
  \begin{subfigure}[t]{0.15\textwidth}
    \centering
  \includegraphics[width=0.3\textwidth]{Chapter5/Graphics/2d/colorbar_gs.pdf}
  \end{subfigure}
  %------------------------------
  %------------------------------
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1200s_gs_vl.png}
  \caption{Solid fraction on \emph{grid B}}
    \label{fig:1200s_gs}
  \end{subfigure}
\caption{Snapshots at 3050 s of the average composition field shown on 
(a) \emph{grid A} where the mesh gets coarser in fully solidified regions near the right side while
and then on 
(b) \emph{grid B} where the uniform fine mesh predicts a smoother composition field (line indicates the current interface level). 
The increased number of segregated channels on the right side of the
metal is obtained by the successive transport operations performed in 
(c) a restricted area (\yellow{yellow} colour) based on the nodal values of (d) the solid fraction field.
The white line represents the zero isovalue of the level set function.}
\label{fig:W_mask_1200s}
\end{figure}
%------------------

%-----------------
\begin{figure}[htbp]
\centering
   %------------
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1700s_compo.png}
  \caption{Pb composition on \emph{Grid A}}
    \label{fig:1700s_compo}
  \end{subfigure}
  %------------------------------
  \begin{subfigure}[t]{0.15\textwidth}
    \centering
  \includegraphics[width=0.3\textwidth]{Chapter5/Graphics/2d/colorbar_w.pdf}
  \end{subfigure}
  %------------------------------ 
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1700s_compobis.png}
  \caption{Pb composition on \emph{Grid B}}
    \label{fig:1700s_compobis}
  \end{subfigure}
   %------------
   \vspace{5mm}
   %------------------------------
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1700s_unmask.png}
  \caption{Transport from \emph{grid A} to \emph{grid B}}
    \label{fig:1700s_unmask}
  \end{subfigure}
   %------------
   %------------
   %------------------------------
  \begin{subfigure}[t]{0.15\textwidth}
    \centering
  \includegraphics[width=0.3\textwidth]{Chapter5/Graphics/2d/colorbar_gs.pdf}
  \end{subfigure}
  %------------------------------
  %------------------------------
  \begin{subfigure}[t]{0.4\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Graphics/2d/processed/1700s_gs_vl.png}
  \caption{Solid fraction on \emph{grid B}}
    \label{fig:1700s_gs}
  \end{subfigure}
\caption{Snapshots at 3550 s of (a) the average composition result obtained on \emph{grid A}, compared to (b) the composition field obtained on \emph{grid B}, 
(c) after being transported in (c) a restricted area (\yellow{yellow} colour) based on the nodal values of (d) the solid fraction field.
The white line represents the zero isovalue of the level set function.}
\label{fig:W_mask_1700s}
\end{figure}
%------------------

%--------------
% \begin{figureth}
% % textwidth 
% {0.65}
% %path 
% {Chapter5/Graphics/2d/finalseg/finalsegreg.pdf}
% % caption
% {Final macrosegregation pattern showing the positively segregated channels within negative segregation areas to the right,
% while on the left the last liquid to solidify forms a recognisable pipe shrinkage and a positively segregated region underneath it.}
% % label
% \label{fig:smacs_final}
% \end{figureth}
%--------------

%-----------------
\begin{figure}[htbp]
\centering
  %------------------------------
  \begin{subfigure}[t]{0.85\textwidth}
  \centering
  \includegraphics[width=8cm]{Chapter5/Graphics/2d/smacs_exp_grains.png}
  \caption{}
  \label{fig:smacs_planche_a}
  \end{subfigure}
   %------------
  \vskip\baselineskip  
  %------------------------------
  \begin{subfigure}[t]{0.85\textwidth}
  \centering
  \includegraphics[width=8cm]{Chapter5/Graphics/2d/smacs_exp_composition.png}
  \caption{}
  \label{fig:smacs_planche_b}
  \end{subfigure}
   %------------
  \vskip\baselineskip
   %------------
  \begin{subfigure}[t]{0.85\textwidth}
    \centering
  \includegraphics[width=8cm]{Chapter5/Graphics/2d/finalseg/finalsegreg.pdf}
  \caption{}
  \label{fig:smacs_planche_c}
  \end{subfigure}
  %------------------------------   
  %------------
  \vskip\baselineskip
   %------------
  \begin{subfigure}[t]{0.5\textwidth}
    \centering
  \includegraphics[width=0.5\textwidth]{Chapter5/Graphics/2d/colorbar_w_horizontal.pdf}
  \end{subfigure}
  %------------------------------
  
\caption{(a) Final ingot shape with grains structure with (b) experimental macrosegregation patterns showing the positively segregated 
channels within negative segregation areas to the right, while on the left the last liquid to solidify 
forms a recognisable pipe shrinkage and a positively segregated region underneath it as predicted by (c) the corresponding simulation.} 
\label{fig:smacs_planche}
\end{figure}
%------------------



% ****************************************
\subsection{Mass conservation}
% ****************************************

% For this analysis, we use the same definitions for the mass variation of the metal (\cref{eq:metal_mass_variation}) and the chemical species (\cref{eq:solute_mass_variation}).
% Additionally, we define the relative volume change for each domain in the system as follows:
% %----------------
% \begin{align}
% \label{eq:volume_variation}
% &  V^M_\% = \frac{v^M - v^M_0}{v^M_0} \times 100	
% &  V^A_\% = \frac{v^A - v^A_0}{v^M_0} \times 100	
% \end{align}
% %---------------
% where $v^M_0$ and $v^A_0$ are respectively the initial volume for metal and air. 
% This volume is deduced from the level set by using the definition in \cref{eq:levelset_volume}.

Mass and volume data related to both air and metal are plotted in \cref{fig:global_smacs_metal}. 
The main reason for grouping all plots in a single one is to be able to analyse the mass variations as function of the solidification advancement, which can be tracked
by volume changes.

We see in this figure that no mass/volume variations are detected before 1900 s, seconds before solidification onset. Once the phase change starts, the average metal density decreases. Since air is incompressible, it is sucked towards the shrinking metallic front.
With our free velocity boundary condition, an air intake thus takes places, which is confirmed by the green curve corresponding to the relative air volume variation, starting from 2400 s. However between 1900 s and 2400 s, an unexpected slight volume increase of the metal takes place, although it should be decreasing under the action of the decreasing average density by solidification. This behaviour can be attributed to the competition between the flow due to thermosolutal convection and another flow due to shrinkage, and obviously the former is more  imposing than the latter. Therefore, it forces the level set to slightly move upwards, letting the metal gain some volume at the expense of air, whose volume is seen temporarily decreasing between 1900 s and 2500 s.
The metal's mass curve confirms also a positive variation, which is also reflected on the solute mass.
After 2500 s, the metal volume is beginning its descent until it reaches the final volume corresponding to -6\% of the initial volume. 
This value can also be deduced from the solidification shrinkage coefficient, $\beta_{SS}$, deduced from $\rhol$ and $\rhos$ included in \cref{table:data_case_smacs}.
However between 2500 s and 3000 s, the metal and species mass do not show any sign of stability, but still rising. Until around 3200 s, both mass percentages decrease again as expected.
While the metal's mass and volume follow the same trend after 3200 s, they are not really correlated. The mass is supposed to remain relatively unchanged until the final volume is reached. Therefore this means that the \emph{M-A} is moving towards the metal, with a greater speed than it should have. At about 3800 s, solidification is almost complete, and the remaining liquid is not capable of inducing a significant boundary. 

An unexpected profile is also obtained for solute mass which is plotted along with the metal mass in \cref{fig:global_smacs_species}.
From 3600 s to 3800 s, the ingot is almost completely solidified but still species transport takes place around the boundary.
The rise in species mass may be attributed to the new quantities of solute that add up incrementally to the system after each species resolution, when 
using \cref{eq:nonmonolithic_solute} with the NM strategy. Since the species mass ,$m^{sp}$, is deduced from the metal's mass, $m^M$, variations of the latter
(e.g. due to level set transport) is directly reflected on the former. Furthermore, it is possible that the variations of $m^M$ masked the variations of 
$m^{sp}$ when convection is dominant and solidification shrinkage is taking place. This could explain the sudden rise of $m^{sp}$ seen starting from about 3600 s. 

% %--------------
% \begin{figureth}
% % textwidth 
% {0.75}
% %path 
% {Chapter5/Data/2d_smacs_mass/global_smacs.pdf}
% % caption
% {}
% % label
% \label{fig:global_smacs_metal}
% \end{figureth}
% %--------------

%-----------------
\begin{figure}[htbp]
\centering
   %------------
  \begin{subfigure}[t]{0.75\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Data/2d_smacs_mass/global_smacs_metal.pdf}
  \caption{}
    \label{fig:global_smacs_metal}
  \end{subfigure}
  %------------------------------
  \vskip\baselineskip
  %------------------------------
  \begin{subfigure}[t]{0.75\textwidth}
    \centering
  \includegraphics[width=\textwidth]{Chapter5/Data/2d_smacs_mass/global_smacs_species.pdf}
  \caption{}
    \label{fig:global_smacs_species}
  \end{subfigure}
   %------------
\caption{Global plots showing (a) global system of metal and air mass (left y-axis) and volume (right y-axis) variation with time
and (b) the metal's mass (left y-axis) along with the mass of its metallic species (right y-axis).
The metal mass plot, $m^M$, is the same for (a) and (b).
The thickness dimension of the 2D domain is assumed to be \SI{1}{\metre}, hence the use of 3D units.} 
\label{fig:smacs_global}
\end{figure}
%------------------

\newpage

% ---------------------------------
\section{3D application: reduced-gravity solidification}
% ----------------------------------
As presented in the introductory chapter, the aim of the CCEMLCC project is to "reach a better
understanding of surface defects formed during processing of steels from the liquid state" \citep{gandin_project_2014}.
Among the several scientific topics being studied, the interaction between skin macrosegregation 
and thermomechanical deformation is investigated through chill cooling experiments.
The idea is to have the molten steel in a containerless environment, which could be done by several ways: 
electromagnetic levitation, on-board parabolic flights or sounding rockets and finally
in a real microgravity context as in the ISS. Heat is extracted from the sample by contact with a ceramic 
(Si$_3$N$_4$) substrate at room temperature (hence the term "chill cooling"), that collides into the alloy at a controlled speed.
This contact situation generating a high thermal gradient is comparable to casting processes between the molten alloy and the moulds.
For ground-based experiments, EML was used to achieve chill cooling of samples without using moulds. 
However, levitation induces currents in the spherical sample, generated by means of electromagnetic stirring (Lorentz forces) 
but also by thermal and solutal convection on the other hand. In reduced-gravity conditions, the dynamics of the phenomena behind fluid motion are less significant.
The current modelling is therefore compared to chill cooling experiments performed in parabolic flights and sounding rockets 
with reduced gravitational forces ($\norm{\gravity} \in \crochet{10^{-5};10^{-1}}$\si{\uacceleration}).

% ---------------------------------
\subsection{Previous work}
% ---------------------------------
% ---------------------------------
\subsubsection{TEXUS sounding rocket}
% ---------------------------------
TEXUS-46 is the name of the sounding rocket mission that carries the experimental setup, 
but for simplicity we will refer to the latter as being the TEXUS experiment. The setup is shown in \cref{fig:texus_exp}.
The main difference with respect to parabolic flight experiments,
TEXUS features solidification in near-zero gravitational fields and for extended periods of time (3 minutes). 
We do not have an exact measurement of the gravitational field magnitude, but it is several orders
less than Earth's gravity magnitude ($\norm{\gravity} \in \crochet{10^{-8};10^{-5}}$\si{\uacceleration}).
It should be mentioned that the experimental setup is comparable between parabolic flights and sounding rocket experiments. That is to say
that the dimensions of the steel sample, the substrate and the container are almost the same. Nevertheless, different steel compositions were
considered in each type of experiment.

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/3d/exp.pdf}
% caption
{Three frames describing the experimental setup used to achieve reduced-gravity 
solidification on-board a sounding rocket flight,
showing the initial alloy sample, the cage and the positiong coil. The setup
is similar to the one used for TEMPUS experiments.}
% label
\label{fig:texus_exp}
\end{figureth}
%--------------


% ---------------------------------
\subsubsection{TEMPUS experiment for parabolic flight campaigns}
% ---------------------------------

The TEMPUS experiment came as a first alternative for EML experiments on ground during which accurate thermophysical and rheological characterisation were difficult to achieve.
Each flight consists of several cycles of free fall, a reduced-gravity environment is hence created, 
allowing to use only a single radio frequency (RF) coil to stabilise the position of the droplet, while the substrate comes into contact with the molten sample
from above it. An axial pyrometer measures the sample temperature during the process. 
Also, a high-speed camera records the solidification process, producing frames as shown in \cref{fig:camera}.
This is useful to measure the front growth speed. 
Each parabola cycle lasts for 50 s, offering an effective low gravity ($\norm{\gravity}\approx$\SI{e-1}{\uacceleration}) for about 20 s.


%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/3d/camera.pdf}
% caption
{Image sequence given by a high speed camera on-board a TEMPUS parabolic flight (parabola \#14 Oct 2014), showing the 
solidification progress between 0 s (when contact with the chill is initiated) to 3.75 s in a \tern{Fe}{0.9}{C}{0.2}{Si} steel droplet. 
The progress of the solidification front is marked by the green dashed line. In some frames, the droplet is partially hidden by the narrow 
opening of the sample holder facing the camera.}
% label
\label{fig:camera}
\end{figureth}
%--------------

%--------------
\begin{figureth}
% textwidth 
{0.25}
%path 
{Chapter5/Graphics/3d/camera_end.pdf}
% caption
{Camera image from the TEMPUS 2014 experiment, showing the fully solidified droplet with a deformed shape after 10 s.}
% label
\label{fig:camera_end}
\end{figureth}
%--------------

% --------------------------------------
\subsubsection{Numerical contribution}
% --------------------------------------

A former numerical contribution was done by \citet{rivaux_simulation_2011} at CEMEF, as mentioned in the first chapter. 
His model considered both the steel droplet and the ceramic chill in a Lagrangian formulation, i.e. each object is
modelled using a separate mesh. Conservation equations of mass, energy,
chemical species and momentum were solved in the metal domain, while the energy
conservation was the sole equation solved on the chill mesh. The mechanical problem was divided
into two parts: fluid mechanics and solid mechanics. 
For the first part, the momentum conservation in the liquid phase was solved using an
incompressible P1/P1 SUPG-PSPG formulation of Navier-Stokes equations, i.e. 
without any contraction for the liquid phase neither solidification shrinkage at the solid-liquid interface.
The second part, solid mechanics, was solved using P1+/P1 formulation to predict solid deformation caused by the 
solid's thermal contraction as well as solidification shrinkage, 
using an elastic-viscoplastic behaviour. 

The simulation results showed that the total droplet deformation that has been
observed in the experiments is not primarily due to solid deformation. The density jump
between the solid and liquid phases at the solidification front is actually predominant. High
speed camera images shown in \cref{fig:camera,fig:camera_end} endorse this observation, where the droplet underwent a continuous
spherical-to-elliptic shape change while the solidification front travelled away from the
contact point. Another interesting point to comment is the computation of solidification
shrinkage in the solid resolution, although this type of shrinkage does not generate stresses 
in the solidifying alloy, compared to thermal contraction for instance.

Thermal contraction and strains in the solid phase were computed and coupled with fluid mechanics but hardly managed to retrieve the final shape of the droplet reported in the experiment, as revealed in \cref{fig:camera}.

% --------------------------------------
\subsection{Computational configuration}
% --------------------------------------

% --------------------------------------
\subsubsection{Geometry and mesh}
% --------------------------------------

The simulation considers only 1/4 of the droplet-gas system, given the axial symmetry of the problem.
Furthermore, the substrate is implicitly taken into account via a boundary condition, as explained in the next section. 
This is sufficient in the current context, because we are only interested in the energy transfer from the droplet to the substrate. 

The steel sample is not perfectly spherical initially as surface oscillations perturb the equilibrium shape. 
Such perturbations may be attributed to Lorentz forces created by the positioning coil. 
The droplet hence is compared to an ellipsoid having
a vertical minor axis of \SI{5.68}{\milli \metre} and a horizontal major axis of \SI{6.6}{\milli \metre} \citep{rivaux_simulation_2011}, as shown in \cref{fig:imagetomesh}.
The top is a planar surface (diameter of \SI{2}{\milli \metre}), where the contact is initiated. 
Also in \cref{fig:imagetomesh}, the alloy is immersed in a gas medium (argon), such that both domains form together 1/4 of a 
cylinder having \SI{8}{\milli \metre} in radius and  \SI{8}{\milli \metre} in height.

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/3d/imagetomesh.pdf}
% caption
{(a) The camera frame before the onset of solidification gives the essential information to (b) 
rebuild the droplet geometry then (c) a standalone 2D mesh used to obtain (d) the final immersed 3D mesh corresponding
to time 0 s in \cref{fig:camera}.}
% label
\label{fig:imagetomesh}
\end{figureth}
%--------------

The mesh is then automatically adapted to the moving interface using \emph{Remesh2}. 
We adopt the same remeshing strategy applied for computations shown in \cref{fig:1dalsi7_equalprops,fig:1dalsi7_differentprops}. 
whereby a fixed mesh size, $h_M$, is imposed in the metal domain, another fixed size, $h_A$, for the argon domain, while the 
interface is remeshed using anisotropic elements. All remeshing parameters are found in \cref{table:texus_remeshing_params}. 
The corresponding parameters are given by \cref{table:texus_remeshing_params}.
Remeshing is performed each second.
%--------------------------------
\begin{table}[htbp]
\centering
\caption{Summary of the mesh parameters used to generate an adaptive mesh, along with the level mixing thickness, $\varepsilon$. 
Refer to \cref{sec:remesh2_params} for the definition of each mesh parameter.}
\label{table:texus_remeshing_params}
{\tabulinesep=1.0mm \begin{tabu}{ll}
\tabucline[1pt]{-}
\textbf{Mesh parameter} & \textbf{Value} \\\tabucline[1pt]{-}
%-----------------------------
$\varepsilon $							&	\SI{1.5e-4}{\metre}	\\
$h_{\vec{n}} = h_{\vec{\tau}}$			&	\SI{2e-5}{\metre}		\\ 
$h_M$  									&	\SI{1e-4}{\metre}		\\
$h_A$  									&	\SI{6e-4}{\metre} 		\\
Remeshing frequency  					&	1 s 		\\
Number of nodes 				&   $\approx$ \num{e5} \\ 
Number of elements 			&   $\approx$ \num{5e5} \\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}
%--------------------------------


% -----------------------------------------------
\subsubsection{Initial and boundary conditions}
% -----------------------------------------------

The thermal boundary conditions are set as follows: heat loss by radiation is not considered in our model, 
hence all boundaries are considered adiabatic, except for the metal-substrate contact area which is substituted by
an equivalent convection boundary condition.

% -----------  DISPLACED TEXT
% This surface is modelled by a Fourier condition with $\Text$=\SI{25}{\udegC} 
% and an effective exchange coefficient $\hext$ of \SI{6e4}{\uhconvec}. 
% The $\hext$ coefficient's value has been determined by running multiple simulations with different values in the aim
% of predicting a front speed as closer as possible to the experimental measurements plotted in \cref{fig:position_vs_time_binary}, 
% as explained in the coming sections.

% %--------------------------------------
% \begin{figure}[htbp]
% \centering
% \begin{tikzpicture}%[spy using outlines={draw, blue, magnification=2, connect spies}]
%  \pgfkeys{%
%     /pgf/number format/set thousands separator = {}}
% %================================================
% \begin{axis}
% [	name=mass curves,
% 	%title= mass conservation,
% 	scale only axis,
% 	table/col sep=tab,
% 	enlarge x limits=false,
% 	legend pos=north west,
% 	scaled ticks=true,
% 	xlabel=Time (s),
% 	ylabel= Front position (m),
% 	xticklabel style={/pgf/number format/fixed},
% 	%xtick={0,200,400,600,800,1000},
% 	%ytick={-0.1,0,0.1,0.2},
% 	%x tick label style={rotate=45,anchor=east},
% 	width=0.6\textwidth,
% 	%height=5cm,	
% 	%ymin=-0.1, ymax=0.2,
% 	%mark repeat	= {30},
% 	cycle list name=mycycle, %exotic,
% ]
% %\addplot table [x=time, y=position] {Chapter5/Data/3d_growthspeed/olddroplet_frontposition_vs_time.txt};
% \addplot table [x=time, y=position] {Chapter5/Data/3d_growthspeed/newdroplet_h6e4.txt};
% \addplot table [x=time, y expr=\thisrow{position}/1000] {Chapter5/Data/3d_growthspeed/EXP_texus2009_frontposition_vs_time.txt};
% \addplot table [x=time, y expr=\thisrow{position}/1000] {Chapter5/Data/3d_growthspeed/exp_tempus2014_frontposition_vs_time.txt};

% \legend{Simulation, TEXUS, TEMPUS}
% \end{axis}
% \end{tikzpicture}
% \caption{Position of solidification front versus time for the binary alloy 
% simulation compared to the experimental findings of the TEXUS-46 flight 
% in 2009 and TEMPUS 2014 measurements \citep{gandin_project_2014}.}
% \label{fig:position_vs_time_binary}
% \end{figure}
% %--------------------------------------
% -----------  END OF DISPLACED TEXT


For the velocity-pressure boundary conditions, \cref{fig:texus_bc} shows that a no-slip condition is imposed
on the droplet-substrate surface, 
since this area solidifies first without further fluid motion, as shows \cref{fig:camera}.
It is noted that the first solidified shell may experimentally deform under thermal contraction stresses, 
but we do not consider it hereafter, unlike what was done by \citet{rivaux_simulation_2011}. 
For the rest of the domain, we impose the normal velocity component to zero on both symmetry faces, 
while keeping free tangential components. The remaining boundaries, namely the top and the outer lateral surface of the argon gas,
have free velocity components. However, such condition may cause instability in the level set transport solver. 
This problem has been reported by \citep{basset_simulation_2006}, showing a limitation in the imposed boundary conditions between Navier-Stokes solver and level set transport. 
Therefore, we limit these instabilities by imposing a no-slip condition, thus allowing the argon to flow in the computational
domain through the outer lateral surface. 
The cylinder height was taken big enough to prevent any flow damping near the droplet's north pole,
which may spuriously alter its final shape. The pressure condition for the argon gas is left free for all boundaries.
%as the experiment does not provide any pressure measurement of the confined argon.
The adopted time step is 0.01 s.

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/3d/bc.pdf}
% caption
{3D views showing the thermal (in \red{red}) and mechanical (in \blue{blue}) boundary conditions used in reduced-gravity simulations.
The symmetry planes represent the following set of boundary conditions: adiabatic, zero normal velocity, free tangential velocity and pressure-free.}
% label
\label{fig:texus_bc}
\end{figureth}
%--------------

% -------------------------------
\subsubsection{Choice of alloy}
% -------------------------------

Various steel grades were considered in the CCEMLCC project, depending on whether the considered alloy will be used for parabolic flights
or sounding rocket missions. A medium-carbon steel, \tern{Fe}{0.9}{C}{0.2}{Si}, was affected for TEMPUS parabolic flights.
For TEXUS missions, the sample is a low-carbon steel and the grade is designated as "\emph{b1}" alloy. Its nominal 
composition is given in \cref{table:texus_b1}. 

% For this modelling part, we are mainly interested in two things: first predict the final droplet shape 
As our approach relies on thermodynamic tabulations, we show in 
the next section that we can take into account the multicomponent alloy to predict segregation, by considering 
first only one species, hence a binary Fe-C alloy, refer to as \emph{b1Bin} alloy. 
In a later step, we consider a ternary Fe-C-Si alloy, \emph{b1Tern}. 
Finally, we consider a quaternary Fe-C-Mn-Si alloy, \emph{b1Quat}. 

By performing the same reduced-gravity simulation while varying the alloy from binary to quaternary, we can study 
how the varying solidification paths (as a consequence of macrosegregation) may affect the final droplet shape, 
as the shrinkage profile is directly related to the solid fraction and its evolution with time.

%--------------------------------
\begin{table}[htbp]
\centering
\caption{Nominal composition (\si{\ucomposition}) of the experimental \emph{b1} steel \citep{rivaux_simulation_2011} and its binary, ternary and quaternary alloys approximations, 
respectively \emph{b1Bin}, \emph{b1Tern} and \emph{b1Quat}. }
\label{table:texus_b1}
{\tabulinesep=1.0mm \begin{tabu}{lcccccc}
\tabucline[1pt]{-}
\textbf{Alloy} & \textbf{C} & \textbf{Si} & \textbf{Mn} & \textbf{Al} & \textbf{S} & \textbf{P} \\\tabucline[1pt]{-}
%-----------------------------
\emph{b1}		  &	0.105 	&	0.268	&	0.636	&	\num{0.0067} 	&		0.009		&	0.0189		\\
\emph{b1Bin}	&	0.105 	&    -		&	 -		&		-			&		-			&		-		\\
\emph{b1Tern}	&	0.105 	&	0.268	&	 -		&		-			&		-			&	 	-		\\		
\emph{b1Quat}	&	0.105 	&	0.268	&	0.636 	&		-			&		-			& 		- 		\\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}


%--------------------------------
% -------------------------------
\subsubsection{Parametric study: final shape prediction}
% -------------------------------

In this subsection, we focus on obtaining a comparable finale shape of the droplet between the experiment and simulation.
To do so, we study the variations of 2 main important parameters: first, the heat transfer coefficient of the metal-substrate 
contact surface that controls the heat extraction and hence the solidification rate. 
The second parameter is the magnitude of the gravitational field,
which has a great influence on the fluid flow inside the molten droplet.
The importance of this parametric study is two-fold: 
\begin{enumerate}
\itemsep0em

\item in our model, the energy equation solved with the level set methodology considers only heat conduction 
and advection in the gas A, hence no account for the heat dissipated by radiation.
% (which is an ongoing PhD project at CEMEF). 
Therefore a trial-and-error strategy is necessary to determine an optimal value of $\hext$ 
to ensure that the solidification rate is comparable to the experimental measurements,

\item from a hydrodynamics perspective, a containerless molten droplet levitated under reduced-gravity conditions is maintained nearly spherical 
under the action of surface tension forces. Other forces due to tangential surface tension gradients (Marangoni force) or Lorentz force may also exist.
Although possible to implement by the CSF method, accounting numerically for surface tension adds complexity to the model by imposing
a time step constraint. However, if we neglect this force, the droplet will tend to collapse if gravity acceleration is fast enough.
Consequently, a parametric study helps us determine this gravity threshold, while neglecting surface tension and Lorentz forces. 
\end{enumerate}

A series of test simulations were launched in the aim of getting comparable results with the experiment.
Several values of $\hext$ were tested in the interval [\num{e2};\num{e6}]\si{\uhconvec}, while the gravity acceleration influence was tested
for values lying in the interval [\num{e-6};\num{e-2}]\si{\uacceleration}. 
% The best match for the final shape while preserving a front propagation
% speed close to \SI{0.7}{\milli \uvelocity}, was obtained by setting simultaneously $\hext=6 \times 10^{4}$ \si{\uhconvec} and $\norm{\gravity}=5\times 10^{-5}$ \si{\uacceleration}.
To demonstrate the effect of varying these parameters, we present a parametric study in \cref{table:parametric_study}, where only the most relevant cases are studied with
a binary alloy, \bin{Fe}{0.105}{C}.

%--------------------------------
\begin{table}[htbp]
\centering
\caption{Summary of the parametric study for the conductive heat transfer coefficient (H) 
and the magnitude of the gravity vector (G, not to be confused with thermal gradient).
The cases are defined by fixing each parameter to a reference value then varying the latter parameter. 
The reference values, H0$=$\SI{6e4}{\uhconvec} and G0$=$\SI{5e-5}{\uacceleration}, 
ensure a good compromise when compared to the experimental solidification rate and final droplet shape.}
\label{table:parametric_study}
{\tabulinesep=1.0mm \begin{tabu}{lcc}
\tabucline[1pt]{-}
\textbf{Case} & $\hext$ [\si{\uhconvec}]  & $\norm{\gravity}$ [\si{\uacceleration}]  \\\tabucline[1pt]{-}
%-----------------------------
H1G0 	&	\num{e3}	&	\num{5e-5}		\\
H2G0 	&	\num{e4}	&	\num{5e-5}		\\
H3G0 	&	\num{e5}	&	\num{5e-5}		\\
H4G0 	&	\num{e6}	&	\num{5e-5} 		\\\tabucline[1pt]{-}
%-----------------------------
H0G1 	&	\num{6e4}	&	\num{e-3}		\\
H0G2 	&	\num{6e4}	&	\num{e-4}		\\
H0G3 	&	\num{6e4}	&	\num{e-5}		\\
H0G4 	&	\num{6e4}	&	\num{e-6} 		\\\tabucline[1pt]{-}
%-----------------------------
\end{tabu}}
\end{table}
%--------------------------------

We start the analysis by observing the results in \cref{fig:parametricH}, where the parameter $\hext$ increases from case H1G0 to H4G0, while maintaining
a constant gravity acceleration at \SI{5e-5}{\uacceleration}.
In the first case, H1G0, the heat coefficient is at its lowest between the droplet and the chill. As this contact is the only way to dissipate heat from the droplet,
a low heat exchange coefficient means a slow cooling. Therefore, contact area of the droplet solidifies first. As we consider a fixed solid in our model, any solidified 
part can no longer move or deform. As time passes, solidification is slow, such that the droplet starts collapsing at about 10 sec, undergoing a significant shape change under
the gravity's action. It is not clear if such microgravity conditions are sufficient to deform the droplet as simulated in case H1G0. In fact, 
surface tension forces might play a central role in stabilising the sample shape by minimising its surface energy.
As we neglect it in our simulations, the droplet naturally deforms in the direction of the gravity vector.
We can make the same conclusion for case H2G0, while taking note of a thicker solid shell base in the horizontal direction, 
featuring also necking around the droplet axis mid-height. It should be noted that in both cases H1G0 and H2G0, solidification is not complete 
at 15 s.

More interesting results are obtained in case H3G0 where the heat coefficient is two orders of magnitude 
higher than that in the first case. The high solidification rate allows the mushy front 
to propagate further before deformation occurs by gravity. We see a global deformation which is qualitatively comparable to the experimental 
results: an ellipsoidal form with a longer vertical axis (i.e. in the direction of the microgravity vector) 
with respect to the initial shape, while the horizontal axis decreases compared to the original
sample diameter. Finally, we observe the same deformation tendency if we compare cases H3G0 and H4G0. 
The latter becomes closer to a situation of pure shrinkage flow. 
Consequently, its final shape corresponds to a global shrinkage of the initial one.

In order to have a clear idea on the effect of varying the cooling rate parameter on mass conservation, we plot in \cref{fig:mass_parametricH}
the mass variation versus time for all four cases. We can notice that mass variation for case H4G0 occurs between 2\% and -1\% near the solidification end,
recording the least variations compared to other cases. On the other hand, cases H1G0 and H2G0 show an important mass loss before solidification comes to end,
reaching -11\%. We are particularly interested in case H3G0, which shows a good compromise between the deformation magnitude and mass loss, the latter being at -3\% of metal mass.

%----------------
%
\begin{figure}[htbp]
\centering
%\begin{minipage}{.5\textwidth}
  \begin{subfigure}[t]{0.45\textwidth}
   \raggedleft
  \begin{tikzpicture}%[spy using outlines={draw, blue, magnification=2, connect spies}]
 \pgfkeys{%
    /pgf/number format/set thousands separator = {}}
%================================================
\begin{axis}
[	name=mass curves,
	%title= mass conservation,
	scale only axis,
	table/col sep=tab,
	enlarge x limits=false,
	legend pos=south west,
	scaled ticks=true,
	xlabel=Time (s),
	ylabel=$m^M_\%$ (\%),
	xticklabel style={/pgf/number format/fixed},
	xtick={0,3,6,9,12,15},
	ytick={-8,-4,0,2},
	%x tick label style={rotate=45,anchor=east},
	width=\textwidth,
	height=5cm,	
	ymin=-10, ymax=2,
	mark repeat	= {50},
	cycle list name=mycycle, %exotic,
]
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229394)/0.000229394] {Chapter5/Data/3d_binternquatern/a_bin.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H1G0.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H2G0.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H3G0.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H4G0.txt};
\legend{H0G0,H1G0,H2G0,H3G0,H4G0}
\end{axis}
\end{tikzpicture}
\caption{}
\label{fig:mass_parametricH}
  \end{subfigure}
  %----------------------------
  \hfill
  %----------------------------
  \begin{subfigure}[t]{0.45\textwidth}
   \raggedright
   \begin{tikzpicture}%[spy using outlines={draw, blue, magnification=2, connect spies}]
 \pgfkeys{%
    /pgf/number format/set thousands separator = {}}
%================================================
\begin{axis}
[ name=mass curves,
  %title= mass conservation,
  scale only axis,
  table/col sep=tab,
  enlarge x limits=false,
  legend pos=south west,
  scaled ticks=true,
  xlabel=Time (s),
  ylabel={},
  xticklabel style={/pgf/number format/fixed},
  xtick={0,3,6,9,12,15},
  ytick={-8,-4,0,2},
  yticklabels={,,},
  %x tick label style={rotate=45,anchor=east},
  width=\textwidth,
  height=5cm, 
  ymin=-10, ymax=2,
  mark repeat = {50},
  cycle list name=mycycle, %exotic,
]
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229394)/0.000229394] {Chapter5/Data/3d_binternquatern/a_bin.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H0G1.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H0G2.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H0G3.txt};
\addplot table [x=Temps, y expr=100*(\thisrow{mM}-0.000229326)/0.000229326] {Chapter5/Data/3d_parametric/H0G4.txt};
\legend{H0G0,H0G1,H0G2,H0G3,H0G4}
\end{axis}
\end{tikzpicture}
\caption{}
\label{fig:mass_parametricG}
  \end{subfigure}
  %
\caption{Mass conservation analysis for (a) cases H0G0 (reference) and HxG0 (x=1,2,3,4) and (b) cases H0G0 (reference) and H0Gx (x=1,2,3,4),
where Hx increases for an increasing x, while G decreases for increasing x. All values are defined in \cref{table:parametric_study}.}
\label{fig:mass_parametric_texus}
\end{figure}
%
%---------------------

Now, we study the effect of varying the gravity parameter and its influence on the final deformation. 
We observe first the results for case H0G1 where gravity magnitude is about four orders less than the Earth gravity at zero altitude.
While the base solidifies, the remaining part falls down
deforming severely by its weight and leading to a non-converging level set transport. The last recorded time is 1.75 s.
For case H0G2, the droplet is less solicited by its weight, and therefore solidifies while having a vertically elongated shape.
It should be reminded that in the current global numerical model does not account for the metal's surface tension, which may
clearly have a drastic influence on the final shape, especially at higher gravity magnitudes, such as for cases H0G1 and H0G2.
Moving on to cases H0G3 and H0G4, the weight driving force becomes negligible compared to the shrinkage driving force. Therefore,
the sample shows little lateral deformation, while in the central vertical plane of the droplet, the droplet has shrunk when 
compared to the initial profile. This is more visible in case H0G4, where the final shape is overall smaller than the initial volume,
which is not the same as found in cases H3G0 and H4G0. The mass conservation analysis corresponding to the gravity magnitude variation
are plotted in \cref{fig:mass_parametricG}. The plots show, as expected, better mass conservation for decreasing gravity acceleration, i.e.
from case H0G1 to H0G4. We think however that surface tension would change this analysis, and non-convergence obtained in case H0G1
may be prevented.

%--------------
\begin{figureth}
% textwidth 
{0.95}
%path 
{Chapter5/Graphics/3d/parametricH.pdf}
% caption
{3D snapshots of a droplet (only half shown for symmetry) undergoing solidification shrinkage where the heat exchange coefficient 
increases from H1 to H4 according to \cref{table:parametric_study}. The \green{green} surface is the initial droplet profile while the \blue{blue} surface
is the deforming droplet profile. The camera rotation over time allows observing deformation from different angles. The gravity vector points downwards.}
% label
\label{fig:parametricH}
\end{figureth}
%--------------

%--------------
\begin{figureth}
% textwidth 
{0.95}
%path 
{Chapter5/Graphics/3d/parametricG.pdf}
% caption
{3D snapshots of a droplet (only half shown for symmetry) undergoing solidification shrinkage where the magnitude of the gravitational field
decreases from G1 to G4 according to \cref{table:parametric_study}. The \green{green} surface is the initial droplet profile while the \blue{blue} surface
is the deforming droplet profile. The camera rotation over time allows observing deformation from different angles.
The gravity vector points downwards.}
% label
\label{fig:parametricG}
\end{figureth}
%--------------


% --------------------------------
\subsection{TEXUS binary alloy}
% --------------------------------

\subsubsection{Optimal configuration}

This contact surface between the droplet and the chill is modelled by a Fourier condition with $\Text$=\SI{25}{\udegC} 
and an effective exchange coefficient $\hext$ of \SI{6e4}{\uhconvec}.
The $\hext$ coefficient's value has been determined by running multiple simulations with different values in the aim
of predicting a front speed as closer as possible to the experimental measurements plotted in \cref{fig:position_vs_time_binary}.
The best match for the final shape while preserving a front propagation
speed close to \SI{0.7}{\milli \uvelocity}, was obtained by setting simultaneously 
$\hext=6 \times 10^{4}$ \si{\uhconvec} and $\norm{\gravity}=5\times 10^{-5}$ \si{\uacceleration}.
These values are included in \cref{table:data_case_texus} along with the other simulation parameters.
It is reminded that for the species conservation, the non monolithic strategy is used.
The optimal computational configuration is now known, thus we proceed to simulate the solidification 
of the binary alloy given previously in \cref{table:texus_b1}.

%--------------------------------------
\begin{figure}[htbp]
\centering
\begin{tikzpicture}%[spy using outlines={draw, blue, magnification=2, connect spies}]
 \pgfkeys{%
    /pgf/number format/set thousands separator = {}}
%================================================
\begin{axis}
[	name=mass curves,
	%title= mass conservation,
	scale only axis,
	table/col sep=tab,
	enlarge x limits=false,
	legend pos=north west,
	scaled ticks=true,
	xlabel=Time (s),
	ylabel= Front position (mm),
	xticklabel style={/pgf/number format/fixed},
	%xtick={0,200,400,600,800,1000},
	%ytick={-0.1,0,0.1,0.2},
	%x tick label style={rotate=45,anchor=east},
	width=0.4\textwidth,
	%height=5cm,	
	%ymin=-0.1, ymax=0.2,
	%mark repeat	= {30},
	cycle list name=mycycle, %exotic,
]
%\addplot table [x=time, y=position] {Chapter5/Data/3d_growthspeed/olddroplet_frontposition_vs_time.txt};
\addplot table [x=time, y expr=\thisrow{position}*1000] {Chapter5/Data/3d_growthspeed/newdroplet_h6e4.txt};
\addplot table [x=time, y expr=\thisrow{position}] {Chapter5/Data/3d_growthspeed/EXP_texus2009_frontposition_vs_time.txt};
\addplot table [x=time, y expr=\thisrow{position}] {Chapter5/Data/3d_growthspeed/exp_tempus2014_frontposition_vs_time.txt};

\legend{Simulation, TEXUS, TEMPUS}
\end{axis}
\end{tikzpicture}
\caption{Position of solidification front versus time for the binary alloy 
simulation compared to the experimental findings of the TEXUS-46 flight 
in 2009 and TEMPUS 2014 measurements \citep{gandin_project_2014}.}
\label{fig:position_vs_time_binary}
\end{figure}
%--------------------------------------

%------------------------
\begin{tabulate}
% caption 
{Parameters for the 3D simulation of the TEXUS droplet solidification under microgravity conditions.
\citep{rivaux_simulation_2011,andersson_thermo-calc_2002}.}
% label
{table:data_case_texus}
% line separation (e.g. 1.5mm)
{1.0mm}
% column justification-number (e.g. |c|ll|)
{llll}
% header titles (should use the & sign to switch columns)
%------------------------------------------------------------------------------------------
{\textbf{Parameter} & \textbf{Symbol} & \textbf{Value} & \textbf{Unit}}
% cells content (should use the & and // to switch columns and rows)
%------------------------------------------------------------------------------------------
{Nominal composition 				& $w_0$ 			& \num{0.105}   & \si{\ucomposition} \\ 
% Liquidus temperature 			& $T_L$ 			& \num{618} 	& \si{\udegC} \\ 
% Eutectic temperature 			& $T_E$ 			& \num{577}	 	& \si{\udegC} \\  
Segregation coefficient 		& $k$ 				& \scriptsize{Tabulations ()} 	& $-$  \\  
Liquidus slope 						  & $m_L$ 			&  \scriptsize{Tabulations (\citep{andersson_thermo-calc_2002})} 	& \si{\uslope} \\ 
Solid density               & $\rhos$       & \num{2800}  & \si{\udensity}    \\  
Liquid density (reference)	& $\rhol_0$ 			& \scriptsize{Tabulations (\citep{andersson_thermo-calc_2002})}	& \si{\udensity} 		\\ 	 
Air density (reference)     & $\rhoa_0$ 			& \num{1.3} 	& \si{\udensity} 		\\  
Liquid viscosity			 		  & $\mul$ 			& \num{d-3} 	& \si{\uviscosity} 		\\  
% Solid viscosity	 					& $\mus$ 			& (Darcy) 			& \si{\uviscosity} 	\\  
Air viscosity 						  & $\mua$ 			& \num{d-4} 	& \si{\uviscosity} 		\\  
% Liquid heat capacity 		 	& $c_p^l$ 			& \num{1000} 	& \si{\umasscapacity} 	\\  
% Solid heat capacity 		 	& $c_p^s$ 			& \num{928.57} 	& \si{\umasscapacity} 	\\  
% Air heat capacity 		 		& $c_p^a$ 			& \num{1000} 	& \si{\umasscapacity} 	\\  
% Enthalpy of fusion 				& $l_f$ 			& \num{365384} 	& \si{\umassenergy} 	\\ 
Air thermal conductivity		& $\kappa^a$ 		& \num{0.01} 		& \si{\uconductivity}	\\
Liquid thermal conductivity & $\kappa^l$ 		& \num{42} 		& \si{\uconductivity}	\\
Solid thermal conductivity 	& $\kappa^s$ 		& \num{42} 		& \si{\uconductivity}	\\
Solute diffusion in the liquid		& $\Dl$ 			& \num{d-9} 	& \si{\udiffusivity} 	\\  
% Solute diffusion in the solid		& $\Ds$ 			& \num{0} 	& \si{\udiffusivity} 		\\  
Solute diffusion in the air	(fictitious)	& $\Da$ 	& (NM strategy) 	& \si{\udiffusivity} \\  
\hline  %------------------------------------------------------------------------------------------
Gravity acceleration 	 			    & $\norm{\gravity}$  & \num{5e-5} 	& \si{\uacceleration} 		\\ 
Heat transfer coefficient 			& $\hext$ 			& \num{6e4} 	& \si{\uhconvec} 		\\ 
External temperature 				    & $\Text$ 			& \num{25} 	  & \si{\udegC} 			\\ 
Initial temperature             &               & \num{1580}   & \si{\udegC}      \\ 
\hline %------------------------------------------------------------------------------------------
FE mesh size 						&  					& \cref{table:texus_remeshing_params} 	& \si{\metre}\\ 
Time step 							& $\dt$ 			& \num{0.01} 	& \si{\second} 		                   \\ 
Convergence criterion (residual) 	& $\varepsilon_R$	& \num{e-4} 	& $-$ 				         \\ 
Convergence criterion (temperature) & $\varepsilon_T$ 	& \num{e-1} 	& \si{\udegK}}
%--------------------------------------------------------------------------------------------------
\end{tabulate}
%------------------------


% ***************************
\subsubsection{Results}
% ***************************

The nominal composition for this alloy is \bin{Fe}{0.105}{C}. In order to obtain accurate segregation results, 
a fine resolution mapping was performed from equilibrium calculations, using 20 values of composition between a minimum of \SI{0.01}{\ucomposition} and \SI{1}{\ucomposition}. 
This is equivalent for a composition step of \SI{0.0495}{\ucomposition}, with a temperature step of \SI{1}{\udegC} 
varying in the interval [\SI{20}{\udegC};\SI{1600}{\udegC}].
The importance of choosing small steps in composition and temperature is to predict 
accurate solidification paths during macrosegregation (relative to the droplet scale), which is the main input of solidification shrinkage. 
Therefore, less accurate mappings may result in false shrinkage profile prediction, as will be shown henceforth.

Using the initial and boundary conditions defined earlier, 15 seconds of simulation give the final shrinkage profile shown in \cref{fig:bin_vs_exp}.
We notice that the predicted overall deformation of the droplet is in a good agreement with the experimental shape after solidification.
This agreement is still not perfect as some key input parameters are still missing in the model, 
namely the real gravity acceleration on-board the TEXUS sounding rocket missions 
and the correct heat flux between the sample and the substrate. 
It is emphasized that for higher gravity accelerations or lower heat transfer, surface tension is of central importance since 
it counters the gravitational force by stabilising the \emph{M-A} boundary.

%--------------
\begin{figureth}
% textwidth 
{0.7}
%path 
{Chapter5/Graphics/3d/bin/bin_vs_exp.pdf}
% caption
{Comparison of experimental (\blue{blue}) and numerical (\red{red}) shrinkage profiles, compared to their respective initial shapes (\green{green}). 
An image processing algorithm is used to extract the droplet outlines from the experimental images. 
The experimental displacement of the droplet was estimated by scaling 
the initial numerical profile to the initial experimental profile, and then comparing the final profiles.
The gravitational field points downwards, depicted
by the arrow (note that the vector length is not scaled to its magnitude).}
% label
\label{fig:bin_vs_exp}
\end{figureth}
%--------------
%--------------
\begin{figureth}
% textwidth 
{0.7}
%path 
{Chapter5/Graphics/3d/bin/flow.pdf}
% caption
{Flow patterns in reduced-gravity solidification with shrinkage: 
deviation towards the solidification front at 0.25 s and 1 s, contributing to solute transport in gravity's opposite direction.
At 8 sec, the mushy zone reaches the droplet vertex marking a flow pattern change. 
At 20 s, the argon flows freely in the domain around the completely solidified and rigid sample.
Yellow arrows help visualise the directions of the velocity field. 
Please note that the scale of latter snapshot has a maximum magnitude of \SI{e-6}{\uvelocity}, not shown
for illustrative simplicity.}
% label
\label{fig:texus_flow}
\end{figureth}
%--------------
Three solid phases are considered for the \emph{b1Bin} alloy: a primary BCC phase, a peritectic FCC phase and a cementite phase. 
The latter can be obtained by cooling the sample at low temperatures to achieve solid-state transformation.
The next point to discuss is segregation and fluid flow. With the chosen gravity acceleration, the liquid metal moves in the downward direction when the
ceramic substrate comes from above the droplet. As soon as solidification takes place right after the metal-substrate contact, a BCC-rich mushy zone 
forms near the contact surface. The abrupt phase change imposes a fast shrinkage rate, which tend to straighten the interface near the substrate, as we can observe in \cref{fig:bin_vs_exp}. 
A part of the flow thus deviates towards the solid front 
to compensate for the density increase, as shown in \cref{fig:texus_flow}. 
This flow pattern in the sample shows distinct regions show at 0.25 s and 1 s in the previous figure: 
upward flow driven by solidification shrinkage contributes to a slight enrichment by inverse segregation,
while a downward flow driven by gravity redistributes species in the containerless melt. Upon completely 
solidifying, the droplet forms a rigid and fixed solid, surrounded by natural argon flow. 

The fluid flow is behind the reduced-gravity segregation shown at different stages in \cref{fig:texus_mesosegregation}.
As earlier mentioned, a restricted region of positive segregation settles at the contact area with the substrate,
from the first second after the contact. Later, between 2 s and 8 s, the solid front advances in the melt, creating 
a noticeable negatively segregated area, about 4\% less than the nominal composition, just below the positive segregation zone.
Normally, we would expect that the composition decreases gradually once the solid front advances in time, as confirm the 1D segregation
profiles in \cref{fig:1dalsi7_wVSlength}. To interpret this unusual observation, we refer to the fluid flow shown earlier in \cref{fig:texus_flow}.
At 0.25 s, a velocity zero-level isovolume (i.e. depicting a volume with null velocity magnitude) forms between the two distinct regions
of upward and downward flow. The strong negative divergence that settles in this area results in solute depletion in the two directions
and due to the various driving forces. 

However, at 1 s, the zero isovolume clearly shrinks in a matter of only 0.75 s. That is
because the initial temperature gradient is the highest during the process, then it decreases gradually. 
Since a higher temperature gradient produces a greater cooling flux according to the Fourier model, solidification is faster
in the beginning and the volume shrinkage is fast, hence the shrinkage flow coexists with the gravity flow. As the transformation
progresses, shrinkage flow becomes insignificant compared to the latter, therefore the negative segregation intensity decreases gradually from 2.2 mm
to 4.3 mm from the chill, corresponding to the first seconds of contact (t<8 s).
This result is also shown in \cref{fig:texus_segreg_profile} where we plot the relative segregation profile along the vertical rotation axis of the droplet.
At 8 s, \cref{fig:texus_flow} shows the zero-velocity isovolume moved down the vertical revolution axis by following
the solidification front, then vanishing at about 10 s. It means that from this point in time, the flow is so dissipated by the mushy zone's low permeability,
hence the low-magnitude shrinkage flow dominates again.
We may correlate this flow pattern once again to the segregation profile in \cref{fig:texus_segreg_profile}:
As of 4.3 mm and down to the tip of the deformed sample, we observe a steady rise in solute content caused 
by the shrinkage-dominated flow between dendrites compensating for density differences. 
% This rise in solute content is however not strictly correct, says the species mass conservation study, shown in FIG.

In \cref{fig:texus_segreg_profile}, the final phase distribution along the vertical revolution axis is plotted.
The plots show that in the upper part of the droplet close to the chill, a eutectoid product (we may not speak of eutectoid microstructure as the current approach is only macroscopic, without
information on the smaller scale) that results from the hypoeutectoid composition, consisting of 98\% of $\alpha$-BCC phase together and 2\% of CEM between 0 and 2.9 mm away from the substrate.
Beyond this point, the austenitic $\gamma$-FCC phase is gradually replaced by $\alpha$-BCC, which represents the proeutectoid $\alpha$ phase, taking place before temperature
reaches the eutectoid isotherm at \SI{727}{\udegC}.

%===================================== ANIMATION FIGURE =====================================
\begin{figure}[htbp]
\centering
%
\ifthenelse{\boolean{enable_animations}}%
  {% then
    %\animategraphics[options]{fps}{filename_without_number}{1}{N}
    %-------
    \animategraphics{10}{Chapter5/Graphics/3d/bin/mesosegregation/img}{0000}{0080}
    \includegraphics[width=0.2\textwidth]{Chapter5/Graphics/3d/bin/colorscale_composition_annot.png}
    \caption{Animation of the average composition with solidification time, showing evidence of segregation and shape deformation between 0 s and 20 s.}
    %-------
  }
  {% else 
    %-------
    \includegraphics[width=1.0\textwidth]{Chapter5/Graphics/3d/bin/mesosegregation.pdf}
    \caption{Evolution of the average composition with solidification time, showing evidence of segregation and shape deformation between 0 s and 20 s.
     (check animation in the PDF file).} 
    %-------
  }
\label{fig:texus_mesosegregation}
\end{figure}
%===================================== ANIMATION FIGURE =====================================



A better global visualisation of the transformation is given in \cref{fig:texus_phase_distrib}, at different time stages.
Each column depicts a definite time with temperature and phase distribution. 

%--------------
\begin{figureth}
% textwidth 
{0.9}
%path 
{Chapter5/Graphics/3d/bin/phase_distrib.pdf}
% caption
{Solidification progress at 5, 10, 15 and 20 s showing the effect of segregation on the transformation paths, from liquid to solid and solid-state.}
% label
\label{fig:texus_phase_distrib}
\end{figureth}
%--------------


%--------------------------------------
\shorthandoff{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy
\begin{figure}[htbp]
\centering
%-------
\begin{tikzpicture}%[spy using outlines={rectangle, magnification=3, width=1cm, height=6cm, connect spies}]
%[spy using outlines={circle, magnification=3, connect spies}]
%-------------------
 \begin{axis}
  [	name=whatever,
	%title= (c),
	scale only axis,
	table/col sep=comma,  % comma % tab
	enlarge x limits=false,
	%legend pos=north east,
	scaled ticks=true,
	ylabel style={align=center},
	ylabel=  \blue{Relative carbon content}  $\frac{\mix{\avg{w}}-w_0}{w_0}$ (\%), %Relative mesosegregation,
	xlabel=Distance from chill (mm),
	%xticklabel style={/pgf/number format/fixed},
	yticklabel style={/pgf/number format/fixed},
	xtick={0,1,...,8},
	xticklabels={0,1,...,8},
	ytick={-5,-2.5,...,5},
	yticklabels={-5,-2.5,...,5},
	%x tick label style={rotate=45,anchor=east},
	width=0.85\textwidth,
	height=8cm,	
	ymin=-5, ymax=5,
	xmin=0, xmax=8,
	mark repeat	= {50},
	%cycle list name=mycycle, %exotic,
	axis y line*=left,
]
  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration}-0.105)/0.105, color=red, mark=*]   {Chapter5/Data/3d_segregation/BinTransformationPath.csv};
	\draw[thick, dashed, black, opacity=0.5] (axis cs:\pgfkeysvalueof{/pgfplots/xmin},0.0) -- (axis cs:\pgfkeysvalueof{/pgfplots/xmax},0.0);
	\legend{$\avg{w}$}  	
  	\end{axis}
  	%-------------------
  	%-------------------
  	\begin{axis}
  [	name=whatever,
	%title= (c),
	scale only axis,
	table/col sep=comma,  % comma % tab
	scaled ticks=true,
	ylabel= Phase fraction (-),
	yticklabel style={/pgf/number format/fixed},
	%ytick={0,0.2,...,1},
	%yticklabels={0,0.2,...,1},
	width=0.85\textwidth,
	height=8cm,	
	ymin=0, ymax=1.05,
	xmin=0, xmax=8,
	mark repeat	= {50},
	cycle list name=mycycle,
	axis y line*=right,
	axis x line=none,
]
	\addplot table [x expr=\thisrow{arc_length}*1000, y=FractionBCC_c] {Chapter5/Data/3d_segregation/BinTransformationPath.csv};
	\addplot table [x expr=\thisrow{arc_length}*1000, y=FractionFCC_c] {Chapter5/Data/3d_segregation/BinTransformationPath.csv};
	\addplot table [x expr=\thisrow{arc_length}*1000, y=FractionCEM_c] {Chapter5/Data/3d_segregation/BinTransformationPath.csv};
	%\draw[thick, dashed, black, opacity=0.5] (axis cs:\pgfkeysvalueof{/pgfplots/xmin},0.0) -- (axis cs:\pgfkeysvalueof{/pgfplots/xmax},0.0);
	\legend{FCC,BCC,CEM}
  	\end{axis}
\end{tikzpicture}
%-------
\caption{Relative segregation profile in percent with respect to the nominal composition, 
along the vertical revolution axis of the solidified sample at a temperature lower than \SI{1100}{\udegC}.
Phase fractions are superimposed on the same graph and their values are read on the right y-axis.}
\label{fig:texus_segreg_profile}
\end{figure}
%--------------------------------------
\shorthandon{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy



% ------------------------------------------------------
\subsection{TEXUS ternary and quaternary alloys}
% ------------------------------------------------------

In this section, the aim is to predict macrosegregation in reduced-gravity solidification of the \emph{b1} alloy, the latter being considered 
as a ternary and then as a quaternary alloy (cf. \cref{table:texus_b1}). 
%For simplicity, we refer to these alloys respectively by \emph{b1T} and \emph{b1Q}.
We want to show that, on the one hand our model handles multicomponent alloys (based on equilibrium conditions), while
on the other hand, how transformation paths vary by adding additional components, thus changing the shrinkage kinetics, hence the final sample shape.
%By introducing additional chemical species, silicon for \emph{b1Tern}, silicon and magnesium for \emph{b1Quat}, a new carbide phase may appear, the M$_7$C$_3$.
The first visible sign of different paths during solidification is given in \cref{fig:multicomp_liquid}. We can see that upon adding
additional chemical species while applying the same cooling conditions, a different liquid fraction remains after 15 s, showing evidence 
of slower solidification as we go from binary to quaternary. Also, with multicomponent alloys like \emph{b1Tern} and \emph{b1Quat}, an additional solid
phase may appear, that is the M$_7$C$_3$ carbide.
%After 15 seconds of chill contact, the \emph{b1Tern} and \emph{b1Quat} alloys have more volume fraction of liquid than \emph{b1Bin} computation as shown in 
%\cref{fig:multicomp_liquid}, meaning that solidification in these samples is slower. 
%The reason can be attributed to new solidification paths created by the more complex system composition compared  to the binary sample. 
% Slower solidification means that the final predicted shape is different, as shown earlier in the parametric study.
Slower cooling rates result in more elongated droplet shapes due to weight force, whereas shrinkage forces tend to counter this effect.
Therefore the final predicted shape is different, as shown earlier in the parametric study.

%--------------
\begin{figureth}
% textwidth 
{1.1}
%path 
{Chapter5/Graphics/3d/tern_quatern/gl15s.pdf}
% caption
{Snapshots showing the remaining volume fraction of liquid at 15 s in each sample of the binary, ternary and quaternary \emph{b1} alloy.
The dashed lines delimit the upper and lower limits of the droplets in the vertical direction.}
% label
\label{fig:multicomp_liquid}
\end{figureth}
%--------------

In \cref{fig:shape_comparison}, we focus on the final droplet profile caused by varying the number of solute elements.
We clearly notice that the multicomponent solidification results in a slightly more elongated shape. 
All cases were obtained using the optimal simulation
parameters determined previously by the parametric study, i.e. thermal exchange coefficient, $\hext$, of \SI{6e4}{\uhconvec} and a gravitational
acceleration, $\norm{\gravity}$, of \SI{5e-5}{\uacceleration}. The clear difference in solidification paths requires to do the same 
parametric study to get better simulation-vs-experiment prediction. However, as we have shown earlier the effect of varying these parameters
on the final profile, we do not perform parametric studies for \emph{b1Tern} and \emph{b1Quat} alloys. 

The vertical elongation obtained by the \emph{b1Tern} sample is slightly different than the \emph{b1Bin} result, as shown in \cref{fig:shape_comparison}. 
Moreover, the final ternary and quaternary
profiles are almost overlapping, indicating that the prediction accuracy is very close for these alloys. 
This reveals the importance of simulating solidification processes with real alloy compositions instead of binary simplifications
where the transformation path is not complex as a result of the smaller number of phases forming at equilibrium. 

%--------------
\begin{figureth}
% textwidth 
{1.0}
%path 
{Chapter5/Graphics/3d/tern_quatern/profiles_comparison.pdf}
% caption
{Comparison of final droplet profiles obtained by solidifying \emph{b1Bin}, \emph{b1Tern} and \emph{b1Quat} samples, with respect to the initial profile. 
The \emph{b1BinCoarse} sample
is obtained using coarser composition steps.}
% label
\label{fig:shape_comparison}
\end{figureth}
%--------------

Nevertheless, it should be mentioned that the mapping resolution plays an important role in the accuracy of thermodynamic conversions.
Therefore, tabulations size easily increases with the increasing number of solute elements, because of the greater number of temperature-composition 
combinations to scan while computing equilibrium. To test the effect of changing the mapping resolution, we repeated the binary sample solidification
but with a composition step of \SI{0.0495}{\ucomposition} instead of \SI{0.00525}{\ucomposition} used for the \emph{b1Bin} sample, i.e. about 10 times coarser. 
The corresponding profile in \cref{fig:shape_comparison}, \emph{b1BinCoarse}, shows less vertical elongation then predicted by the finer \emph{b1Bin} tabulation. 
This is clearly due to inaccurate calculation of the solidification path, revealing the importance of mappings accuracy in predicting transformation-related physics.

In order to test the effect of the tabulation file size on computation time, we simulate again the quaternary solidification case but this time with a lightweight
tabulation where all successive line with similar phase fractions outside the solidification range are deleted, giving what we call \emph{b1QuatLite}. The 
resulting file is three time smaller than the original tabulation file. Surprisingly, the computation time for \emph{b1QuatLite} shows no significant acceleration 
compared to \emph{b1Quat}. The file size, proportional to the number of tabulated lines, is important as it causes a search overhead each time the conversion module
is called. However, \cref{table:mapping_stat} reveals that the multi-variable interpolation overhead is even more important, resulting in longer computation times.
This may be considered as a limitation of the thermodynamic mapping approach.

%--------------------------------
\begin{table}[H]
\centering
\caption{Information table showing the tabulations size  for each alloy obtained by the same mapping resolution for temperature and composition, 
depending on the number of solute elements and phases. The temperature step is \SI{1}{\udegC} and the range is the range is [20-1620]\si{\udegC} for all four cases . 
The computation time corresponds to the CPU time of a simulation running on 20 cores.}
\label{table:mapping_stat}
\resizebox{\columnwidth}{!}{%
{\tabulinesep=1.0mm \begin{tabu}{lccccccc}
\tabucline[1pt]{-}
\textbf{Alloy} & \textbf{Nb} &  \textbf{Composition}  & \textbf{Composition}  & \textbf{Nb}  
& \textbf{Tabulation}  & \textbf{Size} & \textbf{Computation}  \\
         & \textbf{solutes} &  \textbf{range (\si{\ucomposition})}  & \textbf{step (\si{\ucomposition})}  & \textbf{phases}  
& \textbf{lines}  & \textbf{(MB)} & \textbf{time (s)}  \\\tabucline[1pt]{-}
%-----------------------------
      \emph{b1Bin}    & 1 & C: [0.0945-0.1155] &   0.00525  &  4 &  \num{185010} &    \num{4.37}   &  \num{59461.5}  \\   %78003.9
      %\emph{b1BinCoarse}    & 1 & C: [0.0945-0.1155] &   0.0495  &  4 &  \num{-} &    \num{-}   &  \num{-}  \\  
      \emph{b1Tern}   & 2 & C: [0.0945-0.1155] &   0.00525  &  5 &  \num{220250} &    \num{10.18}  &  \num{62644.4}  \\    
                &   &  Si: [0.2412-0.2948] &   0.0134   &    &               &                 &                 \\    
      \emph{b1Quat}   & 3 & C: [0.0945-0.1155] &   0.00525  &  5 &  \num{1101250}&    \num{66.89}  &  \num{85476.7}  \\     
                &   &  Mn: [0.5724-0.6996] &   0.0318   &    &               &                 &                 \\    
                &   &  Si: [0.2412-0.2948] &   0.0134   &    &               &                 &                 \\    
      \emph{b1QuatLite} & 3 &   C: [0.0945-0.1155] &   0.00525  &  5 &  \num{326014} &    \num{20.93}  &  \num{84104.8}  \\
                &   &  Mn: [0.5724-0.6996] &   0.0318   &    &               &                 &                 \\    
                &   &  Si: [0.2412-0.2948] &   0.0134   &    &               &                 &                 \\\tabucline[1pt]{-}
      % http://grammarist.com/words/lite/
%-----------------------------
\end{tabu}}
}
\end{table}
%--------------------------------

%is another cause of the shape discrepancy, and the thermodynamic mapping
% of the binary alloy has the advantage: less solute elements means less 
% It becomes then clear that a multicomponent mapping has a greater number of combinations to scan in order to get the corresponding transformation paths, compared
% to a binary mapping. For that reason, the multicomponent mapping is often coarser than the binary one to limit the search and interpolations overhead, 
% leading to smaller tabulation files but less accurate path prediction. This is may be considered as a limitation of the thermodynamic mapping approach.
Finally we are interested in comparing the macrosegregation levels obtained in all three solidification cases. Segregation maps
are presented in \cref{fig:final_segreg_ternquat} on a symmetry plane section. First, we compare the carbon segregation as it is the common species among the presented alloys.
The first difference is a remarkable positive macrosegregation of 3.5\% at the chill contact of the  \emph{b1Tern} and \emph{b1Quat} samples, 
while being less prominent for \emph{b1Bin} 
% which shows a relative segregation of 1.2\%. 

As we explained earlier, this positive macrosegregation taking place at the beginning
of solidification is related to the shrinkage flow (cf. \cref{fig:texus_flow}) created by the strong thermal gradient in the contact zone. 
As the thermal gradient in this zone is almost the same
for all three cases at solidification onset, the higher velocity which is responsible for the noticeable positive macrosegregation in both multicomponent samples,
is related to the solidification path varying with the number of species.
Two regions of negative macrosegregation are observed across the samples, with various amplitudes. The first region lies just below the chill contact.
It corresponds to the solute depletion caused by an upward shrinkage flow and a downward gravity flow. 
With the advancement of the solidification front,
the gravity flow dominates forcing the remaining liquid to fall down while dragging the species from the sides of the droplet to the centre.
This creates a radial negative segregation pattern, as seen in \cref{fig:final_segreg_ternquat}. 

The last result regarding the multicomponent solidification application in reduced-gravity conditions 
is a composition plot in \cref{fig:3d_segregation_multicomponent} for each species in the solidified samples. 
This is basically similar to the analysis we made for \cref{fig:final_segreg_ternquat}, 
but this plot show the composition profile along the revolution axis.


%--------------
\begin{figureth}
% textwidth 
{0.85}
%path 
{Chapter5/Graphics/3d/tern_quatern/final_segreg.pdf}
% caption
{Segregation maps relative to each alloy, showing positive and negative mesosegregation
of each chemical species for \emph{b1Bin}, \emph{b1Tern} and \emph{b1Quat} samples.}
% label
\label{fig:final_segreg_ternquat}
\end{figureth}
%--------------

%--------------------------------------
\shorthandoff{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy
\begin{figure}[htbp]
\centering
%-------
\begin{tikzpicture}%[spy using outlines={rectangle, magnification=3, width=1cm, height=6cm, connect spies}]
%[spy using outlines={circle, magnification=3, connect spies}]
  \begin{axis}
  [ name=one,
  title= (a) carbon segregation,
  %at=(one.right of south east), anchor=left of south west,
  scale only axis,
  table/col sep=comma,  % comma % tab
  enlarge x limits=false,
  %legend pos=north east,
  scaled ticks=true,
  %xlabel=Sample length (m),
  ylabel=$\frac{\mix{\avg{w_{C}}}-w_{C_0}}{w_{C_0}}$ (\%),
  % xticklabel style={/pgf/number format/fixed},
  xtick={0,1,...,8}, 
  xticklabels={},
  ytick={-5,-2.5,...,5},
  %x tick label style={rotate=45,anchor=east},
  width=0.9\textwidth,
  height=5cm, 
  ymin=-5, ymax=5,
  %xmax=0.0928,
  mark repeat = {100},
  cycle list name=mycycle, %exotic,
  ]

  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration}-0.105)/0.105]   {Chapter5/Data/3d_segregation/centersegreg_bin.csv};
  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration_C}-0.105)/0.105] {Chapter5/Data/3d_segregation/centersegreg_tern.csv};
  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration_C}-0.105)/0.105] {Chapter5/Data/3d_segregation/centersegreg_quat.csv};
  \legend{\emph{b1Bin}, \emph{b1Tern}, \emph{b1Quat}}
  \end{axis}
%-------------------
 \begin{axis}
  [ name=two,
  title= (b) silicon segregation,
  at=(one.below south west), anchor=above north west,
  scale only axis,
  table/col sep=comma,  % comma % tab
  enlarge x limits=false,
  %legend pos=north east,
  scaled ticks=true,
  %xlabel=Sample length (m),
  ylabel=$\frac{\mix{\avg{w_{Si}}}-w_{{Si}_0}}{w_{{Si}_0}}$ (\%),
  xticklabel style={/pgf/number format/fixed},
  xtick={0,1,...,8}, 
  xticklabels={},
  ytick={-1,-0.5,...,1},
  %x tick label style={rotate=45,anchor=east},
  width=0.9\textwidth,
  height=5cm, 
  ymin=-1, ymax=1,
  %xmax=0.0928,
  mark repeat = {100},
  cycle list name=mycycle,
  ]
  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration_Si}-0.268)/0.268] {Chapter5/Data/3d_segregation/centersegreg_tern.csv};
  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration_Si}-0.268)/0.268] {Chapter5/Data/3d_segregation/centersegreg_quat.csv};
  \legend{\emph{b1Tern}, \emph{b1Quat}}
  \end{axis}
%-------------------
 \begin{axis}
  [ name=three,
  title= (c) manganese segregation,
  at=(two.below south west), anchor=above north west,
  scale only axis,
  table/col sep=comma,  % comma % tab
  enlarge x limits=false,
  %legend pos=north east,
  scaled ticks=true,
  xlabel=Distance from chill (mm),
  ylabel=$\frac{\mix{\avg{w_{Mn}}}-w_{{Mn}_0}}{w_{{Mn}_0}}$ (\%),
  xtick={0,1,...,8}, 
  xticklabels={0,1,...,8}, % showing in (mm)
  ytick={-1,-0.5,...,1},
  % xticklabel style={/pgf/number format/fixed},
  width=0.9\textwidth,
  height=5cm, 
  ymin=-1, ymax=1,
  mark repeat = {100},
  cycle list name=mycycle, %exotic,
  ]
  \addplot table [x expr=1000*\thisrow{arc_length}, y expr=100*(\thisrow{Concentration_Mn}-0.636)/0.636] {Chapter5/Data/3d_segregation/centersegreg_quat.csv};
  \legend{\emph{b1Quat}} 
  \end{axis}

\end{tikzpicture}
%-------
\caption{Relative macrosegregation profiles as functions of the distance from the chill, plotted for (a) carbon (b) silicon and (c) manganese elements
along the vertical revolution axis of the solidified sample.}
\label{fig:3d_segregation_multicomponent}
\end{figure}
%--------------------------------------
\shorthandon{;:?!} %http://tex.stackexchange.com/questions/74860/unexpected-clash-between-babel-and-pgf-spy

% \comment{update binary profile comparison as well as the corresponding image}
% \comment{update parametric study H3G0 and H4G0 given by new tabulation}
% \comment{introduce and comment the tabulation resolution and its effect on shape}
%\comment{update the binary 1d segregation anaysis at the end in the bin tern quat comparison}
%\comment{update computation time for ternary done with 20 cores}
%\comment{update solidification progress figures for phase fractions with the binary solidification obtained with the finer tabulation}
 
%--
\input{Chapter5/recap5} % resume francais


