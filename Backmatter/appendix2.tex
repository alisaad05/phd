\chapter{Resolution algorithm with LSM}



\newcommand{\vI}{\textbf{v}_{\text{I}}  }
\newcommand{\vII}{\textbf{v}_{\text{II}}  }
\newcommand{\capt}{\;\mathrm{capt}}
\newcommand{\deriv}[1]{\frac{\partial #1 }{\partial t}}
\newcommand{\diff}[2]{ \ensuremath{\nabvec \cdot\left( #1 \nabvec #2 \right)  }}
% This command is useful to have quick control over the format of all header titles
\newcommand{\name}[1]{\textbf{#1}}


\begin{figure}
\newlength{\largeur}
\newlength{\llargeur}
\newlength{\rlargeur}

\setlength{\largeur}{4.5cm}
\setlength{\llargeur}{10.8cm}
\centering
\begin{tikzpicture}[node distance=0.4cm]

\tikzstyle{rect}=[rectangle,draw,text=black, fill=red!10, drop shadow, rounded corners]
\tikzstyle{test}=[diamond,aspect=3,draw,text=black]
\tikzstyle{fleche}=[->,>=stealth]
\tikzstyle{trait}=[]

\setlength{\rlargeur}{\largeur}
\addtolength{\rlargeur}{-1.\tabcolsep}
\addtolength{\rlargeur}{-1.\llargeur}

\node[rect] (comment) at (0,7)
{
	$\avg{H}^t$, $T^t$, $g^{\phi}_j$, $(dH/dT)^t_j$ 		
};

\node[rect,below=of comment] (mecaflu)
{
	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
	\name{Mechanics Step II : Fluid-oriented Resolution}
	\begin{equation*}
	  \begin{array}{l l}
	    %{\rho}^{l}_{\text{ref}} 
		%\brac{\frac{\partial \brac{g^{l} \vII }}{\partial t} + 
		% \nabvec \cdot\brac{g^{l} \vII  \times \vII  }} = \nabvec\cdot \brac{g^{l}\mathbb{S}^{l}} 
		%-  g^{l} \nabvec p^{l} + g^{l} {\rho}^{l} \vec{\mathbb{G}} - {g^{l}}^{2} \mu^{l} \mathbb{K}^{-1} \brac{ \vII  - \vI  } } \\ 
	    \nabvec \cdot \vII = 0
	  \end{array} 	
	\end{equation*}
	\end{tabular}
};


\node[rect,below=of mecaflu] (energy)
{
	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
	\name{Conservation of energy (Nonlinear Heat Transfer)} 
	\begin{equation*}
		\frac{\partial \avg{\rho h} }{\partial t} + 
		\avg{\vII} \cdot \nabvec \avg{\rho h}^{l}= 
		\diff{\avg{\kappa}}{T}
	\end{equation*}
	\end{tabular}
};


\node[rect,below=of energy] (macroseg)
{
	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
	\name{Conservation of chemical species (Macrosegregation)} 
	\begin{equation*}
		\frac{\partial \langle w_i \rangle}{\partial t} + 	
		\avg{\vII}  \cdot   \nabvec \langle w_i \rangle^{l} = 
		\nabvec\cdot  ( \langle D^{l} \rangle \nabvec \langle w_i \rangle^{l} )
	\end{equation*}
	\end{tabular}
};

\node[rect,below=of macroseg] (microseg)
{
	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
	\name{Microsegregation} 
	\begin{equation*}	   
	  \begin{array}{l l}
	    \brac{g^{\phi} , \avg{w_i^{\phi}}^{\phi} } = f\brac{\avg{w_i} , T }  \\ 
	    \frac{\partial \avg{\rho h} }{\partial T} = 
		 \frac{\partial}{\partial T} \brac{\sum_{\phi} g^{\phi}  \avg{\rho h}^{\phi} }
	  \end{array} 	
	\end{equation*}
	\end{tabular}
};

	
%\node[rect,below=of mecasol] (fe_calc)
%{
%	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
%		FE calculation & $\prescript{(k+1)}{}{\avg{H}}$ \\
%	\end{tabular}
%};
%
%\node[rect,below=of fe_calc] (init_micro)
%{
%	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
%		Micro time initialization & $t_m = t$ \\
%		Nodes initialization & $\avg{H}^{t_m} = \avg{H}^{t}$, $T^{t_m} = T^{t}$, $g^{s^{(j)}_i t_m} = g^{s^{(j)}_i t}$ \\
%		Cells initialization & $I^{(i) t_m}_\nu = I^{(i) t}_\nu$, $r^{(i) t_m}_\nu = r^{(i) t}_\nu$ \\
%	\end{tabular}
%};
%	
%\node[rect,below=of init_micro] (microt)
%{
%	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
%		Micro time step calc. & $\delta t = l_{CA} / v^{s_i}_{\nu \max}$ \\
%	\end{tabular}
%};
%	
%\node[rect,below=of microt] (init_cell)
%{
%	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
%		Cells initialization & $I^{(i)}_\nu = I^{(i) t_m}_\nu$, $r^{(i)}_\nu = r^{(i) t_m}_\nu$, $T^{t_m}_\nu = \sum_n \phi (x_\nu) T^{t_m}$ \\
%	\end{tabular}
%};
%
%\setlength{\rlargeur}{\largeur}
%\addtolength{\rlargeur}{-4.\tabcolsep}
%\addtolength{\rlargeur}{-6.5cm}
%
%\node[rect,below=of init_cell] (cells)
%{
%	\begin{tabular}{@{}p{2.cm}p{4.5cm}p{\rlargeur}@{}}
%		\textbf{Procedure} & \textbf{Tests} & \textbf{Modified variables at cells} \\
%		\textbf{Nucleation} & $I^{(i)}_\nu = 0$, $T_\nu < T^{s_i}_{nucl}$ & $I^{(i)}_\nu$, $r^{(i)}_\nu$, $V^{(i)}_{\nu \capt}$, $V^{(i)}_{\nu \max}$ \\
%		\textbf{Growth} & $I^{(i)}_\nu \not = 0$, $g^{(i)}_\nu < 1$, $T_\nu < T^{s_i}_{eq}$ & $r^{(i)}_\nu$ \\
%		\textbf{Capture} & $I^{(i)}_\nu = 0$, $T_\nu < T^{s_i}_{eq}$ & $I^{(i)}_\nu$, $r^{(i)}_\nu$, $V^{(i)}_{\nu \capt}$, $V^{(i)}_{\nu \max}$ \\
%	\end{tabular}
%};
%
%\setlength{\rlargeur}{\largeur}
%\addtolength{\rlargeur}{-2.\tabcolsep}
%\addtolength{\rlargeur}{-1.\llargeur}
%
%\node[rect,below=of cells] (fe)
%{
%	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
%		& \textbf{Modified variables at nodes} \\
%		\textbf{Retrocession} & $g^{(i) t_m+\delta t} = \sum_\nu \phi(x_\nu)g^{(i) t_m+\delta t}_\nu / \sum_\nu \phi(x_\nu)$ \\
%	%	\textbf{Enthalpy conversion} & $\avg{H}^{t_m + \delta t} = \avg{H}^{t} + (\prescript{(k+1)}{}{\avg{H}} - \avg{H}^{t}) \frac{t_m+ \delta t - t}{\Delta t}$\\
%		\textbf{Enthalpy conversion} & $\avg{H}^{t_m + \delta t} = \avg{H}^{t} + (\prescript{(k+1)}{}{\avg{H}} - \avg{H}^{t}) (t_m+ \delta t - t)/\Delta t$\\
%		& $T^{t_m + \delta t}$, $g^{s^{(j)}_i t_m + \delta t}$\\
%	\end{tabular}
%};
%	
%\node[test,below=of fe] (t_microtime)
%{
%	$t_m+\delta t < t+\Delta t$
%};
%
%\node[anchor=south east] (yes1) at (t_microtime.west) {Y};
%\node[anchor=north east] (change_micro) at (t_microtime.west)
%{
%	$t_m \leftarrow t_m + \delta t$
%};
%
%\node[rect,below=of t_microtime] (newton_fin)
%{
%	\begin{tabular}{@{}p{\llargeur}p{\rlargeur}@{}}
%		Update of variables & $\prescript{(k+1)}{}{T} = T^{t_m + \delta t}$, $\prescript{(k+1)}{}{g}^{s^{(j)}_i} = g^{s^{(j)}_i t_m + \delta t}$\\
%		& $\prescript{(k+1)}{}{(dT/d\avg{H})} = ( \prescript{(k+1)}{}{T}-\prescript{(k)}{}{T} ) / ( \prescript{(k+1)}{}{\avg{H}} - \prescript{(k)}{}{\avg{H}} )$\\
%		Residual calculation & $\prescript{(k+1)}{}{R_E} = R_{E}(\prescript{(k+1)}{}{\avg{H}},\prescript{(k+1)}{}{T},\prescript{(k+1)}{}{g}^{s^{(j)}_i})$\\
%	\end{tabular}
%};
%
%\node[test,below=of newton_fin] (t_convergence)
%{
%	$\prescript{(k+1)}{}{R_E} / \prescript{(0)}{}{R_E} < \varepsilon$
%};
%
%\node[anchor=south east] (no2) at (t_convergence.west) {N};
%\node[anchor=north east] (yes2) at (t_convergence.south) {Y};
%\node[anchor=north east] (new_iter) at (t_convergence.west)
%{
%	$(k) \leftarrow (k+1)$
%};
%\node[anchor=north west] (change_iter) at (t_convergence.south)
%{
%	$t + \Delta t \leftarrow (k+1)$
%};
%
%\node[test,below=of yes2.south east] (t_time)
%{
%	$t+\Delta t < t_{end}$
%};
%
%\node[rect,right=of t_time] (end)
%{
%	End
%};
%
%\node[anchor=south east] (yes3) at (t_time.west) {Y};
%\node[anchor=north east] (change_macro) at (t_time.west)
%{
%	$t \leftarrow t + \Delta t$
%};
%
%\draw[trait] (init) -- (init_iter);
%\draw[trait] (init_iter) -- (fe_calc);
%\draw[trait] (fe_calc) -- (init_micro);
%\draw[trait] (init_micro) -- (microt);
%\draw[trait] (microt) -- (init_cell);
%\draw[trait] (init_cell) -- (cells);
%\draw[trait] (cells) -- (fe);
%\draw[trait] (fe) -- (t_microtime);
%\draw[trait] (t_microtime) -- (newton_fin);
%\draw[trait] (newton_fin) -- (t_convergence);
%\draw[trait] (t_convergence) -- (t_time);
%\draw[trait] (t_time) -- (end);
%
%\coordinate[shift={(-2mm,0mm)}] (microt_i) at (microt.west);
%\draw[fleche] (t_microtime) -| (microt_i) -- (microt);
%
%\coordinate[shift={(-4mm,0mm)}] (fe_calc_i) at (fe_calc.west);
%\draw[fleche] (t_convergence) -| (fe_calc_i) -- (fe_calc);
%
%\coordinate[shift={(-6mm,0mm)}] (init_i) at (init.west);
%\draw[fleche] (t_time) -| (init_i) -- (init);

\end{tikzpicture}

%\caption{Coupling algorithm for structures i, without iterations. Solidification path is computed at nodes.}

\end{figure}